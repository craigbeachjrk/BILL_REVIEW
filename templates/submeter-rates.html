<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Submeter Rates | Bill Review</title>
  <style>
    :root {
      --bg:#0ea5e9; --bg2:#4338ca;
      --glass:rgba(255,255,255,.72); --border:rgba(255,255,255,.33);
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family:'Segoe UI',system-ui,-apple-system,sans-serif;
      background:linear-gradient(135deg,var(--bg),var(--bg2));
      min-height:100vh; color:#1e293b;
    }
    .header {
      display:flex; align-items:center; justify-content:space-between;
      padding:18px 32px; color:#fff;
    }
    .header h1 { font-size:1.5rem; font-weight:700; }
    .header a { color:#fff; text-decoration:none; opacity:.85; font-size:.9rem; }
    .header a:hover { opacity:1; }
    .card {
      background:var(--glass); backdrop-filter:blur(10px);
      border:1px solid var(--border); border-radius:16px;
      box-shadow:0 10px 30px rgba(0,0,0,.12);
      margin:0 24px 24px; padding:24px;
    }
    .controls {
      display:flex; align-items:center; gap:12px; flex-wrap:wrap; margin-bottom:16px;
    }
    .controls label { font-weight:600; font-size:.9rem; }
    .controls select, .controls button {
      padding:8px 16px; border-radius:8px; font-size:.9rem; border:1px solid #cbd5e1;
    }
    .controls select { background:#fff; }
    .controls button {
      background:#2563eb; color:#fff; border:none; cursor:pointer; font-weight:600;
    }
    .controls button:hover { background:#1d4ed8; }
    .controls button.secondary { background:#64748b; }
    .controls button.secondary:hover { background:#475569; }
    .controls button.save-btn { background:#059669; }
    .controls button.save-btn:hover { background:#047857; }
    .controls button.warn-btn { background:#d97706; }
    .controls button.warn-btn:hover { background:#b45309; }
    .controls button.warn-btn.active { background:#ef4444; }
    .controls button.warn-btn.active:hover { background:#dc2626; }
    .summary-bar {
      display:flex; gap:16px; flex-wrap:wrap; margin-bottom:20px;
    }
    .summary-stat {
      background:rgba(255,255,255,.55); backdrop-filter:blur(6px);
      border:1px solid var(--border); border-radius:12px;
      padding:12px 20px; min-width:160px; text-align:center;
    }
    .summary-stat .label { font-size:.75rem; text-transform:uppercase; color:#64748b; font-weight:600; }
    .summary-stat .value { font-size:1.35rem; font-weight:700; color:#1e293b; margin-top:2px; }
    .table-wrap { overflow-x:auto; }
    table { width:100%; border-collapse:collapse; font-size:.82rem; }
    thead th {
      background:rgba(30,41,59,.07); padding:10px 10px; text-align:left;
      font-weight:700; font-size:.75rem; text-transform:uppercase; color:#475569;
      cursor:pointer; user-select:none; white-space:nowrap;
    }
    thead th:hover { background:rgba(30,41,59,.12); }
    thead th .sort-arrow { margin-left:4px; font-size:.7rem; }
    tbody td { padding:8px 10px; border-bottom:1px solid rgba(0,0,0,.06); }
    tbody tr:hover { background:rgba(37,99,235,.06); }
    tbody tr.highlight { background:rgba(250,204,21,.18); }
    tbody tr.highlight:hover { background:rgba(250,204,21,.28); }
    .rate-cell, .mono { font-family:'Cascadia Code','Fira Code',monospace; font-size:.8rem; }
    .volume-cell, .total-cell, .raw-cell { text-align:right; }
    .na-badge {
      display:inline-block; padding:2px 8px; border-radius:6px;
      background:#fef3c7; color:#92400e; font-weight:600; font-size:.78rem;
    }
    .cfg-select {
      padding:3px 6px; border-radius:6px; border:1px solid #cbd5e1;
      font-size:.8rem; background:#fff; width:100%;
    }
    .uom-badge {
      display:inline-block; padding:2px 6px; border-radius:4px;
      background:rgba(30,41,59,.08); color:#475569; font-size:.75rem;
      font-family:'Cascadia Code','Fira Code',monospace;
    }
    .conversion-hint {
      font-size:.7rem; color:#94a3b8; display:block; margin-top:1px;
    }
    .spinner {
      display:inline-block; width:18px; height:18px;
      border:2.5px solid #e2e8f0; border-top-color:#2563eb;
      border-radius:50%; animation:spin .6s linear infinite; margin-right:6px;
      vertical-align:middle;
    }
    @keyframes spin { to { transform:rotate(360deg); } }
    .status-msg { font-size:.85rem; color:#475569; margin-left:8px; }
    .empty-msg { text-align:center; padding:40px; color:#64748b; font-size:1rem; }
    .hint { font-size:.75rem; color:#64748b; margin-top:4px; margin-bottom:12px; }
    @media (max-width:768px) {
      .card { margin:0 8px 16px; padding:16px; }
      .summary-bar { flex-direction:column; }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>Submeter Rates Report</h1>
    <a href="/">&larr; Back to Dashboard</a>
  </div>

  <div class="card">
    <div class="controls">
      <label for="period-select">UBI Period:</label>
      <select id="period-select"></select>
      <button onclick="generateReport()">Generate Report</button>
      <button class="secondary" onclick="exportCSV()">Export CSV</button>
      <button class="save-btn" onclick="saveConfig()">Save Config</button>
      <button class="warn-btn" id="issuesBtn" onclick="toggleIssuesFilter()">Show Issues</button>
      <button class="secondary" id="submeteredBtn" onclick="toggleSubmetered()" style="background:#7c3aed">Submetered Only</button>
      <span id="status-msg" class="status-msg"></span>
    </div>
    <div class="hint">
      <b>Raw Consumption</b> = value from invoice. <b>Conversion</b> = factor applied. <b>Volume</b> = raw &times; factor.
      Change <b>UOM Override</b> and volume/rate update instantly. Settings auto-save.
    </div>

    <div id="summary-bar" class="summary-bar" style="display:none;">
      <div class="summary-stat"><div class="label">Properties</div><div class="value" id="stat-properties">0</div></div>
      <div class="summary-stat"><div class="label">Water Volume (gal)</div><div class="value" id="stat-water-vol">0</div></div>
      <div class="summary-stat"><div class="label">Sewer Volume (gal)</div><div class="value" id="stat-sewer-vol">0</div></div>
      <div class="summary-stat"><div class="label">Avg Water Rate</div><div class="value" id="stat-water-rate">-</div></div>
      <div class="summary-stat"><div class="label">Avg Sewer Rate</div><div class="value" id="stat-sewer-rate">-</div></div>
    </div>

    <div class="table-wrap">
      <div id="table-container">
        <div class="empty-msg">Select a period and click <b>Generate Report</b> to load submeter rates.</div>
      </div>
    </div>
  </div>

  <!-- Drill-down modal -->
  <div id="detailModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:1000;overflow-y:auto" onclick="if(event.target===this)closeDetail()">
    <div style="background:#fff;max-width:900px;margin:40px auto;border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.25);padding:28px;position:relative">
      <button onclick="closeDetail()" style="position:absolute;top:12px;right:16px;background:none;border:none;font-size:1.4rem;cursor:pointer;color:#94a3b8">&times;</button>
      <h2 id="detailTitle" style="margin-bottom:4px;font-size:1.2rem"></h2>
      <div id="detailSubtitle" style="font-size:.85rem;color:#64748b;margin-bottom:16px"></div>
      <div id="detailContent"></div>
    </div>
  </div>

<script>
const CALC_OPTIONS = ["From Invoice & Volume", "Set by NCUC", "Sewer is RUBS"];
const UOM_OPTIONS = [
  {val: "Auto",        label: "Auto (detect from invoice)", factor: null},
  {val: "Gallons",     label: "Gallons (1 gal)",            factor: 1},
  {val: "kGal",        label: "kGal (1,000 gal)",           factor: 1000},
  {val: "HCF",         label: "HCF / 100 cu ft (748 gal)",  factor: 748.05},
  {val: "CCF",         label: "CCF / 100 cu ft (748 gal)",  factor: 748.05},
  {val: "100 Gallons", label: "100 Gallons",                 factor: 100},
  {val: "Acre-Feet",   label: "Acre-Feet (325,851 gal)",    factor: 325851},
];
const UOM_FACTOR_MAP = {};
UOM_OPTIONS.forEach(o => { UOM_FACTOR_MAP[o.val] = o.factor; });

let allRows = [];
let sortCol = "property_name";
let sortAsc = true;
let showIssuesOnly = false;
let showSubmeteredOnly = false;

// Submetered properties — loaded from config, with these as defaults
let SUBMETERED_PROPERTIES = new Set([
  "Arwen Vista",
  "Cadence at Crown",
  "Charles At Bellingham",
  "Citra Luxe",
  "Concierge Rocky Hill",
  "Duo Apartments",
  "Enclave at Pamalee Square",
  "Essex Apartment Homes",
  "Halstead",
  "Inigo's Crossing",
  "Liberty Commons",
  "One Webster",
  "Residences at Tewksbury",
  "Summerbrooke",
  "Motion at Dadeland",
]);

/* ---- Period dropdown ---- */
function populatePeriods() {
  const sel = document.getElementById("period-select");
  const now = new Date();
  const periods = [];
  for (let offset = -12; offset <= 3; offset++) {
    const d = new Date(now.getFullYear(), now.getMonth() + offset, 1);
    const mm = String(d.getMonth() + 1).padStart(2, "0");
    const yyyy = d.getFullYear();
    periods.push(`${mm}/${yyyy}`);
  }
  periods.reverse();
  periods.forEach(p => {
    const opt = document.createElement("option");
    opt.value = p; opt.textContent = p;
    if (p === "03/2026") opt.selected = true;
    sel.appendChild(opt);
  });
}

/* ---- Filter toggles ---- */
function toggleIssuesFilter() {
  showIssuesOnly = !showIssuesOnly;
  const btn = document.getElementById("issuesBtn");
  btn.textContent = showIssuesOnly ? "All (Issues Off)" : "Show Issues";
  if (showIssuesOnly) btn.classList.add("active"); else btn.classList.remove("active");
  renderTable();
}

function toggleSubmetered() {
  showSubmeteredOnly = !showSubmeteredOnly;
  const btn = document.getElementById("submeteredBtn");
  btn.textContent = showSubmeteredOnly ? "All Properties" : "Submetered Only";
  if (showSubmeteredOnly) { btn.style.background = "#ef4444"; } else { btn.style.background = "#7c3aed"; }
  renderTable();
}

function isIssueRow(row) {
  return row.rate == null || row.volume_total_gals === 0 || !row.raw_uom;
}

function isSubmetered(row) {
  return SUBMETERED_PROPERTIES.has(row.property_name);
}

/* ---- Status helpers ---- */
function setStatus(msg, loading) {
  const el = document.getElementById("status-msg");
  el.innerHTML = (loading ? '<span class="spinner"></span>' : '') + msg;
}
function clearStatus() { document.getElementById("status-msg").textContent = ""; }

let pollTimer = null;
let saveTimer = null;

/* Snapshot original server-computed values so "Auto" can revert */
function snapshotOriginals(rows) {
  rows.forEach(r => {
    r._orig_volume = r.volume_total_gals;
    r._orig_conversion = r.conversion;
    r._orig_factor = r.factor_used;
  });
}

/* Debounced auto-save: fires 1.5s after the last override change */
function debouncedSaveConfig() {
  if (saveTimer) clearTimeout(saveTimer);
  saveTimer = setTimeout(autoSaveConfig, 1500);
}

async function autoSaveConfig() {
  const items = allRows.map(row => ({
    property_name: row.property_name,
    property_id: row.property_id || "",
    utility_name: row.utility_name,
    calculation_desc: row.calculation_desc || "From Invoice & Volume",
    uom_override: row.uom_override || "Auto"
  }));
  try {
    const resp = await fetch("/api/submeter-rates/config", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({items})
    });
    const data = await resp.json();
    if (data.ok) setStatus("Config auto-saved.", false);
  } catch (e) {
    console.warn("Auto-save failed:", e);
  }
}

/* ---- Generate (async: kick off then poll) ---- */
async function generateReport(bustCache) {
  const period = document.getElementById("period-select").value;
  setStatus("Starting scan...", true);
  try {
    const qs = `ubi_period=${encodeURIComponent(period)}${bustCache ? "&bust_cache=1" : ""}`;
    const resp = await fetch(`/api/submeter-rates/generate?${qs}`, {method: "POST"});
    const data = await resp.json();
    if (data.rows) {
      allRows = data.rows;
      snapshotOriginals(allRows);
      setStatus(`${data.records_matched} records from ${data.files_scanned} files`, false);
      renderSummary();
      renderTable();
      return;
    }
    startPolling();
  } catch (e) {
    setStatus("Error: " + e.message, false);
  }
}

function startPolling() {
  if (pollTimer) clearInterval(pollTimer);
  pollTimer = setInterval(pollStatus, 1500);
}

async function pollStatus() {
  try {
    const resp = await fetch("/api/submeter-rates/status");
    const data = await resp.json();
    if (data.rows) {
      clearInterval(pollTimer); pollTimer = null;
      allRows = data.rows;
      snapshotOriginals(allRows);
      setStatus(`${data.records_matched} records from ${data.files_scanned} files`, false);
      renderSummary();
      renderTable();
      return;
    }
    if (data.error) {
      clearInterval(pollTimer); pollTimer = null;
      setStatus("Error: " + data.error, false);
      return;
    }
    if (data.files_total > 0) {
      const pct = Math.round(data.files_done / data.files_total * 100);
      setStatus(`${data.progress} (${pct}% — ${data.files_done}/${data.files_total} files)`, true);
    }
  } catch (e) { /* keep polling */ }
}

/* ---- Save config then regenerate ---- */
async function saveConfig() {
  const items = allRows.map(row => ({
    property_name: row.property_name,
    property_id: row.property_id || "",
    utility_name: row.utility_name,
    calculation_desc: row.calculation_desc || "From Invoice & Volume",
    uom_override: row.uom_override || "Auto"
  }));
  setStatus("Saving config...", true);
  try {
    const resp = await fetch("/api/submeter-rates/config", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({items})
    });
    const data = await resp.json();
    if (data.ok) {
      setStatus("Config saved. Regenerating...", true);
      generateReport(true);
    } else {
      setStatus("Save failed: " + (data.error || "unknown"), false);
    }
  } catch (e) {
    setStatus("Save error: " + e.message, false);
  }
}

/* ---- Export CSV ---- */
function exportCSV() {
  const period = document.getElementById("period-select").value;
  window.open(`/api/submeter-rates/export-csv?ubi_period=${encodeURIComponent(period)}`, "_blank");
}

/* ---- Summary ---- */
function renderSummary() {
  const bar = document.getElementById("summary-bar");
  if (!allRows.length) { bar.style.display = "none"; return; }
  bar.style.display = "flex";
  let visibleRows = allRows;
  if (showSubmeteredOnly) visibleRows = visibleRows.filter(isSubmetered);
  const props = new Set(visibleRows.map(r => r.property_name));
  const waterRows = visibleRows.filter(r => r.utility_name === "Water");
  const sewerRows = visibleRows.filter(r => r.utility_name === "Sewer");
  const waterVol = waterRows.reduce((s, r) => s + (r.volume_total_gals || 0), 0);
  const sewerVol = sewerRows.reduce((s, r) => s + (r.volume_total_gals || 0), 0);
  const waterRates = waterRows.filter(r => r.rate != null).map(r => r.rate);
  const sewerRates = sewerRows.filter(r => r.rate != null).map(r => r.rate);
  const avgWater = waterRates.length ? waterRates.reduce((a,b) => a+b, 0) / waterRates.length : null;
  const avgSewer = sewerRates.length ? sewerRates.reduce((a,b) => a+b, 0) / sewerRates.length : null;
  document.getElementById("stat-properties").textContent = props.size;
  document.getElementById("stat-water-vol").textContent = fmtNum(Math.round(waterVol));
  document.getElementById("stat-sewer-vol").textContent = fmtNum(Math.round(sewerVol));
  document.getElementById("stat-water-rate").textContent = avgWater != null ? avgWater.toFixed(6) : "-";
  document.getElementById("stat-sewer-rate").textContent = avgSewer != null ? avgSewer.toFixed(6) : "-";
}

/* ---- Table ---- */
function renderTable() {
  const container = document.getElementById("table-container");
  if (!allRows.length) {
    container.innerHTML = '<div class="empty-msg">No results. Try generating a report.</div>';
    return;
  }

  let rows = allRows;
  if (showSubmeteredOnly) rows = rows.filter(isSubmetered);
  if (showIssuesOnly) rows = rows.filter(isIssueRow);

  const sorted = [...rows].sort((a, b) => {
    let va = a[sortCol], vb = b[sortCol];
    if (typeof va === "string") va = (va || "").toLowerCase();
    if (typeof vb === "string") vb = (vb || "").toLowerCase();
    if (va == null) va = sortAsc ? Infinity : -Infinity;
    if (vb == null) vb = sortAsc ? Infinity : -Infinity;
    if (va < vb) return sortAsc ? -1 : 1;
    if (va > vb) return sortAsc ? 1 : -1;
    return 0;
  });

  if (showIssuesOnly && sorted.length === 0) {
    container.innerHTML = '<div class="empty-msg">No issues found — all rows have valid rates.</div>';
    return;
  }

  const arrow = col => col === sortCol ? (sortAsc ? " &#9650;" : " &#9660;") : "";

  let html = '<table><thead><tr>';
  html += `<th onclick="doSort('property_name')">Property<span class="sort-arrow">${arrow("property_name")}</span></th>`;
  html += `<th onclick="doSort('utility_name')">Utility<span class="sort-arrow">${arrow("utility_name")}</span></th>`;
  html += `<th onclick="doSort('invoice_total')">Invoice Total<span class="sort-arrow">${arrow("invoice_total")}</span></th>`;
  html += `<th onclick="doSort('raw_consumption')">Raw Consumption<span class="sort-arrow">${arrow("raw_consumption")}</span></th>`;
  html += `<th>Conversion</th>`;
  html += `<th onclick="doSort('volume_total_gals')">Volume (Gal)<span class="sort-arrow">${arrow("volume_total_gals")}</span></th>`;
  html += `<th onclick="doSort('rate')">Rate ($/gal)<span class="sort-arrow">${arrow("rate")}</span></th>`;
  html += `<th>UOM Override</th>`;
  html += `<th>Calc Desc</th>`;
  html += '</tr></thead><tbody>';

  sorted.forEach((row) => {
    const issue = isIssueRow(row);
    const rowIdx = allRows.indexOf(row);
    html += `<tr${issue ? ' class="highlight"' : ''}>`;
    html += `<td><a href="#" onclick="event.preventDefault();showDetail(${rowIdx})" style="color:#2563eb;text-decoration:none;font-weight:600">${esc(row.property_name)}</a><br><span style="font-size:.7rem;color:#94a3b8">${esc(row.ar_code || "")}</span></td>`;
    html += `<td>${esc(row.utility_name)}</td>`;
    html += `<td class="total-cell">${row.invoice_total != null ? "$" + fmtNum(row.invoice_total.toFixed(2)) : "-"}</td>`;
    // Raw consumption + invoice UOM badge
    html += `<td class="raw-cell mono">${row.raw_consumption ? fmtNum(row.raw_consumption.toFixed(2)) : '-'}`;
    html += ` <span class="uom-badge">${row.raw_uom ? esc(row.raw_uom) : 'no UOM'}</span></td>`;
    // Conversion: shows exactly what math was applied
    html += `<td style="font-size:.75rem">${row.conversion ? esc(row.conversion) : '<span class="na-badge">none</span>'}</td>`;
    // Volume (converted gallons)
    html += `<td class="volume-cell mono">${row.volume_total_gals ? fmtNum(Math.round(row.volume_total_gals)) : '<span class="na-badge">0</span>'}</td>`;
    // Rate
    html += `<td class="rate-cell">${row.rate != null ? row.rate.toFixed(6) : '<span class="na-badge">N/A</span>'}</td>`;
    // UOM Override dropdown
    html += `<td><select class="cfg-select" onchange="setUomOverride(${rowIdx}, this.value)">`;
    UOM_OPTIONS.forEach(o => {
      const sel = (row.uom_override || "Auto") === o.val ? " selected" : "";
      html += `<option value="${esc(o.val)}"${sel}>${esc(o.label)}</option>`;
    });
    html += `</select></td>`;
    // Calc Desc
    html += `<td><select class="cfg-select" onchange="setCalcDesc(${rowIdx}, this.value)">`;
    CALC_OPTIONS.forEach(opt => {
      const sel = (row.calculation_desc || "From Invoice & Volume") === opt ? " selected" : "";
      html += `<option value="${esc(opt)}"${sel}>${esc(opt)}</option>`;
    });
    html += `</select></td>`;
    html += '</tr>';
  });

  html += '</tbody></table>';
  container.innerHTML = html;
}

function doSort(col) {
  if (sortCol === col) sortAsc = !sortAsc;
  else { sortCol = col; sortAsc = true; }
  renderTable();
}

function setCalcDesc(rowIdx, val) { allRows[rowIdx].calculation_desc = val; }

function setUomOverride(rowIdx, val) {
  const row = allRows[rowIdx];
  row.uom_override = val;
  // Recalculate volume and rate instantly in the UI
  const factor = UOM_FACTOR_MAP[val];
  if (factor !== null && factor !== undefined && row.raw_consumption) {
    // Override: raw_consumption × override factor
    row.volume_total_gals = Math.round(row.raw_consumption * factor * 100) / 100;
    row.conversion = `×${factor} (${val}→Gal)`;
    row.factor_used = factor;
  } else if (val === "Auto") {
    // Revert to the server-calculated values — need to regenerate for true Auto,
    // but use the original factor if we have it stored
    if (row._orig_volume != null) {
      row.volume_total_gals = row._orig_volume;
      row.conversion = row._orig_conversion;
      row.factor_used = row._orig_factor;
    }
  }
  // Recalculate rate
  row.rate = (row.volume_total_gals && row.volume_total_gals > 0)
    ? Math.round((row.invoice_total / row.volume_total_gals) * 1e6) / 1e6
    : null;
  renderSummary();
  renderTable();
  // Auto-save config in background
  debouncedSaveConfig();
}

/* ---- Drill-down detail ---- */
function showDetail(rowIdx) {
  const row = allRows[rowIdx];
  const lines = row.source_lines || [];
  document.getElementById("detailTitle").textContent = row.property_name + " — " + row.utility_name;
  document.getElementById("detailSubtitle").textContent =
    `${lines.length} invoice line(s)  |  Total: $${fmtNum(row.invoice_total.toFixed(2))}  |  Volume: ${fmtNum(Math.round(row.volume_total_gals))} gal`;

  let html = '<table style="width:100%;border-collapse:collapse;font-size:.82rem">';
  html += '<thead><tr style="background:#f1f5f9">';
  html += '<th style="padding:8px;text-align:left">#</th>';
  html += '<th style="padding:8px;text-align:left">Vendor / Account</th>';
  html += '<th style="padding:8px;text-align:left">Service Period</th>';
  html += '<th style="padding:8px;text-align:right">Amount ($)</th>';
  html += '<th style="padding:8px;text-align:right">Raw Consumption</th>';
  html += '<th style="padding:8px;text-align:left">UOM</th>';
  html += '<th style="padding:8px;text-align:left">Conversion</th>';
  html += '<th style="padding:8px;text-align:right">Gallons</th>';
  html += '<th style="padding:8px;text-align:center">PDF</th>';
  html += '</tr></thead><tbody>';

  let runAmt = 0, runGal = 0, runRaw = 0;
  lines.forEach((ln, i) => {
    runAmt += ln.amount || 0;
    runGal += ln.gallons || 0;
    runRaw += ln.raw_consumption || 0;
    html += `<tr style="border-bottom:1px solid #e5e7eb${ln.gallons === 0 ? ';background:#fffbeb' : ''}">`;
    html += `<td style="padding:6px 8px;color:#94a3b8">${i + 1}</td>`;
    html += `<td style="padding:6px 8px">${esc(ln.vendor)}${ln.account ? '<br><span style="font-size:.7rem;color:#94a3b8">' + esc(ln.account) + '</span>' : ''}</td>`;
    html += `<td style="padding:6px 8px;font-size:.78rem">${esc(ln.service_period)}</td>`;
    html += `<td style="padding:6px 8px;text-align:right;font-family:monospace">$${fmtNum(ln.amount.toFixed(2))}</td>`;
    html += `<td style="padding:6px 8px;text-align:right;font-family:monospace">${ln.raw_consumption ? fmtNum(ln.raw_consumption.toFixed(2)) : '-'}</td>`;
    html += `<td style="padding:6px 8px"><span class="uom-badge">${esc(ln.raw_uom || 'none')}</span></td>`;
    html += `<td style="padding:6px 8px;font-size:.75rem">${esc(ln.conversion)}</td>`;
    html += `<td style="padding:6px 8px;text-align:right;font-family:monospace">${fmtNum(Math.round(ln.gallons))}</td>`;
    // View PDF button
    const pdfKey = ln.pdf_s3_key || "";
    if (pdfKey) {
      html += `<td style="padding:6px 8px;text-align:center"><a href="/pdf?k=${encodeURIComponent(pdfKey)}" target="_blank" title="View source invoice PDF" style="display:inline-block;padding:3px 8px;border-radius:6px;background:#2563eb;color:#fff;font-size:.72rem;font-weight:600;text-decoration:none;white-space:nowrap">VIEW</a></td>`;
    } else if (ln.jsonl_key) {
      // Fallback: open the JSONL as raw text (less useful but still provides traceability)
      html += `<td style="padding:6px 8px;text-align:center"><span style="font-size:.7rem;color:#94a3b8" title="No PDF link found — JSONL key: ${esc(ln.jsonl_key)}">no PDF</span></td>`;
    } else {
      html += `<td style="padding:6px 8px;text-align:center"><span style="font-size:.7rem;color:#94a3b8">—</span></td>`;
    }
    html += '</tr>';
  });

  // Running total row
  html += '<tr style="background:#f1f5f9;font-weight:700;border-top:2px solid #cbd5e1">';
  html += '<td colspan="3" style="padding:8px">TOTAL</td>';
  html += `<td style="padding:8px;text-align:right;font-family:monospace">$${fmtNum(runAmt.toFixed(2))}</td>`;
  html += `<td style="padding:8px;text-align:right;font-family:monospace">${fmtNum(runRaw.toFixed(2))}</td>`;
  html += '<td colspan="2" style="padding:8px"></td>';
  html += `<td style="padding:8px;text-align:right;font-family:monospace">${fmtNum(Math.round(runGal))}</td>`;
  html += '<td></td>';
  html += '</tr>';

  // Rate calculation
  const calcRate = runGal > 0 ? (runAmt / runGal) : null;
  html += '<tr style="background:#eff6ff">';
  html += '<td colspan="3" style="padding:8px;font-weight:700">RATE ($/gal)</td>';
  html += `<td colspan="6" style="padding:8px;font-family:monospace;font-weight:700;font-size:1rem">${calcRate != null ? '$' + runAmt.toFixed(2) + ' / ' + fmtNum(Math.round(runGal)) + ' gal = ' + calcRate.toFixed(6) : 'N/A (no volume)'}</td>`;
  html += '</tr>';

  html += '</tbody></table>';
  document.getElementById("detailContent").innerHTML = html;
  document.getElementById("detailModal").style.display = "block";
}

function closeDetail() {
  document.getElementById("detailModal").style.display = "none";
}

/* ---- Helpers ---- */
function fmtNum(n) { return n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","); }
function esc(s) {
  if (!s) return "";
  const d = document.createElement("div");
  d.textContent = s;
  return d.innerHTML;
}

/* ---- Init ---- */
populatePeriods();
</script>
</body>
</html>
