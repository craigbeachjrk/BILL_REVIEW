<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WORKFLOW</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root { --bg:#0ea5e9; --bg2:#4338ca; --glass:rgba(255,255,255,.72); --border:rgba(255,255,255,.33); }
    body{font-family:Inter,system-ui,sans-serif;margin:0;background:linear-gradient(135deg,var(--bg),var(--bg2));min-height:100vh;color:#0f172a}
    header.top{position:sticky;top:0;display:flex;justify-content:space-between;align-items:center;padding:14px 20px;color:#fff;z-index:100}
    .btn{display:inline-block;padding:8px 12px;border-radius:10px;border:none;background:#0ea5e9;color:#fff;cursor:pointer;text-decoration:none;font-size:13px}
    .btn.secondary{background:#64748b}
    .btn.small{padding:4px 8px;font-size:11px}
    .wrap{max-width:1800px;margin:40px auto;padding:0 20px}
    h1{margin:0 0 16px 0;color:#fff}

    /* Summary Cards */
    .summary-cards{display:flex;gap:12px;margin-bottom:20px;flex-wrap:wrap;align-items:center}
    .summary-card{background:var(--glass);backdrop-filter:blur(10px);border:1px solid var(--border);border-radius:12px;padding:12px 20px;min-width:110px;text-align:center;cursor:pointer;transition:transform .1s,outline .1s}
    .summary-card:hover{transform:translateY(-2px)}
    .summary-card.active{outline:3px solid #fff;box-shadow:0 4px 16px rgba(0,0,0,.2)}
    .summary-card .count{font-size:28px;font-weight:700;display:block}
    .summary-card .label{font-size:11px;opacity:.8}
    .summary-card.very-late .count{color:#b91c1c}
    .summary-card.late .count{color:#c2410c}
    .summary-card.slightly-late .count{color:#a16207}
    .summary-card.due-soon .count{color:#1d4ed8}
    .summary-card.on-track .count{color:#166534}
    .summary-card.complete .count{color:#059669}
    .summary-card.all-card .count{color:#334155}

    /* Overall progress area */
    .overall-progress{display:flex;align-items:center;gap:16px;margin-left:auto;padding:8px 0}
    .overall-progress .pct{font-size:22px;font-weight:700;color:#fff}
    .overall-progress .bar-wrap{width:180px;height:10px;background:rgba(255,255,255,.3);border-radius:5px;overflow:hidden}
    .overall-progress .bar-fill{height:100%;border-radius:5px;transition:width .5s}
    .overall-progress .bar-fill.green{background:#10b981}
    .overall-progress .bar-fill.yellow{background:#f59e0b}
    .overall-progress .bar-fill.red{background:#ef4444}

    /* AP Cards */
    .ap-cards{display:flex;gap:10px;margin-bottom:20px;flex-wrap:wrap}
    .ap-card{background:var(--glass);backdrop-filter:blur(10px);border:2px solid var(--border);border-radius:12px;padding:10px 18px;min-width:120px;text-align:center;cursor:pointer;transition:transform .1s,outline .1s}
    .ap-card:hover{transform:translateY(-2px)}
    .ap-card.active{outline:3px solid #fff;box-shadow:0 4px 16px rgba(0,0,0,.2)}
    .ap-card .ap-name{font-size:13px;font-weight:700}
    .ap-card .ap-count{font-size:11px;opacity:.7;margin-top:2px}
    .ap-card.health-green{border-color:#10b981;background:rgba(16,185,129,.15)}
    .ap-card.health-yellow{border-color:#f59e0b;background:rgba(245,158,11,.15)}
    .ap-card.health-red{border-color:#ef4444;background:rgba(239,68,68,.15)}

    /* Toolbar */
    .toolbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;gap:12px;flex-wrap:wrap}
    .toolbar-left{display:flex;gap:8px;align-items:center}
    .toolbar-right{display:flex;gap:8px;align-items:center}
    .search-box{padding:8px 12px;border:1px solid #e5e7eb;border-radius:8px;width:320px;font-size:13px}

    /* Property Cards Grid */
    .property-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(340px,1fr));gap:14px}
    .property-card{background:#fff;border-radius:12px;padding:14px;border:2px solid #e5e7eb;cursor:pointer;transition:all .2s}
    .property-card:hover{box-shadow:0 4px 16px rgba(0,0,0,.1);transform:translateY(-1px)}
    .property-card.complete{border-color:#10b981;background:#f0fdf4}
    .property-card.partial{border-color:#f59e0b;background:#fffbeb}
    .property-card.missing{border-color:#ef4444;background:#fef2f2}
    .property-name{font-weight:700;font-size:14px;margin-bottom:2px}
    .property-ap{font-size:11px;color:#7c3aed;font-weight:500;margin-bottom:6px}
    .property-stats{display:flex;justify-content:space-between;align-items:center;font-size:12px;color:#64748b;margin-bottom:6px}
    .progress-bar{height:6px;background:#e5e7eb;border-radius:3px;overflow:hidden}
    .progress-fill{height:100%;border-radius:3px;transition:width .5s}
    .progress-green{background:#10b981}
    .progress-yellow{background:#f59e0b}
    .progress-red{background:#ef4444}

    /* Account Items inside property card */
    .account-list{display:none;margin-top:10px;border-top:1px solid #e5e7eb;padding-top:8px}
    .property-card.expanded .account-list{display:block}
    .account-item{display:flex;align-items:center;gap:8px;padding:5px 8px;border-radius:6px;font-size:12px;transition:background .15s}
    .account-item:hover{background:#f1f5f9}
    .account-item .acct-info{flex:1;min-width:0}
    .account-item .acct-label{font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .month-badge{display:inline-block;padding:2px 7px;border-radius:8px;font-size:10px;font-weight:700;white-space:nowrap}
    .month-badge.VERY_LATE{background:#fecaca;color:#b91c1c}
    .month-badge.LATE{background:#fed7aa;color:#c2410c}
    .month-badge.SLIGHTLY_LATE{background:#fef08a;color:#a16207}
    .month-badge.DUE_SOON{background:#bfdbfe;color:#1d4ed8}
    .month-badge.ON_TRACK{background:#e2e8f0;color:#475569}
    .month-badge.COMPLETE{background:#bbf7d0;color:#166534}
    .status-icon{font-size:14px;font-weight:700;min-width:18px;text-align:center}
    .status-icon.miss{color:#ef4444}
    .status-icon.wait{color:#3b82f6}
    .status-icon.ok{color:#10b981}
    .stage-tag{font-size:9px;padding:1px 5px;border-radius:4px;background:#e0f2fe;color:#0369a1;font-weight:600;margin-left:4px}
    .scraper-tag{font-size:9px;padding:1px 4px;border-radius:3px;background:#7c3aed;color:#fff;font-weight:600;margin-left:4px}

    /* Toast */
    .toast{position:fixed;top:20px;right:20px;background:#111827;color:#fff;padding:12px 16px;border-radius:10px;box-shadow:0 8px 20px rgba(0,0,0,.25);z-index:60;opacity:0;transition:opacity .3s}
    .toast.show{opacity:.96}
    .toast.ok{background:#0f766e}
    .toast.err{background:#b91c1c}

    /* Loading */
    .loading{text-align:center;padding:60px;color:#64748b;font-size:14px}

    /* Tabs */
    .tab-bar{display:flex;gap:4px;margin-bottom:20px}
    .tab-btn{padding:12px 24px;background:rgba(255,255,255,0.3);border:none;border-radius:12px 12px 0 0;cursor:pointer;font-weight:600;font-size:14px;color:#fff;transition:all 0.15s}
    .tab-btn:hover{background:rgba(255,255,255,0.4)}
    .tab-btn.active{background:var(--glass);color:#0f172a}
    .tab-content{display:none}
    .tab-content.active{display:block}

    /* Generated timestamp */
    .meta-info{color:rgba(255,255,255,.6);font-size:11px}
  </style>
</head>
<body>
  <header class="top">
    <div><a href="/" style="text-decoration:none;color:#fff;font-weight:600">Bill Review @ JRK</a></div>
    <div>
      {% if is_admin %}<a class="btn" href="/workflow/manage" style="background:#dc2626">Manage Accounts</a>{% endif %}
      <a class="btn" href="/workflow/manager">Manager View</a>
      <a class="btn" href="/directed">Directed</a>
      <a class="btn secondary" href="/">Back</a>
    </div>
  </header>

  <div id="toast" class="toast"></div>

  <div class="wrap">
    <h1>WORKFLOW</h1>

    <!-- Tab Bar -->
    <div class="tab-bar">
      <button class="tab-btn active" data-tab="tracker">Completion Tracker</button>
      <button class="tab-btn" data-tab="lateBills">Late Bills (Table)</button>
    </div>

    <!-- COMPLETION TRACKER TAB -->
    <div class="tab-content active" id="trackerTab">

      <!-- Row 1: Status Summary Cards + Progress -->
      <div class="summary-cards" id="statusCards">
        <div class="summary-card very-late" data-status="VERY_LATE">
          <span class="count" id="ctVeryLate">-</span>
          <span class="label">Very Late (15+)</span>
        </div>
        <div class="summary-card late" data-status="LATE">
          <span class="count" id="ctLate">-</span>
          <span class="label">Late (8-14)</span>
        </div>
        <div class="summary-card slightly-late" data-status="SLIGHTLY_LATE">
          <span class="count" id="ctSlightlyLate">-</span>
          <span class="label">Slightly Late (1-7)</span>
        </div>
        <div class="summary-card due-soon" data-status="DUE_SOON">
          <span class="count" id="ctDueSoon">-</span>
          <span class="label">Due Soon</span>
        </div>
        <div class="summary-card on-track" data-status="ON_TRACK">
          <span class="count" id="ctOnTrack">-</span>
          <span class="label">On Track</span>
        </div>
        <div class="summary-card complete" data-status="COMPLETE">
          <span class="count" id="ctComplete">-</span>
          <span class="label">Complete</span>
        </div>
        <div class="summary-card all-card" data-status="ALL">
          <span class="count" id="ctAll">-</span>
          <span class="label">All</span>
        </div>
        <div class="overall-progress">
          <div class="bar-wrap"><div class="bar-fill green" id="overallBar" style="width:0%"></div></div>
          <span class="pct" id="overallPct">0%</span>
          <button class="btn small" id="recalcBtn" title="Recalculate from S3">Recalculate</button>
        </div>
      </div>

      <!-- Row 2: AP Person Cards -->
      <div class="ap-cards" id="apCards"></div>

      <!-- Toolbar: Search -->
      <div class="toolbar">
        <div class="toolbar-left">
          <input type="text" class="search-box" id="trackerSearch" placeholder="Search property, vendor, account..." />
          <span class="meta-info" id="trackerMeta"></span>
        </div>
        <div class="toolbar-right">
          <button class="btn secondary" id="refreshBtn">Refresh</button>
        </div>
      </div>

      <!-- Property Cards -->
      <div id="trackerContent">
        <div class="loading">Loading completion tracker...</div>
      </div>
    </div><!-- End Tracker Tab -->

    <!-- LATE BILLS TABLE TAB (preserved from original) -->
    <div class="tab-content" id="lateBillsTab">
      <div class="summary-cards" id="summaryCards">
        <div class="summary-card very-late" data-status="VERY_LATE">
          <span class="count" id="countVeryLate">-</span>
          <span class="label">Very Late (15+)</span>
        </div>
        <div class="summary-card late" data-status="LATE">
          <span class="count" id="countLate">-</span>
          <span class="label">Late (8-14)</span>
        </div>
        <div class="summary-card slightly-late" data-status="SLIGHTLY_LATE">
          <span class="count" id="countSlightlyLate">-</span>
          <span class="label">Slightly Late (1-7)</span>
        </div>
        <div class="summary-card due-soon" data-status="DUE_SOON">
          <span class="count" id="countDueSoon">-</span>
          <span class="label">Due Soon (7 days)</span>
        </div>
        <div class="summary-card on-track" data-status="ON_TRACK">
          <span class="count" id="countOnTrack">-</span>
          <span class="label">On Track</span>
        </div>
      </div>

      <div class="toolbar">
        <div class="toolbar-left">
          <input type="text" class="search-box" id="searchBox" placeholder="Search property, vendor, account, AP rep..." />
          <label style="color:#fff;font-size:12px;display:flex;align-items:center;gap:4px">
            <input type="checkbox" id="filterHasNote" /> Has Notes
          </label>
          <span id="lastUpdated" style="color:rgba(255,255,255,0.7);font-size:11px;margin-left:8px"></span>
        </div>
        <div class="toolbar-right">
          <button class="btn secondary" id="tableRecalcBtn" title="Recalculate workflow data">Recalculate</button>
          <button class="btn secondary" id="tableRefreshBtn">Refresh</button>
          <button class="btn" id="openDrawer">Filter & Sort</button>
        </div>
      </div>

      <div class="card">
        <div class="tableWrap" style="overflow:auto;max-height:calc(100vh - 340px)">
          <table id="workflowTable" style="width:100%;border-collapse:collapse;background:#fff">
            <thead>
              <tr>
                <th style="width:36px;padding:10px 12px;border-bottom:1px solid #e5e7eb;background:#f8fafc;font-size:12px;font-weight:600;position:sticky;top:0;z-index:10"><input type="checkbox" class="row-select" id="selectAll" title="Select all visible" style="width:16px;height:16px;cursor:pointer;accent-color:#0ea5e9" /></th>
                <th data-col="note" style="width:50px;padding:10px 12px;border-bottom:1px solid #e5e7eb;background:#f8fafc;font-size:12px;font-weight:600;position:sticky;top:0;z-index:10;cursor:pointer">Note</th>
                <th style="width:40px;padding:10px 12px;border-bottom:1px solid #e5e7eb;background:#f8fafc;font-size:12px;font-weight:600;position:sticky;top:0;z-index:10">Edit</th>
                <th data-col="status" style="width:100px;padding:10px 12px;border-bottom:1px solid #e5e7eb;background:#f8fafc;font-size:12px;font-weight:600;position:sticky;top:0;z-index:10;cursor:pointer">Status</th>
                <th data-col="propertyName" style="padding:10px 12px;border-bottom:1px solid #e5e7eb;background:#f8fafc;font-size:12px;font-weight:600;position:sticky;top:0;z-index:10;cursor:pointer">Property</th>
                <th data-col="vendorName" style="padding:10px 12px;border-bottom:1px solid #e5e7eb;background:#f8fafc;font-size:12px;font-weight:600;position:sticky;top:0;z-index:10;cursor:pointer">Vendor</th>
                <th data-col="accountNumber" style="padding:10px 12px;border-bottom:1px solid #e5e7eb;background:#f8fafc;font-size:12px;font-weight:600;position:sticky;top:0;z-index:10;cursor:pointer">Account #</th>
                <th data-col="apName" style="padding:10px 12px;border-bottom:1px solid #e5e7eb;background:#f8fafc;font-size:12px;font-weight:600;position:sticky;top:0;z-index:10;cursor:pointer">AP Rep</th>
                <th data-col="nextExpectedDate" style="padding:10px 12px;border-bottom:1px solid #e5e7eb;background:#f8fafc;font-size:12px;font-weight:600;position:sticky;top:0;z-index:10;cursor:pointer">Next Expected</th>
                <th data-col="daysOverdue" style="width:80px;padding:10px 12px;border-bottom:1px solid #e5e7eb;background:#f8fafc;font-size:12px;font-weight:600;position:sticky;top:0;z-index:10;cursor:pointer">Days</th>
                <th data-col="lastBillDate" style="padding:10px 12px;border-bottom:1px solid #e5e7eb;background:#f8fafc;font-size:12px;font-weight:600;position:sticky;top:0;z-index:10;cursor:pointer">Last Bill</th>
                <th style="width:45px;padding:10px 12px;border-bottom:1px solid #e5e7eb;background:#f8fafc;font-size:12px;font-weight:600;position:sticky;top:0;z-index:10">View</th>
                <th data-col="servicePeriodDays" style="width:80px;padding:10px 12px;border-bottom:1px solid #e5e7eb;background:#f8fafc;font-size:12px;font-weight:600;position:sticky;top:0;z-index:10;cursor:pointer">Period</th>
                <th data-col="hasScraper" style="width:55px;padding:10px 12px;border-bottom:1px solid #e5e7eb;background:#f8fafc;font-size:12px;font-weight:600;position:sticky;top:0;z-index:10;cursor:pointer">Scraper</th>
              </tr>
            </thead>
            <tbody id="tableBody">
              <tr><td colspan="14" class="loading">Switch to this tab to load table view...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div><!-- End Late Bills Tab -->

  </div>

  <!-- Filter Drawer (for Late Bills table tab) -->
  <div class="drawer-mask" id="drawerMask" style="position:fixed;inset:0;background:rgba(0,0,0,0.38);opacity:0;pointer-events:none;transition:opacity .2s;z-index:40"></div>
  <aside class="drawer" id="drawer" style="position:fixed;top:0;right:-420px;width:420px;max-width:92vw;height:100vh;background:#fff;box-shadow:-8px 0 24px rgba(0,0,0,.25);transition:right .25s;z-index:41;display:flex;flex-direction:column">
    <header style="display:flex;align-items:center;justify-content:space-between;padding:16px 18px;border-bottom:1px solid #e5e7eb">
      <div style="font-weight:700">Filter & Sort</div>
      <button class="btn small" id="closeDrawer">Close</button>
    </header>
    <div class="body" style="flex:1;overflow:auto;padding:16px 18px">
      <div style="margin-bottom:16px">
        <div style="font-weight:600;margin-bottom:8px;font-size:13px">Sort By</div>
        <select id="sortBy" style="width:100%;padding:8px;border:1px solid #e5e7eb;border-radius:6px;font-size:13px">
          <option value="urgency">Urgency (default)</option>
          <option value="daysOverdue">Days Overdue</option>
          <option value="propertyName">Property Name</option>
          <option value="vendorName">Vendor Name</option>
          <option value="accountNumber">Account Number</option>
          <option value="apName">AP Rep</option>
          <option value="nextExpectedDate">Next Expected Date</option>
        </select>
      </div>
      <div style="margin-bottom:16px">
        <div style="font-weight:600;margin-bottom:8px;font-size:13px">Status</div>
        <div style="display:flex;flex-direction:column;gap:6px;max-height:180px;overflow:auto" id="drawerStatusFilters"></div>
      </div>
      <div style="margin-bottom:16px">
        <div style="font-weight:600;margin-bottom:8px;font-size:13px">AP Rep</div>
        <div style="display:flex;flex-direction:column;gap:6px;max-height:180px;overflow:auto" id="drawerApFilters"></div>
      </div>
      <div style="margin-bottom:16px">
        <div style="font-weight:600;margin-bottom:8px;font-size:13px">Property <input type="text" id="drawerPropSearch" placeholder="Search..." style="padding:4px 8px;border:1px solid #e5e7eb;border-radius:4px;font-size:11px;width:120px;margin-left:8px" /></div>
        <div style="display:flex;flex-direction:column;gap:6px;max-height:180px;overflow:auto" id="drawerPropFilters"></div>
      </div>
      <div style="margin-bottom:16px">
        <div style="font-weight:600;margin-bottom:8px;font-size:13px">Vendor <input type="text" id="drawerVendorSearch" placeholder="Search..." style="padding:4px 8px;border:1px solid #e5e7eb;border-radius:4px;font-size:11px;width:120px;margin-left:8px" /></div>
        <div style="display:flex;flex-direction:column;gap:6px;max-height:180px;overflow:auto" id="drawerVendorFilters"></div>
      </div>
    </div>
    <div style="padding:12px 18px;border-top:1px solid #e5e7eb;display:flex;gap:10px;justify-content:flex-end">
      <button class="btn secondary" id="drawerClear">Clear All</button>
      <button class="btn" id="drawerApply">Apply</button>
    </div>
  </aside>

  <!-- Note Modal (for Late Bills tab) -->
  <div class="modal-overlay" id="noteModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:50;align-items:center;justify-content:center">
    <div class="modal-box" style="background:#fff;border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.3);max-width:500px;width:90%;max-height:90vh;overflow-y:auto;padding:24px">
      <h2 style="margin:0 0 16px 0;font-size:18px">Account Note</h2>
      <div id="noteAccountInfo" style="padding:8px 12px;background:#f8fafc;border-radius:6px;margin-bottom:12px;font-size:12px;color:#64748b"></div>
      <div style="margin-bottom:16px">
        <label style="display:block;margin-bottom:6px;font-weight:600;font-size:13px;color:#475569">Reason Code</label>
        <select id="noteReasonCode" style="width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:8px;font-size:14px">
          <option value="">-- Select --</option>
        </select>
      </div>
      <div style="margin-bottom:16px">
        <label style="display:block;margin-bottom:6px;font-weight:600;font-size:13px;color:#475569">Additional Notes</label>
        <textarea id="noteText" style="width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:8px;font-size:14px;font-family:inherit;min-height:80px;resize:vertical"></textarea>
      </div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:20px">
        <button class="btn secondary" id="noteClear">Clear Note</button>
        <button class="btn secondary" onclick="document.getElementById('noteModal').style.display='none'">Cancel</button>
        <button class="btn" id="noteSave">Save</button>
      </div>
    </div>
  </div>

  <!-- Edit Account Modal (for Late Bills tab) -->
  <div class="modal-overlay" id="editModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:50;align-items:center;justify-content:center">
    <div class="modal-box" style="background:#fff;border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.3);max-width:500px;width:90%;max-height:90vh;overflow-y:auto;padding:24px">
      <h2 style="margin:0 0 16px 0;font-size:18px">Edit Account Mapping</h2>
      <div id="editAccountInfo" style="padding:8px 12px;background:#f8fafc;border-radius:6px;margin-bottom:12px;font-size:12px;color:#64748b"></div>
      <div style="margin-bottom:16px">
        <label style="display:block;margin-bottom:6px;font-weight:600;font-size:13px;color:#475569">Property</label>
        <input type="text" id="editPropSearch" placeholder="Search properties..." style="width:100%;padding:8px;border:1px solid #e5e7eb;border-radius:8px;font-size:13px;margin-bottom:4px" />
        <div id="editPropList" style="max-height:200px;overflow-y:auto;border:1px solid #e5e7eb;border-radius:8px"></div>
      </div>
      <div style="margin-bottom:16px">
        <label style="display:block;margin-bottom:6px;font-weight:600;font-size:13px;color:#475569">Vendor</label>
        <input type="text" id="editVendorSearch" placeholder="Search vendors..." style="width:100%;padding:8px;border:1px solid #e5e7eb;border-radius:8px;font-size:13px;margin-bottom:4px" />
        <div id="editVendorList" style="max-height:200px;overflow-y:auto;border:1px solid #e5e7eb;border-radius:8px"></div>
      </div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:20px">
        {% if is_admin %}<button class="btn" id="editDelete" style="background:#dc2626;margin-right:auto">Delete Account</button>{% endif %}
        <button class="btn secondary" onclick="document.getElementById('editModal').style.display='none'">Cancel</button>
        <button class="btn" id="editSave">Save Changes</button>
      </div>
    </div>
  </div>

  <!-- Bulk Toolbar (for Late Bills tab) -->
  <div class="bulk-toolbar" id="bulkToolbar" style="position:fixed;bottom:-70px;left:50%;transform:translateX(-50%);background:rgba(15,23,42,.92);backdrop-filter:blur(12px);color:#fff;padding:12px 24px;border-radius:14px;box-shadow:0 8px 32px rgba(0,0,0,.35);display:flex;align-items:center;gap:16px;z-index:45;transition:bottom .25s ease;font-size:13px">
    <span class="sel-count" style="font-weight:700;min-width:90px" id="selCount">0 selected</span>
    <button class="btn small" id="bulkVendorBtn">Set Vendor</button>
    <button class="btn small" id="bulkReasonBtn">Set Reason Code</button>
    <button class="btn small" id="bulkDeselectBtn" style="background:transparent;border:1px solid rgba(255,255,255,.4)">Deselect All</button>
  </div>

<script>
/* ======== STATE ======== */
let trackerData = null;       // Full completion tracker response
let activeStatus = null;      // Selected status filter (null = all)
let activeAp = null;          // Selected AP filter (null = all)
let searchText = '';          // Search filter text

/* Late Bills tab state (lazy loaded) */
let allData = [];
let filteredData = [];
let selectedKeys = new Set();
let filterState = {status: null, ap: [], properties: [], vendors: [], hasNote: false, sort: 'urgency'};
let reasonCodes = [];
let lateBillsLoaded = false;
let catalogProperties = [];
let catalogVendors = [];

/* ======== INIT ======== */
document.addEventListener('DOMContentLoaded', () => {
  loadTrackerData();
  initTabs();
  initTrackerEvents();
  initLateBillsEvents();
});

/* ======== TABS ======== */
function initTabs() {
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      btn.classList.add('active');
      const tab = btn.dataset.tab;
      const el = document.getElementById(tab + 'Tab');
      if (el) el.classList.add('active');
      // Lazy load late bills on first switch
      if (tab === 'lateBills' && !lateBillsLoaded) {
        loadLateBillsData();
      }
    });
  });
}

/* ======== TOAST ======== */
function showToast(msg, type) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = 'toast show ' + (type || '');
  clearTimeout(t._tid);
  t._tid = setTimeout(() => t.className = 'toast', 3000);
}

/* ======== COMPLETION TRACKER ======== */

function initTrackerEvents() {
  // Status cards click
  document.querySelectorAll('#statusCards .summary-card').forEach(card => {
    card.addEventListener('click', () => {
      const status = card.dataset.status;
      if (activeStatus === status) {
        activeStatus = null;
        card.classList.remove('active');
      } else {
        document.querySelectorAll('#statusCards .summary-card').forEach(c => c.classList.remove('active'));
        activeStatus = status;
        card.classList.add('active');
      }
      renderTracker();
    });
  });

  // Search
  document.getElementById('trackerSearch').addEventListener('input', e => {
    searchText = e.target.value.toLowerCase();
    renderTracker();
  });

  // Recalculate
  document.getElementById('recalcBtn').addEventListener('click', () => {
    loadTrackerData(true);
  });

  // Refresh
  document.getElementById('refreshBtn').addEventListener('click', () => {
    loadTrackerData();
  });
}

async function loadTrackerData(forceRefresh) {
  const container = document.getElementById('trackerContent');
  container.innerHTML = '<div class="loading">Loading completion tracker...</div>';
  try {
    const url = '/api/workflow/completion-tracker' + (forceRefresh ? '?refresh=1' : '');
    const resp = await fetch(url);
    trackerData = await resp.json();
    if (trackerData.error) {
      container.innerHTML = '<div class="loading" style="color:#ef4444">Error: ' + trackerData.error + '</div>';
      return;
    }
    updateStatusCards();
    renderApCards();
    renderTracker();
    document.getElementById('trackerMeta').textContent = 'Generated: ' + (trackerData.generated_at || '');
  } catch (e) {
    container.innerHTML = '<div class="loading" style="color:#ef4444">Failed to load: ' + e.message + '</div>';
  }
}

function updateStatusCards() {
  if (!trackerData) return;
  const s = trackerData.summary.by_status;
  document.getElementById('ctVeryLate').textContent = s.VERY_LATE || 0;
  document.getElementById('ctLate').textContent = s.LATE || 0;
  document.getElementById('ctSlightlyLate').textContent = s.SLIGHTLY_LATE || 0;
  document.getElementById('ctDueSoon').textContent = s.DUE_SOON || 0;
  document.getElementById('ctOnTrack').textContent = s.ON_TRACK || 0;
  document.getElementById('ctComplete').textContent = s.COMPLETE || 0;
  document.getElementById('ctAll').textContent = trackerData.summary.total_account_months || 0;

  // Overall progress bar
  const pct = trackerData.summary.percentage || 0;
  const bar = document.getElementById('overallBar');
  bar.style.width = pct + '%';
  bar.className = 'bar-fill ' + (pct >= 90 ? 'green' : pct >= 50 ? 'yellow' : 'red');
  document.getElementById('overallPct').textContent = pct + '%';
}

function renderApCards() {
  if (!trackerData) return;
  const container = document.getElementById('apCards');
  const apList = trackerData.ap_summary || [];
  let html = '';
  for (const ap of apList) {
    const healthClass = ap.percentage >= 90 ? 'health-green' : ap.percentage >= 50 ? 'health-yellow' : 'health-red';
    const isActive = activeAp === ap.ap_name;
    html += `<div class="ap-card ${healthClass} ${isActive ? 'active' : ''}" data-ap="${ap.ap_name}" onclick="toggleApFilter('${ap.ap_name.replace(/'/g, "\\'")}')" title="${ap.complete}/${ap.total} complete (${ap.percentage}%)">
      <div class="ap-name">${ap.ap_name}</div>
      <div class="ap-count">${ap.total} acct-months | ${ap.percentage}%</div>
    </div>`;
  }
  container.innerHTML = html;
}

function toggleApFilter(apName) {
  if (activeAp === apName) {
    activeAp = null;
  } else {
    activeAp = apName;
  }
  // Update AP card active states
  document.querySelectorAll('#apCards .ap-card').forEach(c => {
    c.classList.toggle('active', c.dataset.ap === activeAp);
  });
  renderTracker();
}

function renderTracker() {
  if (!trackerData) return;
  const container = document.getElementById('trackerContent');
  const properties = trackerData.properties || [];

  // Filter properties
  let filtered = properties;

  // AP filter
  if (activeAp) {
    filtered = filtered.filter(p => (p.ap_name || 'Unassigned') === activeAp);
  }

  // Search filter (applied to property name, vendor names, account numbers)
  if (searchText) {
    filtered = filtered.filter(p => {
      const pMatch = (p.property_name || '').toLowerCase().includes(searchText);
      const itemMatch = (p.items || []).some(it =>
        (it.vendor_name || '').toLowerCase().includes(searchText) ||
        (it.account_number || '').toLowerCase().includes(searchText)
      );
      return pMatch || itemMatch;
    });
  }

  // For each property, filter items by status if active
  // Also compute filtered counts
  let filteredProps = filtered.map(p => {
    let items = p.items || [];
    if (activeStatus && activeStatus !== 'ALL') {
      items = items.filter(it => it.status_label === activeStatus);
    }
    if (searchText) {
      items = items.filter(it =>
        (it.vendor_name || '').toLowerCase().includes(searchText) ||
        (it.account_number || '').toLowerCase().includes(searchText) ||
        (p.property_name || '').toLowerCase().includes(searchText)
      );
    }
    if (items.length === 0) return null;
    const complete = items.filter(it => it.status_label === 'COMPLETE').length;
    const total = items.length;
    return { ...p, items, complete_filtered: complete, total_filtered: total,
             percentage_filtered: total ? Math.round(100 * complete / total * 10) / 10 : 0 };
  }).filter(Boolean);

  // Sort: lowest completion first
  filteredProps.sort((a, b) => a.percentage_filtered - b.percentage_filtered || a.property_name.localeCompare(b.property_name));

  if (filteredProps.length === 0) {
    container.innerHTML = '<div class="loading">No properties match current filters.</div>';
    return;
  }

  let html = `<div style="font-size:13px;font-weight:600;margin-bottom:12px;color:#fff">${filteredProps.length} Properties</div><div class="property-grid">`;

  for (const prop of filteredProps) {
    const pct = prop.percentage_filtered;
    const statusClass = pct >= 100 ? 'complete' : pct > 0 ? 'partial' : 'missing';
    const barClass = pct >= 100 ? 'progress-green' : pct > 0 ? 'progress-yellow' : 'progress-red';

    html += `<div class="property-card ${statusClass}" ondblclick="toggleExpand(this)" title="Double-click to expand/collapse">
      <div class="property-name">${prop.property_name || prop.property_id}</div>
      ${prop.ap_name ? `<div class="property-ap">${prop.ap_name}</div>` : ''}
      <div class="property-stats">
        <span>${prop.complete_filtered}/${prop.total_filtered} complete</span>
        <span style="font-weight:700;color:${pct >= 100 ? '#10b981' : pct > 0 ? '#f59e0b' : '#ef4444'}">${pct}%</span>
      </div>
      <div class="progress-bar"><div class="progress-fill ${barClass}" style="width:${pct}%"></div></div>
      <div class="account-list">`;

    // Sort items: missing first (most overdue first), then complete
    const sorted = prop.items.slice().sort((a, b) => {
      const aComplete = a.status_label === 'COMPLETE' ? 1 : 0;
      const bComplete = b.status_label === 'COMPLETE' ? 1 : 0;
      if (aComplete !== bComplete) return aComplete - bComplete;
      if (!aComplete) return b.days_overdue - a.days_overdue; // most overdue first
      return a.vendor_name.localeCompare(b.vendor_name);
    });

    for (const item of sorted) {
      const isComplete = item.status_label === 'COMPLETE';
      let icon, iconClass;
      if (isComplete) {
        icon = '&#10003;'; iconClass = 'ok';
      } else if (item.status_label === 'DUE_SOON' || item.status_label === 'ON_TRACK') {
        icon = '&#9711;'; iconClass = 'wait';
      } else {
        icon = '&#10007;'; iconClass = 'miss';
      }

      const stageTag = item.pipeline_stage ? `<span class="stage-tag">${item.pipeline_stage}</span>` : '';
      const scraperTag = item.in_scraper ? '<span class="scraper-tag">SCR</span>' : '';

      // Month display: convert "02/2026" to "FEB 2026"
      const monthDisplay = formatMonth(item.month);

      html += `<div class="account-item">
        <div class="acct-info">
          <div class="acct-label">${item.vendor_name || 'Unknown'} - ${item.account_number}${scraperTag}</div>
        </div>
        <span class="month-badge ${item.status_label}">${monthDisplay}</span>
        ${stageTag}
        <span class="status-icon ${iconClass}">${icon}</span>
      </div>`;
    }

    html += `</div></div>`;
  }

  html += '</div>';
  container.innerHTML = html;
}

function toggleExpand(el) {
  el.classList.toggle('expanded');
}

function formatMonth(monthStr) {
  if (!monthStr) return '';
  const months = ['JAN','FEB','MAR','APR','MAY','JUN','JUL','AUG','SEP','OCT','NOV','DEC'];
  // Handle range format "MM/YYYY-MM/YYYY" for multi-month billing cycles
  if (monthStr.includes('-')) {
    const [start, end] = monthStr.split('-');
    return formatMonth(start) + '-' + formatMonth(end);
  }
  const parts = monthStr.split('/');
  if (parts.length !== 2) return monthStr;
  const idx = parseInt(parts[0], 10) - 1;
  return (months[idx] || parts[0]) + ' ' + parts[1];
}


/* ======== LATE BILLS TABLE TAB ======== */

function initLateBillsEvents() {
  // Search
  document.getElementById('searchBox').addEventListener('input', () => { applyTableFilters(); });
  document.getElementById('filterHasNote').addEventListener('change', () => { filterState.hasNote = document.getElementById('filterHasNote').checked; applyTableFilters(); });

  // Summary card clicks (Late Bills tab)
  document.querySelectorAll('#summaryCards .summary-card').forEach(card => {
    card.addEventListener('click', () => {
      const status = card.dataset.status;
      if (filterState.status === status) {
        filterState.status = null;
        card.classList.remove('active');
      } else {
        document.querySelectorAll('#summaryCards .summary-card').forEach(c => c.classList.remove('active'));
        filterState.status = status;
        card.classList.add('active');
      }
      applyTableFilters();
    });
  });

  // Recalculate
  document.getElementById('tableRecalcBtn').addEventListener('click', () => triggerRecalculate());
  document.getElementById('tableRefreshBtn').addEventListener('click', () => loadLateBillsData());

  // Drawer
  document.getElementById('openDrawer').addEventListener('click', () => {
    document.getElementById('drawer').style.right = '0';
    document.getElementById('drawerMask').style.opacity = '1';
    document.getElementById('drawerMask').style.pointerEvents = 'auto';
  });
  document.getElementById('closeDrawer').addEventListener('click', closeDrawer);
  document.getElementById('drawerMask').addEventListener('click', closeDrawer);
  document.getElementById('drawerApply').addEventListener('click', () => { applyDrawerFilters(); closeDrawer(); });
  document.getElementById('drawerClear').addEventListener('click', clearDrawerFilters);

  // Select all
  document.getElementById('selectAll').addEventListener('change', e => {
    const checked = e.target.checked;
    filteredData.forEach(r => checked ? selectedKeys.add(r.accountKey) : selectedKeys.delete(r.accountKey));
    renderTable();
    updateBulkToolbar();
  });

  // Bulk toolbar
  document.getElementById('bulkDeselectBtn').addEventListener('click', () => {
    selectedKeys.clear();
    document.getElementById('selectAll').checked = false;
    renderTable();
    updateBulkToolbar();
  });

  // Note modal
  document.getElementById('noteSave').addEventListener('click', saveNote);
  document.getElementById('noteClear').addEventListener('click', clearNote);
}

function closeDrawer() {
  document.getElementById('drawer').style.right = '-420px';
  document.getElementById('drawerMask').style.opacity = '0';
  document.getElementById('drawerMask').style.pointerEvents = 'none';
}

async function loadLateBillsData() {
  lateBillsLoaded = true;
  document.getElementById('tableBody').innerHTML = '<tr><td colspan="14" class="loading">Loading...</td></tr>';
  try {
    const resp = await fetch('/api/workflow');
    const data = await resp.json();
    allData = data.rows || [];
    reasonCodes = (data.filters || {}).reasonCodes || [];

    // Populate drawer filters
    populateDrawerFilters(data.filters || {});
    // Populate note reason codes
    populateReasonCodes();

    if (data.cacheStatus === 'empty') {
      document.getElementById('tableBody').innerHTML = '<tr><td colspan="14" class="loading">Cache empty. Click Recalculate to generate data.</td></tr>';
      return;
    }

    document.getElementById('lastUpdated').textContent = data.computedAt ? 'Updated: ' + data.computedAt : '';
    applyTableFilters();

    // Load catalogs for edit modal
    loadCatalogs();
  } catch (e) {
    document.getElementById('tableBody').innerHTML = '<tr><td colspan="14" class="loading" style="color:#ef4444">Error: ' + e.message + '</td></tr>';
  }
}

function populateDrawerFilters(filters) {
  const statuses = ['VERY_LATE', 'LATE', 'SLIGHTLY_LATE', 'DUE_SOON', 'ON_TRACK'];
  const statusContainer = document.getElementById('drawerStatusFilters');
  statusContainer.innerHTML = statuses.map(s => `<label style="display:flex;align-items:center;gap:6px;font-size:12px"><input type="checkbox" value="${s}" checked /> ${s.replace(/_/g,' ')}</label>`).join('');

  const apContainer = document.getElementById('drawerApFilters');
  apContainer.innerHTML = (filters.apReps || []).map(a => `<label style="display:flex;align-items:center;gap:6px;font-size:12px"><input type="checkbox" value="${a}" checked /> ${a}</label>`).join('');

  const propContainer = document.getElementById('drawerPropFilters');
  propContainer.innerHTML = (filters.properties || []).map(p => `<label style="display:flex;align-items:center;gap:6px;font-size:12px"><input type="checkbox" value="${p.id}" checked /> ${p.name}</label>`).join('');

  const vendorContainer = document.getElementById('drawerVendorFilters');
  vendorContainer.innerHTML = (filters.vendors || []).map(v => `<label style="display:flex;align-items:center;gap:6px;font-size:12px"><input type="checkbox" value="${v.id}" checked /> ${v.name}</label>`).join('');

  // Search within drawer
  document.getElementById('drawerPropSearch').addEventListener('input', e => {
    const q = e.target.value.toLowerCase();
    propContainer.querySelectorAll('label').forEach(l => {
      l.style.display = l.textContent.toLowerCase().includes(q) ? '' : 'none';
    });
  });
  document.getElementById('drawerVendorSearch').addEventListener('input', e => {
    const q = e.target.value.toLowerCase();
    vendorContainer.querySelectorAll('label').forEach(l => {
      l.style.display = l.textContent.toLowerCase().includes(q) ? '' : 'none';
    });
  });
}

function populateReasonCodes() {
  const sel = document.getElementById('noteReasonCode');
  sel.innerHTML = '<option value="">-- Select --</option>';
  for (const rc of reasonCodes) {
    sel.innerHTML += `<option value="${rc}">${rc}</option>`;
  }
}

function applyDrawerFilters() {
  // Read checked values from drawer
  filterState.ap = [...document.querySelectorAll('#drawerApFilters input:checked')].map(i => i.value);
  filterState.properties = [...document.querySelectorAll('#drawerPropFilters input:checked')].map(i => i.value);
  filterState.vendors = [...document.querySelectorAll('#drawerVendorFilters input:checked')].map(i => i.value);
  filterState.sort = document.getElementById('sortBy').value;
  applyTableFilters();
}

function clearDrawerFilters() {
  document.querySelectorAll('#drawer input[type=checkbox]').forEach(i => i.checked = true);
  document.getElementById('sortBy').value = 'urgency';
  filterState = {status: null, ap: [], properties: [], vendors: [], hasNote: false, sort: 'urgency'};
  applyTableFilters();
}

function applyTableFilters() {
  const search = document.getElementById('searchBox').value.toLowerCase();
  filteredData = allData.filter(r => {
    if (filterState.status && r.status !== filterState.status) return false;
    if (filterState.hasNote && !r.hasNote) return false;
    if (search) {
      const hay = (r.propertyName + ' ' + r.vendorName + ' ' + r.accountNumber + ' ' + r.apName).toLowerCase();
      if (!hay.includes(search)) return false;
    }
    if (filterState.ap.length && !filterState.ap.includes(r.apName)) return false;
    if (filterState.properties.length && !filterState.properties.includes(r.propertyId)) return false;
    if (filterState.vendors.length && !filterState.vendors.includes(r.vendorId)) return false;
    return true;
  });

  // Sort
  const sortKey = filterState.sort || 'urgency';
  filteredData.sort((a, b) => {
    if (sortKey === 'urgency') return (-a.urgencyScore + b.urgencyScore) || (-a.daysOverdue + b.daysOverdue);
    if (sortKey === 'daysOverdue') return -a.daysOverdue + b.daysOverdue;
    const av = a[sortKey] || '', bv = b[sortKey] || '';
    return typeof av === 'string' ? av.localeCompare(bv) : av - bv;
  });

  updateTableSummary();
  renderTable();
}

function updateTableSummary() {
  let counts = {VERY_LATE:0, LATE:0, SLIGHTLY_LATE:0, DUE_SOON:0, ON_TRACK:0};
  filteredData.forEach(r => { if (counts[r.status] !== undefined) counts[r.status]++; });
  document.getElementById('countVeryLate').textContent = counts.VERY_LATE;
  document.getElementById('countLate').textContent = counts.LATE;
  document.getElementById('countSlightlyLate').textContent = counts.SLIGHTLY_LATE;
  document.getElementById('countDueSoon').textContent = counts.DUE_SOON;
  document.getElementById('countOnTrack').textContent = counts.ON_TRACK;
}

function escapeHtml(s) {
  return String(s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function escapeJs(s) {
  return String(s || '').replace(/\\/g,'\\\\').replace(/'/g,"\\'").replace(/"/g,'\\"');
}

function renderTable() {
  const tbody = document.getElementById('tableBody');
  if (!filteredData.length) {
    tbody.innerHTML = '<tr><td colspan="14" class="loading">No matching accounts.</td></tr>';
    return;
  }
  let html = '';
  for (const r of filteredData) {
    const checked = selectedKeys.has(r.accountKey) ? 'checked' : '';
    const noteIcon = r.hasNote ? '<span title="Has note" style="cursor:pointer">&#128221;</span>' : '<span style="opacity:.3;cursor:pointer">&#10133;</span>';
    const statusBadge = `<span style="display:inline-block;padding:4px 10px;border-radius:12px;font-size:11px;font-weight:600" class="status-${r.status}">${r.status.replace(/_/g,' ')}</span>`;
    const daysClass = r.daysOverdue > 0 ? 'positive' : 'negative';
    const scraperBadge = r.hasScraper ? '<span style="background:#dcfce7;color:#166534;padding:2px 6px;border-radius:4px;font-size:10px;font-weight:700">SCR</span>' : '';
    const viewLink = r.lastBillKeyDate ? `<a href="/invoices?date=${r.lastBillKeyDate}#${r.lastBillPdfId}" target="_blank" style="color:#0284c7;text-decoration:none;font-size:12px;font-weight:600">View</a>` : '';
    const dupBadge = r.isDuplicate ? `<span style="background:#fef3c7;color:#92400e;padding:1px 5px;border-radius:4px;font-size:10px;font-weight:700;margin-left:5px;cursor:help" title="${escapeHtml((r.duplicateOf||[]).join(', '))}">DUP</span>` : '';
    const rowClass = r.hasNote ? ' style="background:rgba(251,191,36,0.1)"' : '';

    html += `<tr${rowClass}>
      <td style="padding:10px 12px;border-bottom:1px solid #e5e7eb;font-size:12px"><input type="checkbox" class="row-select" ${checked} onchange="toggleSelect('${escapeJs(r.accountKey)}', this.checked)" style="width:16px;height:16px;cursor:pointer;accent-color:#0ea5e9" /></td>
      <td style="padding:10px 12px;border-bottom:1px solid #e5e7eb;font-size:12px"><span onclick="openNoteModal('${escapeJs(r.accountKey)}','${escapeJs(r.propertyName)}','${escapeJs(r.vendorName)}','${escapeJs(r.accountNumber)}')" style="cursor:pointer">${noteIcon}</span></td>
      <td style="padding:10px 12px;border-bottom:1px solid #e5e7eb;font-size:12px"><span onclick="openEditModal('${escapeJs(r.accountKey)}','${escapeJs(r.propertyId)}','${escapeJs(r.propertyName)}','${escapeJs(r.vendorId)}','${escapeJs(r.vendorName)}','${escapeJs(r.accountNumber)}')" style="cursor:pointer;opacity:.5" onmouseover="this.style.opacity=1" onmouseout="this.style.opacity=.5">&#9998;</span></td>
      <td style="padding:10px 12px;border-bottom:1px solid #e5e7eb;font-size:12px">${statusBadge}</td>
      <td style="padding:10px 12px;border-bottom:1px solid #e5e7eb;font-size:12px">${escapeHtml(r.propertyName)}</td>
      <td style="padding:10px 12px;border-bottom:1px solid #e5e7eb;font-size:12px">${escapeHtml(r.vendorName)}</td>
      <td style="padding:10px 12px;border-bottom:1px solid #e5e7eb;font-size:12px"><span style="cursor:pointer;border-bottom:1px dashed #94a3b8" onclick="navigator.clipboard.writeText('${escapeJs(r.accountNumber)}');showToast('Copied!','ok')" title="Click to copy">${escapeHtml(r.accountNumber)}</span>${dupBadge}</td>
      <td style="padding:10px 12px;border-bottom:1px solid #e5e7eb;font-size:12px">${escapeHtml(r.apName)}</td>
      <td style="padding:10px 12px;border-bottom:1px solid #e5e7eb;font-size:12px">${r.nextExpectedDate || ''}</td>
      <td style="padding:10px 12px;border-bottom:1px solid #e5e7eb;font-size:12px;font-weight:600;color:${r.daysOverdue > 0 ? '#b91c1c' : '#166534'}">${r.daysOverdue}</td>
      <td style="padding:10px 12px;border-bottom:1px solid #e5e7eb;font-size:12px">${r.lastBillDate || ''}</td>
      <td style="padding:10px 12px;border-bottom:1px solid #e5e7eb;font-size:12px">${viewLink}</td>
      <td style="padding:10px 12px;border-bottom:1px solid #e5e7eb;font-size:12px">${r.servicePeriodDays || ''}</td>
      <td style="padding:10px 12px;border-bottom:1px solid #e5e7eb;font-size:12px">${scraperBadge}</td>
    </tr>`;
  }
  tbody.innerHTML = html;
}

function toggleSelect(key, checked) {
  if (checked) selectedKeys.add(key); else selectedKeys.delete(key);
  updateBulkToolbar();
}

function updateBulkToolbar() {
  const toolbar = document.getElementById('bulkToolbar');
  const count = selectedKeys.size;
  document.getElementById('selCount').textContent = count + ' selected';
  toolbar.style.bottom = count > 0 ? '24px' : '-70px';
}

/* Note modal */
let currentNoteKey = '';
function openNoteModal(accountKey, propName, vendorName, acctNum) {
  currentNoteKey = accountKey;
  document.getElementById('noteAccountInfo').textContent = `${propName} / ${vendorName} / ${acctNum}`;
  const existing = allData.find(r => r.accountKey === accountKey);
  const note = existing && existing.note;
  document.getElementById('noteReasonCode').value = (note && note.reasonCode) || '';
  document.getElementById('noteText').value = (note && note.notes) || '';
  document.getElementById('noteModal').style.display = 'flex';
}

async function saveNote() {
  const fd = new FormData();
  fd.append('accountKey', currentNoteKey);
  fd.append('reasonCode', document.getElementById('noteReasonCode').value);
  fd.append('notes', document.getElementById('noteText').value);
  try {
    const resp = await fetch('/api/workflow/notes', {method:'POST', body:fd});
    const data = await resp.json();
    if (data.ok) {
      showToast('Note saved', 'ok');
      document.getElementById('noteModal').style.display = 'none';
      // Update in-memory
      const row = allData.find(r => r.accountKey === currentNoteKey);
      if (row) {
        row.note = {reasonCode: document.getElementById('noteReasonCode').value, notes: document.getElementById('noteText').value};
        row.hasNote = true;
      }
      applyTableFilters();
    } else {
      showToast('Error saving note', 'err');
    }
  } catch (e) {
    showToast('Error: ' + e.message, 'err');
  }
}

async function clearNote() {
  const fd = new FormData();
  fd.append('accountKey', currentNoteKey);
  fd.append('clear', '1');
  try {
    await fetch('/api/workflow/notes', {method:'POST', body:fd});
    showToast('Note cleared', 'ok');
    document.getElementById('noteModal').style.display = 'none';
    const row = allData.find(r => r.accountKey === currentNoteKey);
    if (row) { row.note = null; row.hasNote = false; }
    applyTableFilters();
  } catch (e) {
    showToast('Error: ' + e.message, 'err');
  }
}

/* Edit modal */
let currentEditKey = '';
let currentEditProp = '';
let currentEditVendor = '';

function openEditModal(accountKey, propId, propName, vendorId, vendorName, acctNum) {
  currentEditKey = accountKey;
  currentEditProp = propId;
  currentEditVendor = vendorId;
  document.getElementById('editAccountInfo').textContent = `${acctNum}  ${propName} / ${vendorName}`;
  document.getElementById('editModal').style.display = 'flex';
  renderEditPropList();
  renderEditVendorList();
}

async function loadCatalogs() {
  try {
    const [propResp, vendResp] = await Promise.all([
      fetch('/api/properties'),
      fetch('/api/vendors')
    ]);
    catalogProperties = await propResp.json();
    catalogVendors = await vendResp.json();
  } catch (e) { /* non-fatal */ }
}

function renderEditPropList() {
  const search = (document.getElementById('editPropSearch').value || '').toLowerCase();
  const list = document.getElementById('editPropList');
  const filtered = catalogProperties.filter(p => !search || (p.name || '').toLowerCase().includes(search));
  list.innerHTML = filtered.slice(0, 50).map(p =>
    `<div style="padding:10px 12px;cursor:pointer;border-bottom:1px solid #f1f5f9;font-size:13px${p.id === currentEditProp ? ';background:#dbeafe;font-weight:600' : ''}" onclick="currentEditProp='${p.id}';renderEditPropList()" onmouseover="this.style.background='#f0f9ff'" onmouseout="this.style.background='${p.id === currentEditProp ? '#dbeafe' : ''}'">${escapeHtml(p.name)}</div>`
  ).join('');
  document.getElementById('editPropSearch').oninput = () => renderEditPropList();
}

function renderEditVendorList() {
  const search = (document.getElementById('editVendorSearch').value || '').toLowerCase();
  const list = document.getElementById('editVendorList');
  const filtered = catalogVendors.filter(v => !search || (v.name || '').toLowerCase().includes(search));
  list.innerHTML = filtered.slice(0, 50).map(v =>
    `<div style="padding:10px 12px;cursor:pointer;border-bottom:1px solid #f1f5f9;font-size:13px${v.id === currentEditVendor ? ';background:#dbeafe;font-weight:600' : ''}" onclick="currentEditVendor='${v.id}';renderEditVendorList()" onmouseover="this.style.background='#f0f9ff'" onmouseout="this.style.background='${v.id === currentEditVendor ? '#dbeafe' : ''}'">${escapeHtml(v.name)}</div>`
  ).join('');
  document.getElementById('editVendorSearch').oninput = () => renderEditVendorList();
}

document.getElementById('editSave')?.addEventListener('click', async () => {
  const fd = new FormData();
  fd.append('accountKey', currentEditKey);
  fd.append('propertyId', currentEditProp);
  fd.append('vendorId', currentEditVendor);
  try {
    const resp = await fetch('/api/workflow/accounts/update', {method:'POST', body:fd});
    const data = await resp.json();
    if (data.ok) {
      showToast('Account updated', 'ok');
      document.getElementById('editModal').style.display = 'none';
      loadLateBillsData();
    } else {
      showToast(data.error || 'Error', 'err');
    }
  } catch (e) {
    showToast('Error: ' + e.message, 'err');
  }
});

document.getElementById('editDelete')?.addEventListener('click', async () => {
  if (!confirm('Delete this account from tracking?')) return;
  const fd = new FormData();
  fd.append('accountKey', currentEditKey);
  fd.append('action', 'archive');
  try {
    const resp = await fetch('/api/workflow/accounts/archive', {method:'POST', body:fd});
    const data = await resp.json();
    if (data.ok) {
      showToast('Account archived', 'ok');
      document.getElementById('editModal').style.display = 'none';
      loadLateBillsData();
    } else {
      showToast(data.error || 'Error', 'err');
    }
  } catch (e) {
    showToast('Error: ' + e.message, 'err');
  }
});

/* Recalculate */
async function triggerRecalculate() {
  document.getElementById('tableRecalcBtn').disabled = true;
  document.getElementById('tableRecalcBtn').textContent = 'Recalculating...';
  showToast('Recalculation started...', 'ok');
  try {
    await fetch('/api/workflow/recalculate', {method:'POST'});
    // Poll for completion
    let attempts = 0;
    const poll = setInterval(async () => {
      attempts++;
      try {
        const resp = await fetch('/api/workflow');
        const data = await resp.json();
        if (data.computedAt || attempts > 30) {
          clearInterval(poll);
          document.getElementById('tableRecalcBtn').disabled = false;
          document.getElementById('tableRecalcBtn').textContent = 'Recalculate';
          if (data.computedAt) {
            showToast('Recalculation complete!', 'ok');
            allData = data.rows || [];
            applyTableFilters();
            document.getElementById('lastUpdated').textContent = 'Updated: ' + data.computedAt;
          }
        }
      } catch (e) { /* keep polling */ }
    }, 3000);
  } catch (e) {
    showToast('Recalculation error: ' + e.message, 'err');
    document.getElementById('tableRecalcBtn').disabled = false;
    document.getElementById('tableRecalcBtn').textContent = 'Recalculate';
  }
}
</script>
</body>
</html>
