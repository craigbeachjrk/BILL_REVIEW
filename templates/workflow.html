<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WORKFLOW</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root { --bg:#0ea5e9; --bg2:#4338ca; --glass:rgba(255,255,255,.72); --border:rgba(255,255,255,.33); }
    body{font-family:Inter,system-ui,sans-serif;margin:0;background:linear-gradient(135deg,var(--bg),var(--bg2));min-height:100vh;color:#0f172a}
    header.top{position:sticky;top:0;display:flex;justify-content:space-between;align-items:center;padding:14px 20px;color:#fff;z-index:100}
    .btn{display:inline-block;padding:8px 12px;border-radius:10px;border:none;background:#0ea5e9;color:#fff;cursor:pointer;text-decoration:none;font-size:13px;font-family:inherit}
    .btn.secondary{background:#64748b}
    .btn.danger{background:#dc2626}
    .btn.success{background:#059669}
    .btn.small{padding:4px 8px;font-size:11px}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .wrap{max-width:1800px;margin:0 auto;padding:0 20px 40px}
    h1{margin:0 0 16px 0;color:#fff}

    /* Summary Cards */
    .summary-cards{display:flex;gap:12px;margin-bottom:20px;flex-wrap:wrap;align-items:center}
    .summary-card{background:var(--glass);backdrop-filter:blur(10px);border:1px solid var(--border);border-radius:12px;padding:12px 20px;min-width:110px;text-align:center;cursor:pointer;transition:transform .1s,outline .1s}
    .summary-card:hover{transform:translateY(-2px)}
    .summary-card.active{outline:3px solid #fff;box-shadow:0 4px 16px rgba(0,0,0,.2)}
    .summary-card .count{font-size:28px;font-weight:700;display:block}
    .summary-card .label{font-size:11px;opacity:.8}
    .summary-card.very-late .count{color:#b91c1c}
    .summary-card.late .count{color:#c2410c}
    .summary-card.slightly-late .count{color:#a16207}
    .summary-card.due-soon .count{color:#1d4ed8}
    .summary-card.on-track .count{color:#166534}
    .summary-card.complete .count{color:#059669}
    .summary-card.all-card .count{color:#334155}

    /* Overall progress area */
    .overall-progress{display:flex;align-items:center;gap:16px;margin-left:auto;padding:8px 0}
    .overall-progress .pct{font-size:22px;font-weight:700;color:#fff}
    .overall-progress .bar-wrap{width:180px;height:10px;background:rgba(255,255,255,.3);border-radius:5px;overflow:hidden}
    .overall-progress .bar-fill{height:100%;border-radius:5px;transition:width .5s}
    .overall-progress .bar-fill.green{background:#10b981}
    .overall-progress .bar-fill.yellow{background:#f59e0b}
    .overall-progress .bar-fill.red{background:#ef4444}

    /* AP Cards */
    .ap-cards{display:flex;gap:10px;margin-bottom:20px;flex-wrap:wrap}
    .ap-card{background:var(--glass);backdrop-filter:blur(10px);border:2px solid var(--border);border-radius:12px;padding:10px 18px;min-width:120px;text-align:center;cursor:pointer;transition:transform .1s,outline .1s}
    .ap-card:hover{transform:translateY(-2px)}
    .ap-card.active{outline:3px solid #fff;box-shadow:0 4px 16px rgba(0,0,0,.2)}
    .ap-card .ap-name{font-size:13px;font-weight:700}
    .ap-card .ap-count{font-size:11px;opacity:.7;margin-top:2px}
    .ap-card.health-green{border-color:#10b981;background:rgba(16,185,129,.15)}
    .ap-card.health-yellow{border-color:#f59e0b;background:rgba(245,158,11,.15)}
    .ap-card.health-red{border-color:#ef4444;background:rgba(239,68,68,.15)}

    /* Toolbar */
    .toolbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;gap:12px;flex-wrap:wrap}
    .toolbar-left{display:flex;gap:8px;align-items:center}
    .toolbar-right{display:flex;gap:8px;align-items:center}
    .search-box{padding:8px 12px;border:1px solid #e5e7eb;border-radius:8px;width:320px;font-size:13px}

    /* Property Cards Grid */
    .property-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(340px,1fr));gap:14px}
    .property-card{background:#fff;border-radius:12px;padding:14px;border:2px solid #e5e7eb;cursor:pointer;transition:all .2s}
    .property-card:hover{box-shadow:0 4px 16px rgba(0,0,0,.1);transform:translateY(-1px)}
    .property-card.complete{border-color:#10b981;background:#f0fdf4}
    .property-card.partial{border-color:#f59e0b;background:#fffbeb}
    .property-card.missing{border-color:#ef4444;background:#fef2f2}
    .property-name{font-weight:700;font-size:14px;margin-bottom:2px}
    .property-ap{font-size:11px;color:#7c3aed;font-weight:500;margin-bottom:6px}
    .property-stats{display:flex;justify-content:space-between;align-items:center;font-size:12px;color:#64748b;margin-bottom:6px}
    .progress-bar{height:6px;background:#e5e7eb;border-radius:3px;overflow:hidden}
    .progress-fill{height:100%;border-radius:3px;transition:width .5s}
    .progress-green{background:#10b981}
    .progress-yellow{background:#f59e0b}
    .progress-red{background:#ef4444}

    /* Account Items inside property card */
    .account-list{display:none;margin-top:10px;border-top:1px solid #e5e7eb;padding-top:8px}
    .property-card.expanded .account-list{display:block}
    .account-item{display:flex;align-items:center;gap:8px;padding:5px 8px;border-radius:6px;font-size:12px;transition:background .15s}
    .account-item:hover{background:#f1f5f9}
    .account-item .acct-info{flex:1;min-width:0}
    .account-item .acct-label{font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .month-badge{display:inline-block;padding:2px 7px;border-radius:8px;font-size:10px;font-weight:700;white-space:nowrap}
    .month-badge.VERY_LATE{background:#fecaca;color:#b91c1c}
    .month-badge.LATE{background:#fed7aa;color:#c2410c}
    .month-badge.SLIGHTLY_LATE{background:#fef08a;color:#a16207}
    .month-badge.DUE_SOON{background:#bfdbfe;color:#1d4ed8}
    .month-badge.ON_TRACK{background:#e2e8f0;color:#475569}
    .month-badge.COMPLETE{background:#bbf7d0;color:#166534}
    .status-icon{font-size:14px;font-weight:700;min-width:18px;text-align:center}
    .status-icon.miss{color:#ef4444}
    .status-icon.wait{color:#3b82f6}
    .status-icon.ok{color:#10b981}
    .stage-tag{font-size:9px;padding:1px 5px;border-radius:4px;background:#e0f2fe;color:#0369a1;font-weight:600;margin-left:4px}
    .scraper-tag{font-size:9px;padding:1px 4px;border-radius:3px;background:#7c3aed;color:#fff;font-weight:600;margin-left:4px}

    /* Toast */
    .toast{position:fixed;top:20px;right:20px;background:#111827;color:#fff;padding:12px 16px;border-radius:10px;box-shadow:0 8px 20px rgba(0,0,0,.25);z-index:60;opacity:0;transition:opacity .3s}
    .toast.show{opacity:.96}
    .toast.ok{background:#0f766e}
    .toast.err{background:#b91c1c}

    /* Loading */
    .loading{text-align:center;padding:60px;color:#64748b;font-size:14px}

    /* Tabs */
    .tab-bar{display:flex;gap:4px;margin-bottom:20px}
    .tab-btn{padding:12px 24px;background:rgba(255,255,255,0.3);border:none;border-radius:12px 12px 0 0;cursor:pointer;font-weight:600;font-size:14px;color:#fff;transition:all 0.15s}
    .tab-btn:hover{background:rgba(255,255,255,0.4)}
    .tab-btn.active{background:var(--glass);color:#0f172a}
    .tab-content{display:none}
    .tab-content.active{display:block}

    /* Generated timestamp */
    .meta-info{color:rgba(255,255,255,.6);font-size:11px}

    /* ===== Weekly Targets Row ===== */
    .weekly-targets{display:flex;gap:12px;margin-bottom:16px;flex-wrap:wrap;align-items:center}
    .weekly-target-card{background:var(--glass);backdrop-filter:blur(10px);border:1px solid var(--border);border-radius:12px;padding:10px 16px;min-width:160px;text-align:center}
    .weekly-target-card .wt-name{font-size:13px;font-weight:700;margin-bottom:4px}
    .weekly-target-card .wt-nums{font-size:20px;font-weight:700}
    .weekly-target-card .wt-pct{font-size:11px;opacity:.8;margin-top:2px}
    .weekly-target-card .wt-bar{height:5px;background:rgba(0,0,0,.1);border-radius:3px;overflow:hidden;margin-top:4px}
    .weekly-target-card .wt-bar-fill{height:100%;border-radius:3px;transition:width .3s}
    .weekly-target-card.wt-green .wt-bar-fill{background:#10b981}
    .weekly-target-card.wt-yellow .wt-bar-fill{background:#f59e0b}
    .weekly-target-card.wt-red .wt-bar-fill{background:#ef4444}

    /* ===== Directed Tab Styles ===== */
    .dir-stats-ribbon{display:flex;gap:12px;margin-bottom:20px;flex-wrap:wrap}
    .dir-stat-card{background:var(--glass);backdrop-filter:blur(10px);border:1px solid var(--border);border-radius:12px;padding:12px 20px;min-width:130px;text-align:center}
    .dir-stat-card .value{font-size:28px;font-weight:700;display:block}
    .dir-stat-card .label{font-size:12px;opacity:.8}
    .dir-stat-card.completed .value{color:#166534}
    .dir-stat-card.remaining .value{color:#c2410c}

    .dir-progress-wrap{margin-bottom:24px}
    .dir-progress-bar{height:8px;background:rgba(255,255,255,.3);border-radius:4px;overflow:hidden}
    .dir-progress-bar .fill{height:100%;background:#fff;border-radius:4px;transition:width .3s}
    .dir-progress-label{font-size:11px;color:#fff;opacity:.8;margin-top:4px;text-align:right}

    .dir-section-header{display:flex;align-items:center;gap:12px;padding:16px 20px;background:rgba(255,255,255,.15);border-radius:12px 12px 0 0;color:#fff;font-weight:700;font-size:15px;margin-top:20px;cursor:pointer;user-select:none}
    .dir-section-header .count{font-weight:400;font-size:12px;opacity:.7}
    .dir-section-header .arrow{transition:transform .2s}
    .dir-section-header.collapsed .arrow{transform:rotate(-90deg)}

    .dir-group-header{display:flex;align-items:center;gap:10px;padding:10px 20px;background:#f1f5f9;border-bottom:1px solid #e5e7eb;font-weight:600;font-size:13px;cursor:pointer;user-select:none}
    .dir-group-header .arrow{font-size:10px;transition:transform .2s}
    .dir-group-header.collapsed .arrow{transform:rotate(-90deg)}
    .dir-group-header .group-stats{margin-left:auto;font-weight:400;font-size:11px;color:#64748b}

    .dir-card{background:var(--glass);backdrop-filter:blur(10px);border:1px solid var(--border);border-radius:0 0 16px 16px;box-shadow:0 10px 30px rgba(0,0,0,.12);overflow:hidden;margin-bottom:0}
    .dir-task-list{background:#fff}
    .dir-task-row{display:flex;align-items:center;gap:10px;padding:10px 16px;border-bottom:1px solid #f1f5f9;font-size:12px;transition:background .1s}
    .dir-task-row:hover{background:#f0f9ff}
    .dir-task-row.active{background:#dbeafe;border-left:3px solid #2563eb}
    .dir-task-row.completed{background:#f0fdf4;opacity:.6}
    .dir-task-row.incomplete{background:#fef2f2;opacity:.6}
    .dir-task-row.vacant{color:#64748b}
    .dir-task-row.blocked{opacity:.5;border-left:3px solid #f59e0b}

    .dir-status-badge{display:inline-block;padding:3px 8px;border-radius:10px;font-size:10px;font-weight:600;white-space:nowrap}
    .dir-status-badge.status-VERY_LATE{background:#fecaca;color:#b91c1c}
    .dir-status-badge.status-LATE{background:#fed7aa;color:#c2410c}
    .dir-status-badge.status-SLIGHTLY_LATE{background:#fef08a;color:#a16207}
    .dir-status-badge.status-DUE_SOON{background:#bfdbfe;color:#1d4ed8}
    .dir-status-badge.status-ON_TRACK{background:#bbf7d0;color:#166534}

    .dir-type-badge{display:inline-block;padding:3px 8px;border-radius:10px;font-size:10px;font-weight:600}
    .dir-type-badge.collection{background:#dbeafe;color:#1d4ed8}
    .dir-type-badge.processing{background:#d1fae5;color:#059669}

    .dir-house-label{font-weight:700;color:#0f172a}
    .dir-vacant-label{font-weight:400;color:#94a3b8;font-size:10px}

    .dir-source-tag{display:inline-flex;align-items:center;gap:4px;padding:2px 8px;border-radius:8px;font-size:10px;background:#f1f5f9;color:#475569}
    .dir-source-tag.scraper{background:#d1fae5;color:#059669}
    .dir-source-tag.portal{background:#dbeafe;color:#1d4ed8}
    .dir-source-tag.mail{background:#fef3c7;color:#92400e}

    .dir-amount{font-family:monospace;font-size:11px;color:#64748b}
    .dir-task-actions{margin-left:auto;display:flex;gap:4px;flex-shrink:0}
    .dir-timer{font-family:monospace;font-size:11px;color:#64748b;min-width:50px}

    .dir-col-property{min-width:140px;max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .dir-col-account{min-width:90px;font-family:monospace;font-size:11px}
    .dir-col-vendor{min-width:100px;max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}

    .dir-eod-section{background:var(--glass);backdrop-filter:blur(10px);border:1px solid var(--border);border-radius:16px;padding:24px;margin-top:24px}
    .dir-eod-section h2{margin:0 0 16px 0;font-size:16px}
    .dir-eod-task{display:flex;align-items:flex-start;gap:12px;padding:12px 0;border-bottom:1px solid #e5e7eb}
    .dir-eod-task:last-child{border:none}
    .dir-eod-task .info{flex:1;font-size:12px}
    .dir-eod-task select{padding:6px 10px;border:1px solid #e5e7eb;border-radius:6px;font-size:12px;font-family:inherit;min-width:180px}
    .dir-eod-task textarea{width:100%;padding:6px 10px;border:1px solid #e5e7eb;border-radius:6px;font-size:12px;font-family:inherit;min-height:40px;resize:vertical;margin-top:4px}

    .dir-loading-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:50;align-items:center;justify-content:center}
    .dir-loading-overlay.show{display:flex}
    .dir-loading-box{background:#fff;border-radius:16px;padding:32px 48px;text-align:center;font-weight:600}
    .dir-spinner{display:inline-block;width:32px;height:32px;border:3px solid #e5e7eb;border-top-color:#0ea5e9;border-radius:50%;animation:spin .6s linear infinite;margin-bottom:12px}
    @keyframes spin{to{transform:rotate(360deg)}}

    .dir-drawer-mask{position:fixed;inset:0;background:rgba(0,0,0,0.38);opacity:0;pointer-events:none;transition:opacity .2s;z-index:40}
    .dir-drawer-mask.open{opacity:1;pointer-events:auto}
    .dir-drawer{position:fixed;top:0;right:-480px;width:480px;max-width:92vw;height:100vh;background:#fff;box-shadow:-8px 0 24px rgba(0,0,0,.25);transition:right .25s;z-index:41;display:flex;flex-direction:column}
    .dir-drawer.open{right:0}
    .dir-drawer header{display:flex;align-items:center;justify-content:space-between;padding:16px 18px;border-bottom:1px solid #e5e7eb}
    .dir-drawer .body{flex:1;overflow:auto;padding:16px 18px}
    .dir-history-day{margin-bottom:20px;border:1px solid #e5e7eb;border-radius:8px;overflow:hidden}
    .dir-history-day .day-header{padding:10px 14px;background:#f8fafc;font-weight:600;font-size:13px;display:flex;justify-content:space-between}
    .dir-history-day .day-body{padding:10px 14px;font-size:12px}
    .dir-history-day .incomplete-item{padding:4px 0;color:#b91c1c}

    .dir-empty-state{text-align:center;padding:60px 20px;color:#64748b}
    .dir-empty-state .icon{font-size:48px;margin-bottom:12px}
    .dir-empty-state h3{margin:0 0 8px 0;color:#334155}

    .dir-blocked-tag{display:inline-block;padding:2px 6px;border-radius:6px;font-size:9px;font-weight:600;background:#fef3c7;color:#92400e;margin-left:4px}

    /* ===== Set Targets Modal ===== */
    .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:50;align-items:center;justify-content:center}
    .modal-box{background:#fff;border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.3);max-width:500px;width:90%;max-height:90vh;overflow-y:auto;padding:24px}
  </style>
</head>
<body>
  <header class="top">
    <div><a href="/" style="text-decoration:none;color:#fff;font-weight:600">Bill Review @ JRK</a></div>
    <div style="display:flex;gap:8px;align-items:center">
      <select id="globalApFilter" style="padding:6px 10px;border-radius:8px;border:1px solid rgba(255,255,255,.4);background:rgba(255,255,255,.15);color:#fff;font-size:13px;font-family:inherit;cursor:pointer;min-width:120px">
        <option value="">All AP Reps</option>
      </select>
      {% if is_admin %}<a class="btn" href="/workflow/manage" style="background:#dc2626">Manage Accounts</a>{% endif %}
      <a class="btn" href="/workflow/manager">Manager View</a>
      <a class="btn secondary" href="/">Back</a>
    </div>
  </header>

  <div id="toast" class="toast"></div>

  <div class="wrap">
    <h1>WORKFLOW</h1>

    <!-- Weekly Targets Row -->
    <div class="weekly-targets" id="weeklyTargetsRow" style="display:none"></div>

    <!-- Tab Bar -->
    <div class="tab-bar">
      <button class="tab-btn active" data-tab="directed">Daily Work Plan</button>
      <button class="tab-btn" data-tab="tracker">Completion Tracker</button>
      <button class="tab-btn" data-tab="lateBills">Late Bills (Table)</button>
    </div>

    <!-- DAILY WORK PLAN TAB (Directed) -->
    <div class="tab-content active" id="directedTab">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
        <span id="dir_planDate" style="font-size:16px;font-weight:400;color:rgba(255,255,255,.7)"></span>
        <div style="display:flex;gap:8px">
          <button class="btn success" onclick="dir_generatePlan()">Generate Plan</button>
          <button class="btn" onclick="dir_openHistory()">History</button>
        </div>
      </div>

      <!-- Stats Ribbon -->
      <div class="dir-stats-ribbon" id="dir_statsRibbon">
        <div class="dir-stat-card"><span class="value" id="dir_statPlanned">-</span><span class="label">Planned</span></div>
        <div class="dir-stat-card completed"><span class="value" id="dir_statCompleted">-</span><span class="label">Completed</span></div>
        <div class="dir-stat-card remaining"><span class="value" id="dir_statRemaining">-</span><span class="label">Remaining</span></div>
        <div class="dir-stat-card"><span class="value" id="dir_statTime">-</span><span class="label">Est. Time Left</span></div>
      </div>

      <!-- Progress Bar -->
      <div class="dir-progress-wrap">
        <div class="dir-progress-bar"><div class="fill" id="dir_progressFill" style="width:0%"></div></div>
        <div class="dir-progress-label" id="dir_progressLabel">0% complete</div>
      </div>

      <!-- Plan Content -->
      <div id="dir_planContent"></div>

      <!-- End of Day Section -->
      <div class="dir-eod-section" id="dir_eodSection" style="display:none">
        <h2>End of Day - Incomplete Tasks</h2>
        <p style="font-size:12px;color:#64748b;margin-bottom:16px">Please select a reason for each task you weren't able to complete today.</p>
        <div id="dir_eodTasks"></div>
        <div style="margin-top:16px;display:flex;gap:8px;justify-content:flex-end">
          <button class="btn secondary" onclick="dir_cancelEod()">Cancel</button>
          <button class="btn danger" onclick="dir_submitEndOfDay()">Submit Day Summary</button>
        </div>
      </div>

      <!-- End My Day button -->
      <div style="margin-top:24px;text-align:center" id="dir_eodButtonWrap">
        <button class="btn danger" onclick="dir_showEodSection()" id="dir_eodButton" style="display:none;padding:12px 32px;font-size:14px">End My Day</button>
      </div>
    </div><!-- End Directed Tab -->

    <!-- COMPLETION TRACKER TAB -->
    <div class="tab-content" id="trackerTab">

      <!-- Row 1: Status Summary Cards + Progress -->
      <div class="summary-cards" id="statusCards">
        <div class="summary-card very-late" data-status="VERY_LATE">
          <span class="count" id="ctVeryLate">-</span>
          <span class="label">Very Late (15+)</span>
        </div>
        <div class="summary-card late" data-status="LATE">
          <span class="count" id="ctLate">-</span>
          <span class="label">Late (8-14)</span>
        </div>
        <div class="summary-card slightly-late" data-status="SLIGHTLY_LATE">
          <span class="count" id="ctSlightlyLate">-</span>
          <span class="label">Slightly Late (1-7)</span>
        </div>
        <div class="summary-card due-soon" data-status="DUE_SOON">
          <span class="count" id="ctDueSoon">-</span>
          <span class="label">Due Soon</span>
        </div>
        <div class="summary-card on-track" data-status="ON_TRACK">
          <span class="count" id="ctOnTrack">-</span>
          <span class="label">On Track</span>
        </div>
        <div class="summary-card complete" data-status="COMPLETE">
          <span class="count" id="ctComplete">-</span>
          <span class="label">Complete</span>
        </div>
        <div class="summary-card all-card" data-status="ALL">
          <span class="count" id="ctAll">-</span>
          <span class="label">All</span>
        </div>
        <div class="overall-progress">
          <div class="bar-wrap"><div class="bar-fill green" id="overallBar" style="width:0%"></div></div>
          <span class="pct" id="overallPct">0%</span>
          <button class="btn small" id="recalcBtn" title="Recalculate from S3">Recalculate</button>
        </div>
      </div>

      <!-- Row 2: AP Person Cards -->
      <div class="ap-cards" id="apCards"></div>

      <!-- Toolbar: Search -->
      <div class="toolbar">
        <div class="toolbar-left">
          <input type="text" class="search-box" id="trackerSearch" placeholder="Search property, vendor, account..." />
          <span class="meta-info" id="trackerMeta"></span>
        </div>
        <div class="toolbar-right">
          <button class="btn secondary" id="refreshBtn">Refresh</button>
        </div>
      </div>

      <!-- Property Cards -->
      <div id="trackerContent">
        <div class="loading">Loading completion tracker...</div>
      </div>
    </div><!-- End Tracker Tab -->

    <!-- LATE BILLS TABLE TAB -->
    <div class="tab-content" id="lateBillsTab">
      <div class="summary-cards" id="summaryCards">
        <div class="summary-card very-late" data-status="VERY_LATE">
          <span class="count" id="countVeryLate">-</span>
          <span class="label">Very Late (15+)</span>
        </div>
        <div class="summary-card late" data-status="LATE">
          <span class="count" id="countLate">-</span>
          <span class="label">Late (8-14)</span>
        </div>
        <div class="summary-card slightly-late" data-status="SLIGHTLY_LATE">
          <span class="count" id="countSlightlyLate">-</span>
          <span class="label">Slightly Late (1-7)</span>
        </div>
        <div class="summary-card due-soon" data-status="DUE_SOON">
          <span class="count" id="countDueSoon">-</span>
          <span class="label">Due Soon (7 days)</span>
        </div>
        <div class="summary-card on-track" data-status="ON_TRACK">
          <span class="count" id="countOnTrack">-</span>
          <span class="label">On Track</span>
        </div>
      </div>

      <div class="toolbar">
        <div class="toolbar-left">
          <input type="text" class="search-box" id="searchBox" placeholder="Search property, vendor, account, AP rep..." />
          <label style="color:#fff;font-size:12px;display:flex;align-items:center;gap:4px">
            <input type="checkbox" id="filterHasNote" /> Has Notes
          </label>
          <span id="lastUpdated" style="color:rgba(255,255,255,0.7);font-size:11px;margin-left:8px"></span>
        </div>
        <div class="toolbar-right">
          <button class="btn secondary" id="tableRecalcBtn" title="Recalculate workflow data">Recalculate</button>
          <button class="btn secondary" id="tableRefreshBtn">Refresh</button>
          <button class="btn" id="openDrawer">Filter & Sort</button>
        </div>
      </div>

      <div class="card" style="background:var(--glass);backdrop-filter:blur(10px);border:1px solid var(--border);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.12);overflow:hidden">
        <div class="tableWrap" style="overflow:auto;max-height:calc(100vh - 340px)">
          <table id="workflowTable" style="width:100%;border-collapse:collapse;background:#fff">
            <thead>
              <tr>
                <th style="width:36px;padding:10px 12px;border-bottom:1px solid #e5e7eb;background:#f8fafc;font-size:12px;font-weight:600;position:sticky;top:0;z-index:10"><input type="checkbox" class="row-select" id="selectAll" title="Select all visible" style="width:16px;height:16px;cursor:pointer;accent-color:#0ea5e9" /></th>
                <th data-col="note" style="width:50px;padding:10px 12px;border-bottom:1px solid #e5e7eb;background:#f8fafc;font-size:12px;font-weight:600;position:sticky;top:0;z-index:10;cursor:pointer">Note</th>
                <th style="width:40px;padding:10px 12px;border-bottom:1px solid #e5e7eb;background:#f8fafc;font-size:12px;font-weight:600;position:sticky;top:0;z-index:10">Edit</th>
                <th data-col="status" style="width:100px;padding:10px 12px;border-bottom:1px solid #e5e7eb;background:#f8fafc;font-size:12px;font-weight:600;position:sticky;top:0;z-index:10;cursor:pointer">Status</th>
                <th data-col="propertyName" style="padding:10px 12px;border-bottom:1px solid #e5e7eb;background:#f8fafc;font-size:12px;font-weight:600;position:sticky;top:0;z-index:10;cursor:pointer">Property</th>
                <th data-col="vendorName" style="padding:10px 12px;border-bottom:1px solid #e5e7eb;background:#f8fafc;font-size:12px;font-weight:600;position:sticky;top:0;z-index:10;cursor:pointer">Vendor</th>
                <th data-col="accountNumber" style="padding:10px 12px;border-bottom:1px solid #e5e7eb;background:#f8fafc;font-size:12px;font-weight:600;position:sticky;top:0;z-index:10;cursor:pointer">Account #</th>
                <th data-col="apName" style="padding:10px 12px;border-bottom:1px solid #e5e7eb;background:#f8fafc;font-size:12px;font-weight:600;position:sticky;top:0;z-index:10;cursor:pointer">AP Rep</th>
                <th data-col="nextExpectedDate" style="padding:10px 12px;border-bottom:1px solid #e5e7eb;background:#f8fafc;font-size:12px;font-weight:600;position:sticky;top:0;z-index:10;cursor:pointer">Next Expected</th>
                <th data-col="daysOverdue" style="width:80px;padding:10px 12px;border-bottom:1px solid #e5e7eb;background:#f8fafc;font-size:12px;font-weight:600;position:sticky;top:0;z-index:10;cursor:pointer">Days</th>
                <th data-col="lastBillDate" style="padding:10px 12px;border-bottom:1px solid #e5e7eb;background:#f8fafc;font-size:12px;font-weight:600;position:sticky;top:0;z-index:10;cursor:pointer">Last Bill</th>
                <th style="width:45px;padding:10px 12px;border-bottom:1px solid #e5e7eb;background:#f8fafc;font-size:12px;font-weight:600;position:sticky;top:0;z-index:10">View</th>
                <th data-col="servicePeriodDays" style="width:80px;padding:10px 12px;border-bottom:1px solid #e5e7eb;background:#f8fafc;font-size:12px;font-weight:600;position:sticky;top:0;z-index:10;cursor:pointer">Period</th>
                <th data-col="hasScraper" style="width:55px;padding:10px 12px;border-bottom:1px solid #e5e7eb;background:#f8fafc;font-size:12px;font-weight:600;position:sticky;top:0;z-index:10;cursor:pointer">Scraper</th>
              </tr>
            </thead>
            <tbody id="tableBody">
              <tr><td colspan="14" class="loading">Switch to this tab to load table view...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div><!-- End Late Bills Tab -->

  </div>

  <!-- Filter Drawer (for Late Bills table tab) -->
  <div class="drawer-mask" id="drawerMask" style="position:fixed;inset:0;background:rgba(0,0,0,0.38);opacity:0;pointer-events:none;transition:opacity .2s;z-index:40"></div>
  <aside class="drawer" id="drawer" style="position:fixed;top:0;right:-420px;width:420px;max-width:92vw;height:100vh;background:#fff;box-shadow:-8px 0 24px rgba(0,0,0,.25);transition:right .25s;z-index:41;display:flex;flex-direction:column">
    <header style="display:flex;align-items:center;justify-content:space-between;padding:16px 18px;border-bottom:1px solid #e5e7eb">
      <div style="font-weight:700">Filter & Sort</div>
      <button class="btn small" id="closeDrawer">Close</button>
    </header>
    <div class="body" style="flex:1;overflow:auto;padding:16px 18px">
      <div style="margin-bottom:16px">
        <div style="font-weight:600;margin-bottom:8px;font-size:13px">Sort By</div>
        <select id="sortBy" style="width:100%;padding:8px;border:1px solid #e5e7eb;border-radius:6px;font-size:13px">
          <option value="urgency">Urgency (default)</option>
          <option value="daysOverdue">Days Overdue</option>
          <option value="propertyName">Property Name</option>
          <option value="vendorName">Vendor Name</option>
          <option value="accountNumber">Account Number</option>
          <option value="apName">AP Rep</option>
          <option value="nextExpectedDate">Next Expected Date</option>
        </select>
      </div>
      <div style="margin-bottom:16px">
        <div style="font-weight:600;margin-bottom:8px;font-size:13px">Status</div>
        <div style="display:flex;flex-direction:column;gap:6px;max-height:180px;overflow:auto" id="drawerStatusFilters"></div>
      </div>
      <div style="margin-bottom:16px">
        <div style="font-weight:600;margin-bottom:8px;font-size:13px">AP Rep</div>
        <div style="display:flex;flex-direction:column;gap:6px;max-height:180px;overflow:auto" id="drawerApFilters"></div>
      </div>
      <div style="margin-bottom:16px">
        <div style="font-weight:600;margin-bottom:8px;font-size:13px">Property <input type="text" id="drawerPropSearch" placeholder="Search..." style="padding:4px 8px;border:1px solid #e5e7eb;border-radius:4px;font-size:11px;width:120px;margin-left:8px" /></div>
        <div style="display:flex;flex-direction:column;gap:6px;max-height:180px;overflow:auto" id="drawerPropFilters"></div>
      </div>
      <div style="margin-bottom:16px">
        <div style="font-weight:600;margin-bottom:8px;font-size:13px">Vendor <input type="text" id="drawerVendorSearch" placeholder="Search..." style="padding:4px 8px;border:1px solid #e5e7eb;border-radius:4px;font-size:11px;width:120px;margin-left:8px" /></div>
        <div style="display:flex;flex-direction:column;gap:6px;max-height:180px;overflow:auto" id="drawerVendorFilters"></div>
      </div>
    </div>
    <div style="padding:12px 18px;border-top:1px solid #e5e7eb;display:flex;gap:10px;justify-content:flex-end">
      <button class="btn secondary" id="drawerClear">Clear All</button>
      <button class="btn" id="drawerApply">Apply</button>
    </div>
  </aside>

  <!-- Note Modal (for Late Bills tab) -->
  <div class="modal-overlay" id="noteModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:50;align-items:center;justify-content:center">
    <div class="modal-box" style="background:#fff;border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.3);max-width:500px;width:90%;max-height:90vh;overflow-y:auto;padding:24px">
      <h2 style="margin:0 0 16px 0;font-size:18px">Account Note</h2>
      <div id="noteAccountInfo" style="padding:8px 12px;background:#f8fafc;border-radius:6px;margin-bottom:12px;font-size:12px;color:#64748b"></div>
      <div style="margin-bottom:16px">
        <label style="display:block;margin-bottom:6px;font-weight:600;font-size:13px;color:#475569">Reason Code</label>
        <select id="noteReasonCode" style="width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:8px;font-size:14px">
          <option value="">-- Select --</option>
        </select>
      </div>
      <div style="margin-bottom:16px">
        <label style="display:block;margin-bottom:6px;font-weight:600;font-size:13px;color:#475569">Additional Notes</label>
        <textarea id="noteText" style="width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:8px;font-size:14px;font-family:inherit;min-height:80px;resize:vertical"></textarea>
      </div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:20px">
        <button class="btn secondary" id="noteClear">Clear Note</button>
        <button class="btn secondary" onclick="document.getElementById('noteModal').style.display='none'">Cancel</button>
        <button class="btn" id="noteSave">Save</button>
      </div>
    </div>
  </div>

  <!-- Edit Account Modal (for Late Bills tab) -->
  <div class="modal-overlay" id="editModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:50;align-items:center;justify-content:center">
    <div class="modal-box" style="background:#fff;border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.3);max-width:500px;width:90%;max-height:90vh;overflow-y:auto;padding:24px">
      <h2 style="margin:0 0 16px 0;font-size:18px">Edit Account Mapping</h2>
      <div id="editAccountInfo" style="padding:8px 12px;background:#f8fafc;border-radius:6px;margin-bottom:12px;font-size:12px;color:#64748b"></div>
      <div style="margin-bottom:16px">
        <label style="display:block;margin-bottom:6px;font-weight:600;font-size:13px;color:#475569">Property</label>
        <input type="text" id="editPropSearch" placeholder="Search properties..." style="width:100%;padding:8px;border:1px solid #e5e7eb;border-radius:8px;font-size:13px;margin-bottom:4px" />
        <div id="editPropList" style="max-height:200px;overflow-y:auto;border:1px solid #e5e7eb;border-radius:8px"></div>
      </div>
      <div style="margin-bottom:16px">
        <label style="display:block;margin-bottom:6px;font-weight:600;font-size:13px;color:#475569">Vendor</label>
        <input type="text" id="editVendorSearch" placeholder="Search vendors..." style="width:100%;padding:8px;border:1px solid #e5e7eb;border-radius:8px;font-size:13px;margin-bottom:4px" />
        <div id="editVendorList" style="max-height:200px;overflow-y:auto;border:1px solid #e5e7eb;border-radius:8px"></div>
      </div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:20px">
        {% if is_admin %}<button class="btn" id="editDelete" style="background:#dc2626;margin-right:auto">Delete Account</button>{% endif %}
        <button class="btn secondary" onclick="document.getElementById('editModal').style.display='none'">Cancel</button>
        <button class="btn" id="editSave">Save Changes</button>
      </div>
    </div>
  </div>

  <!-- Set Targets Modal -->
  <div class="modal-overlay" id="targetsModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:50;align-items:center;justify-content:center">
    <div class="modal-box" style="background:#fff;border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.3);max-width:500px;width:90%;max-height:90vh;overflow-y:auto;padding:24px">
      <h2 style="margin:0 0 16px 0;font-size:18px">Set Weekly Targets</h2>
      <div id="targetsModalBody"></div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:20px">
        <button class="btn secondary" onclick="document.getElementById('targetsModal').style.display='none'">Cancel</button>
        <button class="btn" id="targetsSave" onclick="saveWeeklyTargets()">Save Targets</button>
      </div>
    </div>
  </div>

  <!-- Bulk Toolbar (for Late Bills tab) -->
  <div class="bulk-toolbar" id="bulkToolbar" style="position:fixed;bottom:-70px;left:50%;transform:translateX(-50%);background:rgba(15,23,42,.92);backdrop-filter:blur(12px);color:#fff;padding:12px 24px;border-radius:14px;box-shadow:0 8px 32px rgba(0,0,0,.35);display:flex;align-items:center;gap:16px;z-index:45;transition:bottom .25s ease;font-size:13px">
    <span class="sel-count" style="font-weight:700;min-width:90px" id="selCount">0 selected</span>
    <button class="btn small" id="bulkVendorBtn">Set Vendor</button>
    <button class="btn small" id="bulkReasonBtn">Set Reason Code</button>
    <button class="btn small" id="bulkDeselectBtn" style="background:transparent;border:1px solid rgba(255,255,255,.4)">Deselect All</button>
  </div>

  <!-- Directed History Drawer -->
  <div class="dir-drawer-mask" id="dir_drawerMask" onclick="dir_closeHistory()"></div>
  <div class="dir-drawer" id="dir_historyDrawer">
    <header><h3 style="margin:0">Plan History (7 days)</h3><button class="btn small secondary" onclick="dir_closeHistory()">Close</button></header>
    <div class="body" id="dir_historyBody"><div class="loading">Loading...</div></div>
  </div>

  <!-- Directed Loading Overlay -->
  <div class="dir-loading-overlay" id="dir_loadingOverlay">
    <div class="dir-loading-box"><div class="dir-spinner"></div><div id="dir_loadingText">Loading...</div></div>
  </div>

<script>
/* ============================================================
   SHARED STATE
   ============================================================ */
let trackerData = null;
let activeStatus = null;
let activeAp = null;
let searchText = '';

/* Late Bills tab state */
let allData = [];
let filteredData = [];
let selectedKeys = new Set();
let filterState = {status: null, ap: [], properties: [], vendors: [], hasNote: false, sort: 'urgency'};
let reasonCodes = [];
let lateBillsLoaded = false;
let trackerLoaded = false;
let catalogProperties = [];
let catalogVendors = [];

/* Global AP mapping: propertyId → apName */
window.apMapping = {};
window.currentApFilter = '';

/* Directed tab state */
let dir_plan = null;
let dir_taskTimers = {};
let dir_activeTaskId = null;
let dir_reasonCodes = [];

/* Weekly objectives */
let weeklyObjectives = null;

/* ============================================================
   INIT
   ============================================================ */
document.addEventListener('DOMContentLoaded', async () => {
  initTabs();
  initTrackerEvents();
  initLateBillsEvents();
  initGlobalApFilter();

  // Load directed plan + reason codes + weekly objectives in parallel
  const [planResp, codesResp] = await Promise.all([
    fetch('/api/directed/plan'),
    fetch('/api/directed/reason-codes'),
  ]);
  const planData = await planResp.json();
  const codesData = await codesResp.json();
  dir_reasonCodes = codesData.codes || [];
  if (planData.plan) {
    dir_plan = planData.plan;
    dir_render();
  } else {
    dir_showEmpty();
  }

  loadWeeklyObjectives();
});

/* ============================================================
   TABS
   ============================================================ */
function initTabs() {
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      btn.classList.add('active');
      const tab = btn.dataset.tab;
      const el = document.getElementById(tab + 'Tab');
      if (el) el.classList.add('active');
      // Lazy load
      if (tab === 'lateBills' && !lateBillsLoaded) loadLateBillsData();
      if (tab === 'tracker' && !trackerLoaded) { trackerLoaded = true; loadTrackerData(); }
    });
  });
}

/* ============================================================
   TOAST
   ============================================================ */
function showToast(msg, type) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = 'toast show ' + (type || '');
  clearTimeout(t._tid);
  t._tid = setTimeout(() => t.className = 'toast', 3000);
}

/* ============================================================
   GLOBAL AP FILTER
   ============================================================ */
async function initGlobalApFilter() {
  try {
    const resp = await fetch('/api/config/ap-mapping');
    const data = await resp.json();
    const items = data.items || [];

    // Build mapping: propertyId → apName
    const apSet = new Set();
    for (const r of items) {
      const pid = (r.propertyId || '').trim();
      const name = (r.name || '').trim();
      if (pid && name) {
        window.apMapping[pid] = name;
        apSet.add(name);
      }
    }

    // Populate dropdown
    const sel = document.getElementById('globalApFilter');
    for (const name of [...apSet].sort()) {
      const opt = document.createElement('option');
      opt.value = name;
      opt.textContent = name;
      sel.appendChild(opt);
    }

    sel.addEventListener('change', () => {
      window.currentApFilter = sel.value;
      onGlobalApFilterChange();
    });
  } catch (e) {
    console.error('Failed to load AP mapping:', e);
  }
}

function onGlobalApFilterChange() {
  // Re-render whichever tab is active
  const activeTab = document.querySelector('.tab-btn.active')?.dataset?.tab;
  if (activeTab === 'directed') dir_render();
  if (activeTab === 'tracker') renderTracker();
  if (activeTab === 'lateBills') applyTableFilters();
}

function getApForProperty(propertyId) {
  return window.apMapping[(propertyId || '').trim()] || '';
}

/* ============================================================
   WEEKLY OBJECTIVES
   ============================================================ */
async function loadWeeklyObjectives() {
  try {
    const resp = await fetch('/api/workflow/weekly-objectives');
    weeklyObjectives = await resp.json();
    renderWeeklyTargets();
  } catch (e) {
    console.error('Failed to load weekly objectives:', e);
  }
}

function renderWeeklyTargets() {
  const container = document.getElementById('weeklyTargetsRow');
  if (!weeklyObjectives || !weeklyObjectives.hasTargets || !weeklyObjectives.targets.length) {
    // Show Set Targets button even if no targets
    container.style.display = 'flex';
    container.innerHTML = '<button class="btn small" onclick="openTargetsModal()" style="padding:8px 16px">Set Weekly Targets</button>';
    return;
  }

  container.style.display = 'flex';
  let html = '';
  for (const t of weeklyObjectives.targets) {
    const pct = t.pctComplete || 0;
    const colorClass = pct >= 80 ? 'wt-green' : pct >= 50 ? 'wt-yellow' : 'wt-red';
    html += `<div class="weekly-target-card ${colorClass}">
      <div class="wt-name">${escapeHtml(t.apName)}</div>
      <div class="wt-nums">${t.actualBills}/${t.targetBills}</div>
      <div class="wt-pct">${pct}% | ${t.daysRemaining}d left | avg ${t.dailyAvg}/d</div>
      <div class="wt-bar"><div class="wt-bar-fill" style="width:${Math.min(pct,100)}%"></div></div>
      ${t.roadblocks && t.roadblocks.length ? `<div style="font-size:9px;color:#64748b;margin-top:4px">${escapeHtml(t.roadblocks.slice(0,2).join(', '))}</div>` : ''}
    </div>`;
  }
  html += `<button class="btn small secondary" onclick="openTargetsModal()" style="align-self:center;padding:8px 12px" title="Edit targets">Set Targets</button>`;
  container.innerHTML = html;
}

function openTargetsModal() {
  const apNames = [...new Set(Object.values(window.apMapping))].sort();
  const existing = {};
  if (weeklyObjectives && weeklyObjectives.targets) {
    for (const t of weeklyObjectives.targets) existing[t.apName] = t;
  }
  let html = '';
  for (const name of apNames) {
    const cur = existing[name];
    html += `<div style="display:flex;align-items:center;gap:12px;padding:8px 0;border-bottom:1px solid #f1f5f9">
      <span style="font-weight:600;min-width:100px;font-size:13px">${escapeHtml(name)}</span>
      <label style="font-size:12px;color:#64748b">Bills:</label>
      <input type="number" class="target-bills-input" data-ap="${escapeHtml(name)}" value="${cur ? cur.targetBills : 100}" style="width:70px;padding:6px;border:1px solid #e5e7eb;border-radius:6px;font-size:13px" min="0" />
      <label style="font-size:12px;color:#64748b">Hours:</label>
      <input type="number" class="target-hours-input" data-ap="${escapeHtml(name)}" value="${cur ? cur.targetHours : 40}" style="width:60px;padding:6px;border:1px solid #e5e7eb;border-radius:6px;font-size:13px" min="0" />
    </div>`;
  }
  document.getElementById('targetsModalBody').innerHTML = html || '<p style="color:#64748b">No AP reps found. Configure AP mapping first.</p>';
  document.getElementById('targetsModal').style.display = 'flex';
}

async function saveWeeklyTargets() {
  const targets = [];
  document.querySelectorAll('.target-bills-input').forEach(inp => {
    const name = inp.dataset.ap;
    const bills = parseInt(inp.value) || 0;
    const hoursInp = document.querySelector(`.target-hours-input[data-ap="${name}"]`);
    const hours = parseInt(hoursInp?.value) || 40;
    if (name && bills > 0) {
      targets.push({ apName: name, targetBills: bills, targetHours: hours });
    }
  });
  try {
    const resp = await fetch('/api/workflow/weekly-objectives', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ targets })
    });
    const data = await resp.json();
    if (data.ok) {
      showToast('Targets saved!', 'ok');
      document.getElementById('targetsModal').style.display = 'none';
      loadWeeklyObjectives();
    } else {
      showToast('Error: ' + (data.error || 'Unknown'), 'err');
    }
  } catch (e) {
    showToast('Error: ' + e.message, 'err');
  }
}

/* ============================================================
   DIRECTED TAB (Daily Work Plan)
   ============================================================ */

function dir_showEmpty() {
  document.getElementById('dir_planContent').innerHTML = `
    <div class="dir-empty-state">
      <div class="icon">&#128203;</div>
      <h3>No plan for today</h3>
      <p>Click <strong>Generate Plan</strong> to build today's work plan based on your processing rate and current priorities.</p>
    </div>`;
  document.getElementById('dir_eodButton').style.display = 'none';
}

async function dir_generatePlan() {
  dir_showLoading('Generating your daily plan...');
  try {
    const genResp = await fetch('/api/directed/generate', { method: 'POST' });
    const genData = await genResp.json();
    if (!genResp.ok || genData.error) {
      showToast('Error generating plan: ' + (genData.error || 'unknown error'), 'err');
      dir_hideLoading();
      return;
    }
    const resp = await fetch('/api/directed/plan');
    const data = await resp.json();
    dir_plan = data.plan;
    dir_render();
    showToast('Plan generated!', 'ok');
  } catch (e) {
    showToast('Error generating plan: ' + e.message, 'err');
  }
  dir_hideLoading();
}

function dir_render() {
  if (!dir_plan || !dir_plan.tasks || !dir_plan.tasks.length) { dir_showEmpty(); return; }
  document.getElementById('dir_planDate').textContent = dir_plan.planDate || '';
  dir_renderStats();
  dir_renderTasks();
  const pending = dir_plan.tasks.filter(t => t.status === 'pending');
  document.getElementById('dir_eodButton').style.display = pending.length > 0 ? 'inline-block' : 'none';
}

function dir_renderStats() {
  if (!dir_plan) return;
  let tasks = dir_plan.tasks || [];
  // Apply global AP filter
  if (window.currentApFilter) {
    tasks = tasks.filter(t => getApForProperty(t.propertyId) === window.currentApFilter);
  }
  const completed = tasks.filter(t => t.status === 'completed').length;
  const incomplete = tasks.filter(t => t.status === 'incomplete').length;
  const total = tasks.length;
  const remaining = total - completed - incomplete;
  const pct = total > 0 ? Math.round(completed / total * 100) : 0;

  document.getElementById('dir_statPlanned').textContent = total;
  document.getElementById('dir_statCompleted').textContent = completed;
  document.getElementById('dir_statRemaining').textContent = remaining;

  const rate = dir_plan.userRate || {};
  const avgColl = (rate.avgCollectionSec || 180) / 60;
  const avgProc = (rate.avgProcessingSec || 60) / 60;
  let estMin = 0;
  for (const t of tasks) {
    if (t.status !== 'pending') continue;
    estMin += t.taskType === 'collection' ? avgColl : avgProc;
  }
  const hrs = Math.floor(estMin / 60);
  const mins = Math.round(estMin % 60);
  document.getElementById('dir_statTime').textContent = hrs > 0 ? `${hrs}h ${mins}m` : `${mins}m`;
  document.getElementById('dir_progressFill').style.width = pct + '%';
  document.getElementById('dir_progressLabel').textContent = `${pct}% complete (${completed}/${total})`;
}

function dir_renderTasks() {
  const container = document.getElementById('dir_planContent');
  let tasks = dir_plan.tasks || [];

  // Apply global AP filter
  if (window.currentApFilter) {
    tasks = tasks.filter(t => getApForProperty(t.propertyId) === window.currentApFilter);
  }

  const houseTasks = tasks.filter(t => t.isHouse);
  const vacantTasks = tasks.filter(t => !t.isHouse);

  let html = '';
  if (houseTasks.length) {
    const houseEst = houseTasks.reduce((s, t) => s + (t.estimatedMinutes || 0), 0);
    html += `<div class="dir-section-header" onclick="dir_toggleSection('house')">
      <span class="arrow" id="dir_arrow_house">&#9660;</span>
      HOUSE ACCOUNTS
      <span class="count">${houseTasks.length} tasks, ~${Math.round(houseEst)} min</span>
    </div>`;
    html += `<div class="dir-card" id="dir_section_house">` + dir_renderGroupedTasks(houseTasks, 'provider') + `</div>`;
  }
  if (vacantTasks.length) {
    const vacantEst = vacantTasks.reduce((s, t) => s + (t.estimatedMinutes || 0), 0);
    html += `<div class="dir-section-header" onclick="dir_toggleSection('vacant')">
      <span class="arrow" id="dir_arrow_vacant">&#9660;</span>
      VACANT ACCOUNTS
      <span class="count">${vacantTasks.length} tasks, ~${Math.round(vacantEst)} min</span>
    </div>`;
    html += `<div class="dir-card" id="dir_section_vacant">` + dir_renderGroupedTasks(vacantTasks, 'property') + `</div>`;
  }
  if (!html) {
    html = '<div class="dir-empty-state"><p>No tasks match the current filter.</p></div>';
  }
  container.innerHTML = html;
}

function dir_renderGroupedTasks(tasks, groupBy) {
  const groups = {};
  for (const t of tasks) {
    const key = groupBy === 'provider'
      ? (t.providerGroup || t.vendorName || 'Unknown')
      : (t.propertyName || 'Unknown');
    if (!groups[key]) groups[key] = [];
    groups[key].push(t);
  }
  let html = '<div class="dir-task-list">';
  for (const [groupName, groupTasks] of Object.entries(groups)) {
    const groupEst = groupTasks.reduce((s, t) => s + (t.estimatedMinutes || 0), 0);
    const gid = 'g_' + groupName.replace(/\W/g, '_');
    html += `<div class="dir-group-header" onclick="dir_toggleGroup('${gid}')">
      <span class="arrow" id="dir_arrow_${gid}">&#9660;</span>
      <strong>${escapeHtml(groupName.toUpperCase())}</strong>
      <span class="group-stats">${groupTasks.length} tasks, ~${Math.round(groupEst)} min</span>
    </div>`;
    html += `<div id="dir_group_${gid}">`;
    for (const t of groupTasks) html += dir_renderTaskRow(t);
    html += '</div>';
  }
  html += '</div>';
  return html;
}

function dir_renderTaskRow(t) {
  const isActive = dir_activeTaskId === t.taskId;
  const cls = ['dir-task-row'];
  if (isActive) cls.push('active');
  if (t.status === 'completed') cls.push('completed');
  if (t.status === 'incomplete') cls.push('incomplete');
  if (!t.isHouse) cls.push('vacant');
  if (t.blockedByNote) cls.push('blocked');

  let sourceHtml = '';
  const src = t.source || {};
  if (src.resolution === 'scraper') {
    sourceHtml = `<span class="dir-source-tag scraper">Scraper PDF (${src.scraperPdfCount || '?'})</span>`;
  } else if (src.resolution === 'portal') {
    const url = src.portalUrl || '';
    const user = src.portalUsername || '';
    sourceHtml = `<span class="dir-source-tag portal">Portal${url ? ': ' + escapeHtml(url) : ''}${user ? ' | ' + escapeHtml(user) : ''}</span>`;
  } else if (src.resolution === 'mail') {
    sourceHtml = `<span class="dir-source-tag mail">Check mail</span>`;
  } else if (src.resolution === 'pipeline') {
    sourceHtml = `<span class="dir-source-tag">${t.subType || 'pipeline'}</span>`;
  }

  let blockedHtml = t.blockedByNote ? '<span class="dir-blocked-tag">BLOCKED</span>' : '';

  let timerHtml = '';
  if (isActive && dir_taskTimers[t.taskId]) {
    timerHtml = `<span class="dir-timer" id="dir_timer_${t.taskId}">0:00</span>`;
  }

  let actionsHtml = '';
  if (t.status === 'pending') {
    if (!isActive) {
      actionsHtml = `<button class="btn small" onclick="dir_startTask('${t.taskId}')">Start</button>`;
    } else {
      if (t.taskType === 'collection') {
        actionsHtml = `
          <button class="btn small success" onclick="dir_completeTask('${t.taskId}','imported')">Imported</button>
          <button class="btn small" onclick="dir_completeTask('${t.taskId}','logged_portal')">Portal</button>
          <button class="btn small secondary" onclick="dir_completeTask('${t.taskId}','checked_mail')">Mail</button>
          <button class="btn small" style="background:#94a3b8" onclick="dir_markIncomplete('${t.taskId}')">Skip</button>`;
      } else {
        const link = t.subType === 'review' ? `/invoices?pdf_id=${t.pdfId || ''}` :
                     t.subType === 'post' ? `/post` : `/billback`;
        actionsHtml = `
          <a class="btn small" href="${link}" target="_blank">Open</a>
          <button class="btn small success" onclick="dir_completeTask('${t.taskId}','processed')">Done</button>
          <button class="btn small" style="background:#94a3b8" onclick="dir_markIncomplete('${t.taskId}')">Skip</button>`;
      }
    }
  } else if (t.status === 'completed') {
    actionsHtml = `<span style="color:#059669;font-size:11px">&#10003; ${t.completedAction || 'done'}</span>`;
  } else if (t.status === 'incomplete') {
    actionsHtml = `<span style="color:#b91c1c;font-size:11px">${t.incompleteReason || 'skipped'}</span>`;
  }

  const houseLabel = t.isHouse
    ? `<span class="dir-house-label">HOUSE</span>`
    : `<span class="dir-vacant-label">VACANT</span>`;

  return `<div class="${cls.join(' ')}" data-task-id="${t.taskId}">
    <span class="dir-status-badge status-${t.urgencyStatus || 'ON_TRACK'}">${(t.urgencyStatus || '').replace(/_/g,' ')}</span>
    <span class="dir-type-badge ${t.taskType}">${t.taskType}</span>
    ${houseLabel}
    <span class="dir-col-property" title="${escapeHtml(t.propertyName)}">${escapeHtml(t.propertyName)}</span>
    <span class="dir-col-vendor" title="${escapeHtml(t.vendorName)}">${escapeHtml(t.vendorName)}</span>
    <span class="dir-col-account">${escapeHtml(t.accountNumber)}</span>
    <span class="dir-amount">${t.avgAmount ? '$' + t.avgAmount.toLocaleString() : ''}</span>
    ${sourceHtml}
    ${blockedHtml}
    ${timerHtml}
    <div class="dir-task-actions">${actionsHtml}</div>
  </div>`;
}

/* --- Directed Task Actions --- */
function dir_startTask(taskId) {
  dir_activeTaskId = taskId;
  dir_taskTimers[taskId] = Date.now();
  dir_renderTasks();
  const interval = setInterval(() => {
    if (dir_activeTaskId !== taskId) { clearInterval(interval); return; }
    const el = document.getElementById('dir_timer_' + taskId);
    if (!el) { clearInterval(interval); return; }
    const sec = Math.round((Date.now() - dir_taskTimers[taskId]) / 1000);
    const m = Math.floor(sec / 60);
    const s = sec % 60;
    el.textContent = m + ':' + String(s).padStart(2, '0');
  }, 1000);
}

async function dir_completeTask(taskId, action) {
  const duration = dir_taskTimers[taskId] ? Math.round((Date.now() - dir_taskTimers[taskId]) / 1000) : 0;
  try {
    const resp = await fetch('/api/directed/complete', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ taskId, action, durationSec: duration })
    });
    const data = await resp.json();
    if (!data.ok) { showToast('Error: ' + (data.error || 'Unknown'), 'err'); return; }
    const task = dir_plan.tasks.find(t => t.taskId === taskId);
    if (task) { task.status = 'completed'; task.completedAction = action; task.completedAt = new Date().toISOString(); }
    dir_plan.stats.completedCount = dir_plan.tasks.filter(t => t.status === 'completed').length;
    if (dir_activeTaskId === taskId) dir_activeTaskId = null;
    dir_render();
    showToast('Task completed', 'ok');
  } catch (e) { showToast('Error: ' + e.message, 'err'); }
}

async function dir_markIncomplete(taskId) {
  try {
    const resp = await fetch('/api/directed/incomplete', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ taskId, reasonCode: 'ran_out_of_time', notes: '' })
    });
    const data = await resp.json();
    if (!data.ok) { showToast('Error: ' + (data.error || 'Unknown'), 'err'); return; }
    const task = dir_plan.tasks.find(t => t.taskId === taskId);
    if (task) { task.status = 'incomplete'; task.incompleteReason = 'ran_out_of_time'; }
    dir_plan.stats.incompleteCount = dir_plan.tasks.filter(t => t.status === 'incomplete').length;
    if (dir_activeTaskId === taskId) dir_activeTaskId = null;
    dir_render();
  } catch (e) { showToast('Error: ' + e.message, 'err'); }
}

/* --- Directed End of Day --- */
function dir_showEodSection() {
  const pending = dir_plan.tasks.filter(t => t.status === 'pending');
  if (!pending.length) { showToast('All tasks completed!', 'ok'); return; }
  let html = '';
  for (const t of pending) {
    html += `<div class="dir-eod-task">
      <div class="info">
        <strong>${escapeHtml(t.propertyName)}</strong> - ${escapeHtml(t.vendorName)} - ${escapeHtml(t.accountNumber)}
        <br><span class="dir-status-badge status-${t.urgencyStatus}">${(t.urgencyStatus || '').replace(/_/g,' ')}</span>
        <span class="dir-type-badge ${t.taskType}">${t.taskType}</span>
      </div>
      <div>
        <select id="dir_reason_${t.taskId}">
          <option value="">Select reason...</option>
          ${dir_reasonCodes.map(c => `<option value="${c.code}">${escapeHtml(c.label)}</option>`).join('')}
        </select>
        <textarea id="dir_notes_${t.taskId}" placeholder="Optional notes..."></textarea>
      </div>
    </div>`;
  }
  document.getElementById('dir_eodTasks').innerHTML = html;
  document.getElementById('dir_eodSection').style.display = 'block';
  document.getElementById('dir_eodButtonWrap').style.display = 'none';
  document.getElementById('dir_eodSection').scrollIntoView({ behavior: 'smooth' });
}

function dir_cancelEod() {
  document.getElementById('dir_eodSection').style.display = 'none';
  document.getElementById('dir_eodButtonWrap').style.display = 'block';
}

async function dir_submitEndOfDay() {
  const pending = dir_plan.tasks.filter(t => t.status === 'pending');
  const incompletes = [];
  for (const t of pending) {
    const reason = document.getElementById('dir_reason_' + t.taskId)?.value;
    const notes = document.getElementById('dir_notes_' + t.taskId)?.value || '';
    if (!reason) { showToast('Please select a reason for all tasks', 'err'); return; }
    incompletes.push({ taskId: t.taskId, reasonCode: reason, notes });
  }
  dir_showLoading('Submitting day summary...');
  try {
    const resp = await fetch('/api/directed/end-of-day', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ incompletes })
    });
    const data = await resp.json();
    if (data.ok) {
      for (const item of incompletes) {
        const task = dir_plan.tasks.find(t => t.taskId === item.taskId);
        if (task) { task.status = 'incomplete'; task.incompleteReason = item.reasonCode; task.incompleteNotes = item.notes; }
      }
      dir_plan.stats.incompleteCount = dir_plan.tasks.filter(t => t.status === 'incomplete').length;
      document.getElementById('dir_eodSection').style.display = 'none';
      dir_render();
      showToast(`Day complete! ${data.completed} done, ${data.incomplete} incomplete`, 'ok');
    } else { showToast('Error: ' + (data.error || 'Unknown'), 'err'); }
  } catch (e) { showToast('Error: ' + e.message, 'err'); }
  dir_hideLoading();
}

/* --- Directed History Drawer --- */
async function dir_openHistory() {
  document.getElementById('dir_drawerMask').classList.add('open');
  document.getElementById('dir_historyDrawer').classList.add('open');
  document.getElementById('dir_historyBody').innerHTML = '<div class="loading">Loading...</div>';
  try {
    const resp = await fetch('/api/directed/history?days=7');
    const data = await resp.json();
    const history = data.history || [];
    if (!history.length) {
      document.getElementById('dir_historyBody').innerHTML = '<p style="color:#64748b">No history yet.</p>';
      return;
    }
    let html = '';
    for (const day of history) {
      const completed = day.totalCompleted || 0;
      const total = day.totalPlanned || 0;
      const pct = total > 0 ? Math.round(completed / total * 100) : 0;
      html += `<div class="dir-history-day">
        <div class="day-header"><span>${day.planDate}</span><span>${completed}/${total} (${pct}%)</span></div>
        <div class="day-body">`;
      if (day.incompletes && day.incompletes.length) {
        html += '<div style="margin-top:4px"><strong style="font-size:11px;color:#b91c1c">Incomplete:</strong>';
        for (const inc of day.incompletes) {
          const label = dir_reasonCodes.find(c => c.code === inc.reasonCode)?.label || inc.reasonCode;
          html += `<div class="incomplete-item">${escapeHtml(inc.accountKey || '')} - ${escapeHtml(label)}${inc.notes ? ': ' + escapeHtml(inc.notes) : ''}</div>`;
        }
        html += '</div>';
      }
      html += '</div></div>';
    }
    document.getElementById('dir_historyBody').innerHTML = html;
  } catch (e) {
    document.getElementById('dir_historyBody').innerHTML = '<p style="color:#b91c1c">Error loading history</p>';
  }
}

function dir_closeHistory() {
  document.getElementById('dir_drawerMask').classList.remove('open');
  document.getElementById('dir_historyDrawer').classList.remove('open');
}

/* --- Directed Toggle sections --- */
function dir_toggleSection(id) {
  const el = document.getElementById('dir_section_' + id);
  const arrow = document.getElementById('dir_arrow_' + id);
  if (!el) return;
  if (el.style.display === 'none') { el.style.display = ''; if (arrow) arrow.innerHTML = '&#9660;'; }
  else { el.style.display = 'none'; if (arrow) arrow.innerHTML = '&#9654;'; }
}

function dir_toggleGroup(gid) {
  const el = document.getElementById('dir_group_' + gid);
  const arrow = document.getElementById('dir_arrow_' + gid);
  if (!el) return;
  if (el.style.display === 'none') { el.style.display = ''; if (arrow) arrow.innerHTML = '&#9660;'; }
  else { el.style.display = 'none'; if (arrow) arrow.innerHTML = '&#9654;'; }
}

/* --- Directed Loading --- */
function dir_showLoading(text) {
  document.getElementById('dir_loadingText').textContent = text || 'Loading...';
  document.getElementById('dir_loadingOverlay').classList.add('show');
}
function dir_hideLoading() { document.getElementById('dir_loadingOverlay').classList.remove('show'); }


/* ============================================================
   COMPLETION TRACKER
   ============================================================ */

function initTrackerEvents() {
  document.querySelectorAll('#statusCards .summary-card').forEach(card => {
    card.addEventListener('click', () => {
      const status = card.dataset.status;
      if (activeStatus === status) { activeStatus = null; card.classList.remove('active'); }
      else {
        document.querySelectorAll('#statusCards .summary-card').forEach(c => c.classList.remove('active'));
        activeStatus = status;
        card.classList.add('active');
      }
      renderTracker();
    });
  });
  document.getElementById('trackerSearch').addEventListener('input', e => { searchText = e.target.value.toLowerCase(); renderTracker(); });
  document.getElementById('recalcBtn').addEventListener('click', () => { loadTrackerData(true); });
  document.getElementById('refreshBtn').addEventListener('click', () => { loadTrackerData(); });
}

async function loadTrackerData(forceRefresh) {
  const container = document.getElementById('trackerContent');
  container.innerHTML = '<div class="loading">Loading completion tracker...</div>';
  try {
    const url = '/api/workflow/completion-tracker' + (forceRefresh ? '?refresh=1' : '');
    const resp = await fetch(url);
    trackerData = await resp.json();
    if (trackerData.error) {
      container.innerHTML = '<div class="loading" style="color:#ef4444">Error: ' + trackerData.error + '</div>';
      return;
    }
    updateStatusCards();
    renderApCards();
    renderTracker();
    document.getElementById('trackerMeta').textContent = 'Generated: ' + (trackerData.generated_at || '');
  } catch (e) {
    container.innerHTML = '<div class="loading" style="color:#ef4444">Failed to load: ' + e.message + '</div>';
  }
}

function updateStatusCards() {
  if (!trackerData) return;
  const s = trackerData.summary.by_status;
  document.getElementById('ctVeryLate').textContent = s.VERY_LATE || 0;
  document.getElementById('ctLate').textContent = s.LATE || 0;
  document.getElementById('ctSlightlyLate').textContent = s.SLIGHTLY_LATE || 0;
  document.getElementById('ctDueSoon').textContent = s.DUE_SOON || 0;
  document.getElementById('ctOnTrack').textContent = s.ON_TRACK || 0;
  document.getElementById('ctComplete').textContent = s.COMPLETE || 0;
  document.getElementById('ctAll').textContent = trackerData.summary.total_account_months || 0;
  const pct = trackerData.summary.percentage || 0;
  const bar = document.getElementById('overallBar');
  bar.style.width = pct + '%';
  bar.className = 'bar-fill ' + (pct >= 90 ? 'green' : pct >= 50 ? 'yellow' : 'red');
  document.getElementById('overallPct').textContent = pct + '%';
}

function renderApCards() {
  if (!trackerData) return;
  const container = document.getElementById('apCards');
  const apList = trackerData.ap_summary || [];
  let html = '';
  for (const ap of apList) {
    const healthClass = ap.percentage >= 90 ? 'health-green' : ap.percentage >= 50 ? 'health-yellow' : 'health-red';
    const isActive = activeAp === ap.ap_name;
    html += `<div class="ap-card ${healthClass} ${isActive ? 'active' : ''}" data-ap="${ap.ap_name}" onclick="toggleApFilter('${ap.ap_name.replace(/'/g, "\\'")}')" title="${ap.complete}/${ap.total} complete (${ap.percentage}%)">
      <div class="ap-name">${ap.ap_name}</div>
      <div class="ap-count">${ap.total} acct-months | ${ap.percentage}%</div>
    </div>`;
  }
  container.innerHTML = html;
}

function toggleApFilter(apName) {
  if (activeAp === apName) activeAp = null; else activeAp = apName;
  document.querySelectorAll('#apCards .ap-card').forEach(c => {
    c.classList.toggle('active', c.dataset.ap === activeAp);
  });
  renderTracker();
}

function renderTracker() {
  if (!trackerData) return;
  const container = document.getElementById('trackerContent');
  let properties = trackerData.properties || [];

  // Global AP filter
  if (window.currentApFilter) {
    properties = properties.filter(p => (p.ap_name || 'Unassigned') === window.currentApFilter);
  }

  // Tracker AP filter (within-tab)
  if (activeAp) {
    properties = properties.filter(p => (p.ap_name || 'Unassigned') === activeAp);
  }

  if (searchText) {
    properties = properties.filter(p => {
      const pMatch = (p.property_name || '').toLowerCase().includes(searchText);
      const itemMatch = (p.items || []).some(it =>
        (it.vendor_name || '').toLowerCase().includes(searchText) ||
        (it.account_number || '').toLowerCase().includes(searchText)
      );
      return pMatch || itemMatch;
    });
  }

  let filteredProps = properties.map(p => {
    let items = p.items || [];
    if (activeStatus && activeStatus !== 'ALL') items = items.filter(it => it.status_label === activeStatus);
    if (searchText) {
      items = items.filter(it =>
        (it.vendor_name || '').toLowerCase().includes(searchText) ||
        (it.account_number || '').toLowerCase().includes(searchText) ||
        (p.property_name || '').toLowerCase().includes(searchText)
      );
    }
    if (items.length === 0) return null;
    const complete = items.filter(it => it.status_label === 'COMPLETE').length;
    const total = items.length;
    return { ...p, items, complete_filtered: complete, total_filtered: total,
             percentage_filtered: total ? Math.round(100 * complete / total * 10) / 10 : 0 };
  }).filter(Boolean);

  filteredProps.sort((a, b) => a.percentage_filtered - b.percentage_filtered || a.property_name.localeCompare(b.property_name));

  if (filteredProps.length === 0) {
    container.innerHTML = '<div class="loading">No properties match current filters.</div>';
    return;
  }

  let html = `<div style="font-size:13px;font-weight:600;margin-bottom:12px;color:#fff">${filteredProps.length} Properties</div><div class="property-grid">`;

  for (const prop of filteredProps) {
    const pct = prop.percentage_filtered;
    const statusClass = pct >= 100 ? 'complete' : pct > 0 ? 'partial' : 'missing';
    const barClass = pct >= 100 ? 'progress-green' : pct > 0 ? 'progress-yellow' : 'progress-red';

    html += `<div class="property-card ${statusClass}" ondblclick="toggleExpand(this)" title="Double-click to expand/collapse">
      <div class="property-name">${prop.property_name || prop.property_id}</div>
      ${prop.ap_name ? `<div class="property-ap">${prop.ap_name}</div>` : ''}
      <div class="property-stats">
        <span>${prop.complete_filtered}/${prop.total_filtered} complete</span>
        <span style="font-weight:700;color:${pct >= 100 ? '#10b981' : pct > 0 ? '#f59e0b' : '#ef4444'}">${pct}%</span>
      </div>
      <div class="progress-bar"><div class="progress-fill ${barClass}" style="width:${pct}%"></div></div>
      <div class="account-list">`;

    const sorted = prop.items.slice().sort((a, b) => {
      const aComplete = a.status_label === 'COMPLETE' ? 1 : 0;
      const bComplete = b.status_label === 'COMPLETE' ? 1 : 0;
      if (aComplete !== bComplete) return aComplete - bComplete;
      if (!aComplete) return b.days_overdue - a.days_overdue;
      return a.vendor_name.localeCompare(b.vendor_name);
    });

    for (const item of sorted) {
      const isComplete = item.status_label === 'COMPLETE';
      let icon, iconClass;
      if (isComplete) { icon = '&#10003;'; iconClass = 'ok'; }
      else if (item.status_label === 'DUE_SOON' || item.status_label === 'ON_TRACK') { icon = '&#9711;'; iconClass = 'wait'; }
      else { icon = '&#10007;'; iconClass = 'miss'; }
      const stageTag = item.pipeline_stage ? `<span class="stage-tag">${item.pipeline_stage}</span>` : '';
      const scraperTag = item.in_scraper ? '<span class="scraper-tag">SCR</span>' : '';
      const monthDisplay = formatMonth(item.month);

      html += `<div class="account-item">
        <div class="acct-info"><div class="acct-label">${item.vendor_name || 'Unknown'} - ${item.account_number}${scraperTag}</div></div>
        <span class="month-badge ${item.status_label}">${monthDisplay}</span>
        ${stageTag}
        <span class="status-icon ${iconClass}">${icon}</span>
      </div>`;
    }
    html += `</div></div>`;
  }
  html += '</div>';
  container.innerHTML = html;
}

function toggleExpand(el) { el.classList.toggle('expanded'); }

function formatMonth(monthStr) {
  if (!monthStr) return '';
  const months = ['JAN','FEB','MAR','APR','MAY','JUN','JUL','AUG','SEP','OCT','NOV','DEC'];
  if (monthStr.includes('-')) {
    const [start, end] = monthStr.split('-');
    return formatMonth(start) + '-' + formatMonth(end);
  }
  const parts = monthStr.split('/');
  if (parts.length !== 2) return monthStr;
  const idx = parseInt(parts[0], 10) - 1;
  return (months[idx] || parts[0]) + ' ' + parts[1];
}


/* ============================================================
   LATE BILLS TABLE TAB
   ============================================================ */

function initLateBillsEvents() {
  document.getElementById('searchBox').addEventListener('input', () => { applyTableFilters(); });
  document.getElementById('filterHasNote').addEventListener('change', () => { filterState.hasNote = document.getElementById('filterHasNote').checked; applyTableFilters(); });

  document.querySelectorAll('#summaryCards .summary-card').forEach(card => {
    card.addEventListener('click', () => {
      const status = card.dataset.status;
      if (filterState.status === status) { filterState.status = null; card.classList.remove('active'); }
      else {
        document.querySelectorAll('#summaryCards .summary-card').forEach(c => c.classList.remove('active'));
        filterState.status = status;
        card.classList.add('active');
      }
      applyTableFilters();
    });
  });

  document.getElementById('tableRecalcBtn').addEventListener('click', () => triggerRecalculate());
  document.getElementById('tableRefreshBtn').addEventListener('click', () => loadLateBillsData());

  document.getElementById('openDrawer').addEventListener('click', () => {
    document.getElementById('drawer').style.right = '0';
    document.getElementById('drawerMask').style.opacity = '1';
    document.getElementById('drawerMask').style.pointerEvents = 'auto';
  });
  document.getElementById('closeDrawer').addEventListener('click', closeDrawer);
  document.getElementById('drawerMask').addEventListener('click', closeDrawer);
  document.getElementById('drawerApply').addEventListener('click', () => { applyDrawerFilters(); closeDrawer(); });
  document.getElementById('drawerClear').addEventListener('click', clearDrawerFilters);

  document.getElementById('selectAll').addEventListener('change', e => {
    const checked = e.target.checked;
    filteredData.forEach(r => checked ? selectedKeys.add(r.accountKey) : selectedKeys.delete(r.accountKey));
    renderTable();
    updateBulkToolbar();
  });

  document.getElementById('bulkDeselectBtn').addEventListener('click', () => {
    selectedKeys.clear();
    document.getElementById('selectAll').checked = false;
    renderTable();
    updateBulkToolbar();
  });

  document.getElementById('noteSave').addEventListener('click', saveNote);
  document.getElementById('noteClear').addEventListener('click', clearNote);
}

function closeDrawer() {
  document.getElementById('drawer').style.right = '-420px';
  document.getElementById('drawerMask').style.opacity = '0';
  document.getElementById('drawerMask').style.pointerEvents = 'none';
}

async function loadLateBillsData() {
  lateBillsLoaded = true;
  document.getElementById('tableBody').innerHTML = '<tr><td colspan="14" class="loading">Loading...</td></tr>';
  try {
    const resp = await fetch('/api/workflow');
    const data = await resp.json();
    allData = data.rows || [];
    reasonCodes = (data.filters || {}).reasonCodes || [];
    populateDrawerFilters(data.filters || {});
    populateReasonCodes();
    if (data.cacheStatus === 'empty') {
      document.getElementById('tableBody').innerHTML = '<tr><td colspan="14" class="loading">Cache empty. Click Recalculate to generate data.</td></tr>';
      return;
    }
    document.getElementById('lastUpdated').textContent = data.computedAt ? 'Updated: ' + data.computedAt : '';
    applyTableFilters();
    loadCatalogs();
  } catch (e) {
    document.getElementById('tableBody').innerHTML = '<tr><td colspan="14" class="loading" style="color:#ef4444">Error: ' + e.message + '</td></tr>';
  }
}

function populateDrawerFilters(filters) {
  const statuses = ['VERY_LATE', 'LATE', 'SLIGHTLY_LATE', 'DUE_SOON', 'ON_TRACK'];
  const statusContainer = document.getElementById('drawerStatusFilters');
  statusContainer.innerHTML = statuses.map(s => `<label style="display:flex;align-items:center;gap:6px;font-size:12px"><input type="checkbox" value="${s}" checked /> ${s.replace(/_/g,' ')}</label>`).join('');

  const apContainer = document.getElementById('drawerApFilters');
  apContainer.innerHTML = (filters.apReps || []).map(a => `<label style="display:flex;align-items:center;gap:6px;font-size:12px"><input type="checkbox" value="${a}" checked /> ${a}</label>`).join('');

  const propContainer = document.getElementById('drawerPropFilters');
  propContainer.innerHTML = (filters.properties || []).map(p => `<label style="display:flex;align-items:center;gap:6px;font-size:12px"><input type="checkbox" value="${p.id}" checked /> ${p.name}</label>`).join('');

  const vendorContainer = document.getElementById('drawerVendorFilters');
  vendorContainer.innerHTML = (filters.vendors || []).map(v => `<label style="display:flex;align-items:center;gap:6px;font-size:12px"><input type="checkbox" value="${v.id}" checked /> ${v.name}</label>`).join('');

  document.getElementById('drawerPropSearch').addEventListener('input', e => {
    const q = e.target.value.toLowerCase();
    propContainer.querySelectorAll('label').forEach(l => { l.style.display = l.textContent.toLowerCase().includes(q) ? '' : 'none'; });
  });
  document.getElementById('drawerVendorSearch').addEventListener('input', e => {
    const q = e.target.value.toLowerCase();
    vendorContainer.querySelectorAll('label').forEach(l => { l.style.display = l.textContent.toLowerCase().includes(q) ? '' : 'none'; });
  });
}

function populateReasonCodes() {
  const sel = document.getElementById('noteReasonCode');
  sel.innerHTML = '<option value="">-- Select --</option>';
  for (const rc of reasonCodes) {
    const code = typeof rc === 'object' ? rc.code : rc;
    const label = typeof rc === 'object' ? rc.label : rc;
    sel.innerHTML += `<option value="${escapeHtml(code)}">${escapeHtml(label)}</option>`;
  }
}

function applyDrawerFilters() {
  filterState.ap = [...document.querySelectorAll('#drawerApFilters input:checked')].map(i => i.value);
  filterState.properties = [...document.querySelectorAll('#drawerPropFilters input:checked')].map(i => i.value);
  filterState.vendors = [...document.querySelectorAll('#drawerVendorFilters input:checked')].map(i => i.value);
  filterState.sort = document.getElementById('sortBy').value;
  applyTableFilters();
}

function clearDrawerFilters() {
  document.querySelectorAll('#drawer input[type=checkbox]').forEach(i => i.checked = true);
  document.getElementById('sortBy').value = 'urgency';
  filterState = {status: null, ap: [], properties: [], vendors: [], hasNote: false, sort: 'urgency'};
  applyTableFilters();
}

function applyTableFilters() {
  const search = document.getElementById('searchBox').value.toLowerCase();
  filteredData = allData.filter(r => {
    if (filterState.status && r.status !== filterState.status) return false;
    if (filterState.hasNote && !r.hasNote) return false;
    if (search) {
      const hay = (r.propertyName + ' ' + r.vendorName + ' ' + r.accountNumber + ' ' + r.apName).toLowerCase();
      if (!hay.includes(search)) return false;
    }
    if (filterState.ap.length && !filterState.ap.includes(r.apName)) return false;
    if (filterState.properties.length && !filterState.properties.includes(r.propertyId)) return false;
    if (filterState.vendors.length && !filterState.vendors.includes(r.vendorId)) return false;
    // Global AP filter
    if (window.currentApFilter && r.apName !== window.currentApFilter) return false;
    return true;
  });

  const sortKey = filterState.sort || 'urgency';
  filteredData.sort((a, b) => {
    if (sortKey === 'urgency') return (-a.urgencyScore + b.urgencyScore) || (-a.daysOverdue + b.daysOverdue);
    if (sortKey === 'daysOverdue') return -a.daysOverdue + b.daysOverdue;
    const av = a[sortKey] || '', bv = b[sortKey] || '';
    return typeof av === 'string' ? av.localeCompare(bv) : av - bv;
  });

  updateTableSummary();
  renderTable();
}

function updateTableSummary() {
  let counts = {VERY_LATE:0, LATE:0, SLIGHTLY_LATE:0, DUE_SOON:0, ON_TRACK:0};
  filteredData.forEach(r => { if (counts[r.status] !== undefined) counts[r.status]++; });
  document.getElementById('countVeryLate').textContent = counts.VERY_LATE;
  document.getElementById('countLate').textContent = counts.LATE;
  document.getElementById('countSlightlyLate').textContent = counts.SLIGHTLY_LATE;
  document.getElementById('countDueSoon').textContent = counts.DUE_SOON;
  document.getElementById('countOnTrack').textContent = counts.ON_TRACK;
}

function escapeHtml(s) {
  return String(s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function escapeJs(s) {
  return String(s || '').replace(/\\/g,'\\\\').replace(/'/g,"\\'").replace(/"/g,'\\"');
}

function renderTable() {
  const tbody = document.getElementById('tableBody');
  if (!filteredData.length) {
    tbody.innerHTML = '<tr><td colspan="14" class="loading">No matching accounts.</td></tr>';
    return;
  }
  let html = '';
  for (const r of filteredData) {
    const checked = selectedKeys.has(r.accountKey) ? 'checked' : '';
    const noteIcon = r.hasNote ? '<span title="Has note" style="cursor:pointer">&#128221;</span>' : '<span style="opacity:.3;cursor:pointer">&#10133;</span>';
    const statusBadge = `<span style="display:inline-block;padding:4px 10px;border-radius:12px;font-size:11px;font-weight:600" class="status-${r.status}">${r.status.replace(/_/g,' ')}</span>`;
    const scraperBadge = r.hasScraper ? '<span style="background:#dcfce7;color:#166534;padding:2px 6px;border-radius:4px;font-size:10px;font-weight:700">SCR</span>' : '';
    const viewLink = r.lastBillKeyDate ? `<a href="/invoices?date=${r.lastBillKeyDate}#${r.lastBillPdfId}" target="_blank" style="color:#0284c7;text-decoration:none;font-size:12px;font-weight:600">View</a>` : '';
    const dupBadge = r.isDuplicate ? `<span style="background:#fef3c7;color:#92400e;padding:1px 5px;border-radius:4px;font-size:10px;font-weight:700;margin-left:5px;cursor:help" title="${escapeHtml((r.duplicateOf||[]).join(', '))}">DUP</span>` : '';
    const rowClass = r.hasNote ? ' style="background:rgba(251,191,36,0.1)"' : '';

    html += `<tr${rowClass}>
      <td style="padding:10px 12px;border-bottom:1px solid #e5e7eb;font-size:12px"><input type="checkbox" class="row-select" ${checked} onchange="toggleSelect('${escapeJs(r.accountKey)}', this.checked)" style="width:16px;height:16px;cursor:pointer;accent-color:#0ea5e9" /></td>
      <td style="padding:10px 12px;border-bottom:1px solid #e5e7eb;font-size:12px"><span onclick="openNoteModal('${escapeJs(r.accountKey)}','${escapeJs(r.propertyName)}','${escapeJs(r.vendorName)}','${escapeJs(r.accountNumber)}')" style="cursor:pointer">${noteIcon}</span></td>
      <td style="padding:10px 12px;border-bottom:1px solid #e5e7eb;font-size:12px"><span onclick="openEditModal('${escapeJs(r.accountKey)}','${escapeJs(r.propertyId)}','${escapeJs(r.propertyName)}','${escapeJs(r.vendorId)}','${escapeJs(r.vendorName)}','${escapeJs(r.accountNumber)}')" style="cursor:pointer;opacity:.5" onmouseover="this.style.opacity=1" onmouseout="this.style.opacity=.5">&#9998;</span></td>
      <td style="padding:10px 12px;border-bottom:1px solid #e5e7eb;font-size:12px">${statusBadge}</td>
      <td style="padding:10px 12px;border-bottom:1px solid #e5e7eb;font-size:12px">${escapeHtml(r.propertyName)}</td>
      <td style="padding:10px 12px;border-bottom:1px solid #e5e7eb;font-size:12px">${escapeHtml(r.vendorName)}</td>
      <td style="padding:10px 12px;border-bottom:1px solid #e5e7eb;font-size:12px"><span style="cursor:pointer;border-bottom:1px dashed #94a3b8" onclick="navigator.clipboard.writeText('${escapeJs(r.accountNumber)}');showToast('Copied!','ok')" title="Click to copy">${escapeHtml(r.accountNumber)}</span>${dupBadge}</td>
      <td style="padding:10px 12px;border-bottom:1px solid #e5e7eb;font-size:12px">${escapeHtml(r.apName)}</td>
      <td style="padding:10px 12px;border-bottom:1px solid #e5e7eb;font-size:12px">${r.nextExpectedDate || ''}</td>
      <td style="padding:10px 12px;border-bottom:1px solid #e5e7eb;font-size:12px;font-weight:600;color:${r.daysOverdue > 0 ? '#b91c1c' : '#166534'}">${r.daysOverdue}</td>
      <td style="padding:10px 12px;border-bottom:1px solid #e5e7eb;font-size:12px">${r.lastBillDate || ''}</td>
      <td style="padding:10px 12px;border-bottom:1px solid #e5e7eb;font-size:12px">${viewLink}</td>
      <td style="padding:10px 12px;border-bottom:1px solid #e5e7eb;font-size:12px">${r.servicePeriodDays || ''}</td>
      <td style="padding:10px 12px;border-bottom:1px solid #e5e7eb;font-size:12px">${scraperBadge}</td>
    </tr>`;
  }
  tbody.innerHTML = html;
}

function toggleSelect(key, checked) {
  if (checked) selectedKeys.add(key); else selectedKeys.delete(key);
  updateBulkToolbar();
}

function updateBulkToolbar() {
  const toolbar = document.getElementById('bulkToolbar');
  const count = selectedKeys.size;
  document.getElementById('selCount').textContent = count + ' selected';
  toolbar.style.bottom = count > 0 ? '24px' : '-70px';
}

/* Note modal */
let currentNoteKey = '';
function openNoteModal(accountKey, propName, vendorName, acctNum) {
  currentNoteKey = accountKey;
  document.getElementById('noteAccountInfo').textContent = `${propName} / ${vendorName} / ${acctNum}`;
  const existing = allData.find(r => r.accountKey === accountKey);
  const note = existing && existing.note;
  document.getElementById('noteReasonCode').value = (note && note.reasonCode) || '';
  document.getElementById('noteText').value = (note && note.notes) || '';
  document.getElementById('noteModal').style.display = 'flex';
}

async function saveNote() {
  const fd = new FormData();
  fd.append('accountKey', currentNoteKey);
  fd.append('reasonCode', document.getElementById('noteReasonCode').value);
  fd.append('notes', document.getElementById('noteText').value);
  try {
    const resp = await fetch('/api/workflow/notes', {method:'POST', body:fd});
    const data = await resp.json();
    if (data.ok) {
      showToast('Note saved', 'ok');
      document.getElementById('noteModal').style.display = 'none';
      const row = allData.find(r => r.accountKey === currentNoteKey);
      if (row) {
        row.note = {reasonCode: document.getElementById('noteReasonCode').value, notes: document.getElementById('noteText').value};
        row.hasNote = true;
      }
      applyTableFilters();
    } else { showToast('Error saving note', 'err'); }
  } catch (e) { showToast('Error: ' + e.message, 'err'); }
}

async function clearNote() {
  const fd = new FormData();
  fd.append('accountKey', currentNoteKey);
  fd.append('clear', '1');
  try {
    await fetch('/api/workflow/notes', {method:'POST', body:fd});
    showToast('Note cleared', 'ok');
    document.getElementById('noteModal').style.display = 'none';
    const row = allData.find(r => r.accountKey === currentNoteKey);
    if (row) { row.note = null; row.hasNote = false; }
    applyTableFilters();
  } catch (e) { showToast('Error: ' + e.message, 'err'); }
}

/* Edit modal */
let currentEditKey = '';
let currentEditProp = '';
let currentEditVendor = '';

function openEditModal(accountKey, propId, propName, vendorId, vendorName, acctNum) {
  currentEditKey = accountKey;
  currentEditProp = propId;
  currentEditVendor = vendorId;
  document.getElementById('editAccountInfo').textContent = `${acctNum} — ${propName} / ${vendorName}`;
  document.getElementById('editModal').style.display = 'flex';
  renderEditPropList();
  renderEditVendorList();
}

async function loadCatalogs() {
  try {
    const [propResp, vendResp] = await Promise.all([
      fetch('/api/properties'),
      fetch('/api/vendors')
    ]);
    catalogProperties = await propResp.json();
    catalogVendors = await vendResp.json();
  } catch (e) { /* non-fatal */ }
}

function renderEditPropList() {
  const search = (document.getElementById('editPropSearch').value || '').toLowerCase();
  const list = document.getElementById('editPropList');
  const filtered = catalogProperties.filter(p => !search || (p.name || '').toLowerCase().includes(search));
  list.innerHTML = filtered.slice(0, 50).map(p =>
    `<div style="padding:10px 12px;cursor:pointer;border-bottom:1px solid #f1f5f9;font-size:13px${p.id === currentEditProp ? ';background:#dbeafe;font-weight:600' : ''}" onclick="currentEditProp='${p.id}';renderEditPropList()" onmouseover="this.style.background='#f0f9ff'" onmouseout="this.style.background='${p.id === currentEditProp ? '#dbeafe' : ''}'">${escapeHtml(p.name)}</div>`
  ).join('');
  document.getElementById('editPropSearch').oninput = () => renderEditPropList();
}

function renderEditVendorList() {
  const search = (document.getElementById('editVendorSearch').value || '').toLowerCase();
  const list = document.getElementById('editVendorList');
  const filtered = catalogVendors.filter(v => !search || (v.name || '').toLowerCase().includes(search));
  list.innerHTML = filtered.slice(0, 50).map(v =>
    `<div style="padding:10px 12px;cursor:pointer;border-bottom:1px solid #f1f5f9;font-size:13px${v.id === currentEditVendor ? ';background:#dbeafe;font-weight:600' : ''}" onclick="currentEditVendor='${v.id}';renderEditVendorList()" onmouseover="this.style.background='#f0f9ff'" onmouseout="this.style.background='${v.id === currentEditVendor ? '#dbeafe' : ''}'">${escapeHtml(v.name)}</div>`
  ).join('');
  document.getElementById('editVendorSearch').oninput = () => renderEditVendorList();
}

document.getElementById('editSave')?.addEventListener('click', async () => {
  const fd = new FormData();
  fd.append('accountKey', currentEditKey);
  fd.append('propertyId', currentEditProp);
  fd.append('vendorId', currentEditVendor);
  try {
    const resp = await fetch('/api/workflow/accounts/update', {method:'POST', body:fd});
    const data = await resp.json();
    if (data.ok) {
      showToast('Account updated', 'ok');
      document.getElementById('editModal').style.display = 'none';
      loadLateBillsData();
    } else { showToast(data.error || 'Error', 'err'); }
  } catch (e) { showToast('Error: ' + e.message, 'err'); }
});

document.getElementById('editDelete')?.addEventListener('click', async () => {
  if (!confirm('Delete this account from tracking?')) return;
  const fd = new FormData();
  fd.append('accountKey', currentEditKey);
  fd.append('action', 'archive');
  try {
    const resp = await fetch('/api/workflow/accounts/archive', {method:'POST', body:fd});
    const data = await resp.json();
    if (data.ok) {
      showToast('Account archived', 'ok');
      document.getElementById('editModal').style.display = 'none';
      loadLateBillsData();
    } else { showToast(data.error || 'Error', 'err'); }
  } catch (e) { showToast('Error: ' + e.message, 'err'); }
});

/* Recalculate */
async function triggerRecalculate() {
  document.getElementById('tableRecalcBtn').disabled = true;
  document.getElementById('tableRecalcBtn').textContent = 'Recalculating...';
  showToast('Recalculation started...', 'ok');
  try {
    await fetch('/api/workflow/recalculate', {method:'POST'});
    let attempts = 0;
    const poll = setInterval(async () => {
      attempts++;
      try {
        const resp = await fetch('/api/workflow');
        const data = await resp.json();
        if (data.computedAt || attempts > 30) {
          clearInterval(poll);
          document.getElementById('tableRecalcBtn').disabled = false;
          document.getElementById('tableRecalcBtn').textContent = 'Recalculate';
          if (data.computedAt) {
            showToast('Recalculation complete!', 'ok');
            allData = data.rows || [];
            applyTableFilters();
            document.getElementById('lastUpdated').textContent = 'Updated: ' + data.computedAt;
          }
        }
      } catch (e) { /* keep polling */ }
    }, 3000);
  } catch (e) {
    showToast('Recalculation error: ' + e.message, 'err');
    document.getElementById('tableRecalcBtn').disabled = false;
    document.getElementById('tableRecalcBtn').textContent = 'Recalculate';
  }
}
</script>
</body>
</html>
