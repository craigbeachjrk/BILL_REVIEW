<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Tools</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root { --bg:#dc2626; --bg2:#991b1b; --glass:rgba(255,255,255,.92); --border:rgba(255,255,255,.33); }
    body{font-family:Inter,system-ui,sans-serif;margin:0;background:linear-gradient(135deg,var(--bg),var(--bg2));min-height:100vh;color:#0f172a}
    header.top{position:sticky;top:0;display:flex;justify-content:space-between;align-items:center;padding:14px 20px;color:#fff;z-index:100}
    header a{color:#fff;text-decoration:none;font-weight:600}
    .btn{display:inline-block;padding:10px 20px;border-radius:10px;border:none;background:#dc2626;color:#fff;cursor:pointer;text-decoration:none;font-family:inherit;font-size:14px;font-weight:600}
    .btn:hover{background:#b91c1c}
    .btn:disabled{background:#9ca3af;cursor:not-allowed}
    .btn.secondary{background:#64748b}
    .btn.secondary:hover{background:#475569}
    .wrap{max-width:900px;margin:20px auto;padding:0 20px}
    .card{background:var(--glass);backdrop-filter:blur(10px);border:1px solid var(--border);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.12);padding:24px;margin-bottom:20px}
    h1{margin:0 0 8px 0;font-size:24px;color:#1e1b4b}
    h2{margin:0 0 16px 0;font-size:18px;color:#991b1b}
    .subtitle{color:#6b7280;margin-bottom:24px}
    .tool{padding:16px;background:#f8fafc;border-radius:12px;margin-bottom:16px;border:1px solid #e2e8f0}
    .tool h3{margin:0 0 8px 0;font-size:16px;color:#1e293b}
    .tool p{margin:0 0 12px 0;font-size:13px;color:#64748b}
    .tool-row{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
    .tool-row select,.tool-row input{padding:8px 12px;border:1px solid #e5e7eb;border-radius:8px;font-size:14px;font-family:inherit}
    .result{margin-top:12px;padding:12px;background:#f1f5f9;border-radius:8px;font-size:13px;font-family:'SF Mono',Monaco,Consolas,monospace;display:none}
    .result.show{display:block}
    .result.error{background:#fee2e2;color:#991b1b}
    .result.success{background:#dcfce7;color:#166534}
    .spinner{display:inline-block;width:14px;height:14px;border:2px solid #fff;border-top-color:transparent;border-radius:50%;animation:spin 0.8s linear infinite;margin-right:8px;vertical-align:middle}
    @keyframes spin{to{transform:rotate(360deg)}}
    .warning{background:#fef3c7;border:1px solid #fcd34d;border-radius:8px;padding:12px;margin-bottom:16px;font-size:13px;color:#92400e}
  </style>
</head>
<body>
  <header class="top">
    <a href="/">Bill Review @ JRK</a>
    <div>
      <span style="margin-right:16px">Admin Tools</span>
      <a href="/" class="btn secondary">Back to Dashboard</a>
    </div>
  </header>

  <div class="wrap">
    <div class="card">
      <h1>Admin Tools</h1>
      <p class="subtitle">Administrative operations for data maintenance and backfills.</p>

      <div class="warning">
        These operations modify data. Use with caution.
      </div>

      <div class="tool">
        <h3>Backfill Late Fees</h3>
        <p>Calculate late fees for posted invoices that don't have late_fee data yet. Scans line item descriptions for late fee patterns.</p>
        <div class="tool-row">
          <label>Weeks to backfill:</label>
          <select id="lateFeeWeeks">
            <option value="6" selected>6 weeks (recommended)</option>
            <option value="12">12 weeks</option>
            <option value="26">26 weeks (6 months)</option>
            <option value="52">52 weeks (1 year)</option>
            <option value="0">All history</option>
          </select>
          <button class="btn" id="btnBackfillLateFees" onclick="runBackfillLateFees()">Run Backfill</button>
        </div>
        <div class="result" id="resultLateFees"></div>
      </div>

      <div class="tool">
        <h3>Backfill Posted Metadata</h3>
        <p>Rebuild DynamoDB metadata for all posted invoices (Stage 7 + Archive). This also calculates late fees. Use if metadata is missing or corrupted.</p>
        <div class="tool-row">
          <button class="btn" id="btnBackfillMeta" onclick="runBackfillMeta()">Run Full Backfill</button>
        </div>
        <div class="result" id="resultMeta"></div>
      </div>

      <div class="tool">
        <h3>View Late Fee Analysis</h3>
        <p>Open the late fee analysis API to see current data.</p>
        <div class="tool-row">
          <a href="/api/metrics/late-fees?weeks=6" target="_blank" class="btn secondary">View Late Fees (6 weeks)</a>
        </div>
      </div>

    </div>
  </div>

  <script>
    async function runBackfillLateFees() {
      const btn = document.getElementById('btnBackfillLateFees');
      const result = document.getElementById('resultLateFees');
      const weeks = document.getElementById('lateFeeWeeks').value;

      btn.disabled = true;
      btn.innerHTML = '<span class="spinner"></span>Running...';
      result.className = 'result show';
      result.textContent = 'Processing... This may take a minute.';

      try {
        const resp = await fetch(`/api/admin/backfill-late-fees?weeks=${weeks}`, {
          method: 'POST',
          credentials: 'same-origin'
        });
        const data = await resp.json();

        if (data.ok) {
          result.className = 'result show success';
          result.textContent = `Success! Updated: ${data.updated}, Skipped: ${data.skipped}, Errors: ${data.errors}, Time: ${data.elapsed_seconds}s`;
        } else {
          result.className = 'result show error';
          result.textContent = `Error: ${data.error || data.detail || JSON.stringify(data)}`;
        }
      } catch (err) {
        result.className = 'result show error';
        result.textContent = `Error: ${err.message}`;
      }

      btn.disabled = false;
      btn.textContent = 'Run Backfill';
    }

    async function runBackfillMeta() {
      const btn = document.getElementById('btnBackfillMeta');
      const result = document.getElementById('resultMeta');

      if (!confirm('This will rebuild ALL posted invoice metadata. This may take several minutes. Continue?')) {
        return;
      }

      btn.disabled = true;
      btn.innerHTML = '<span class="spinner"></span>Running...';
      result.className = 'result show';
      result.textContent = 'Processing... This may take several minutes for large datasets.';

      try {
        const resp = await fetch('/api/admin/backfill-posted-metadata', {
          method: 'POST',
          credentials: 'same-origin'
        });
        const data = await resp.json();

        if (data.ok) {
          result.className = 'result show success';
          result.textContent = `Success! Written: ${data.written}, Skipped: ${data.skipped}, Errors: ${data.errors}, Time: ${data.elapsed_seconds}s`;
        } else {
          result.className = 'result show error';
          result.textContent = `Error: ${data.error || data.detail || JSON.stringify(data)}`;
        }
      } catch (err) {
        result.className = 'result show error';
        result.textContent = `Error: ${err.message}`;
      }

      btn.disabled = false;
      btn.textContent = 'Run Full Backfill';
    }
  </script>
</body>
</html>
