<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>REVIEW CHECKS &middot; Bill Review</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root { --bg:#0ea5e9; --bg2:#4338ca; --glass:rgba(255,255,255,.72); --border:rgba(255,255,255,.33); }
    *{box-sizing:border-box}
    body{font-family:Inter,system-ui,sans-serif;margin:0;background:linear-gradient(135deg,var(--bg),var(--bg2));min-height:100vh;color:#0f172a}
    header.top{position:sticky;top:0;display:flex;justify-content:space-between;align-items:center;padding:12px 20px;color:#fff;z-index:100;background:rgba(0,0,0,0.1)}
    .logout{display:flex;gap:8px;align-items:center}
    .logout form{display:inline}
    .btn{display:inline-block;padding:8px 12px;border-radius:10px;border:none;background:#0ea5e9;color:#fff;cursor:pointer;text-decoration:none;font-size:14px}
    .btn.secondary{background:#64748b}
    .btn.success{background:#059669}
    .btn.danger{background:#dc2626}
    .btn.small{padding:6px 10px;font-size:12px}
    .btn:disabled{opacity:0.5;cursor:not-allowed}
    .toast{position:fixed;top:20px;right:20px;background:#111827;color:#fff;padding:12px 16px;border-radius:10px;box-shadow:0 8px 20px rgba(0,0,0,.25);z-index:9999;opacity:0;transition:opacity .3s}
    .toast.show{opacity:.96}
    .toast.ok{background:#0f766e}
    .toast.err{background:#b91c1c}

    /* Three-Panel Layout */
    .main-container{display:grid;grid-template-columns:280px 320px 1fr;height:calc(100vh - 56px);gap:0}

    /* Left Panel - Check Slips List */
    .slips-panel{background:#fff;border-right:1px solid #e5e7eb;display:flex;flex-direction:column}
    .panel-header{padding:12px 16px;border-bottom:1px solid #e5e7eb;background:#f8fafc}
    .panel-header h2{margin:0;font-size:14px;color:#1e293b}
    .panel-controls{padding:12px;border-bottom:1px solid #e5e7eb;display:flex;gap:8px;align-items:center}
    .panel-controls input[type="date"]{padding:6px 10px;border:1px solid #e5e7eb;border-radius:6px;font-size:13px}
    .slips-list{flex:1;overflow-y:auto;padding:8px}

    .slip-item{padding:12px;border:2px solid #e5e7eb;border-radius:10px;margin-bottom:8px;cursor:pointer;background:#fff;transition:all .15s}
    .slip-item:hover{background:#f0f9ff;border-color:#bae6fd}
    .slip-item.selected{background:#dbeafe;border-color:#3b82f6}
    .slip-item.completed{background:#d1fae5;border-color:#10b981}
    .slip-vendor{font-weight:600;font-size:13px;color:#1e293b;margin-bottom:4px}
    .slip-meta{font-size:12px;color:#64748b}
    .slip-amount{font-weight:600;color:#059669}
    .slip-status{display:inline-block;font-size:10px;padding:2px 6px;border-radius:4px;font-weight:600;margin-left:8px}
    .slip-status.pending{background:#fef3c7;color:#d97706}
    .slip-status.approved{background:#d1fae5;color:#059669}
    .slip-progress{margin-top:6px;font-size:11px;color:#64748b}
    .slip-progress-bar{height:4px;background:#e5e7eb;border-radius:2px;margin-top:4px;overflow:hidden}
    .slip-progress-fill{height:100%;background:#3b82f6;transition:width .3s}

    /* Middle Panel - Invoices List */
    .invoices-panel{background:#f8fafc;border-right:1px solid #e5e7eb;display:flex;flex-direction:column}
    .invoices-list{flex:1;overflow-y:auto;padding:8px}
    .invoice-placeholder{display:flex;align-items:center;justify-content:center;height:100%;color:#94a3b8;font-size:14px}

    .invoice-item{display:flex;align-items:center;gap:12px;padding:12px;border:2px solid #e5e7eb;border-radius:10px;margin-bottom:8px;cursor:pointer;background:#fff;transition:all .15s}
    .invoice-item:hover{background:#f0f9ff;border-color:#bae6fd}
    .invoice-item.selected{background:#dbeafe;border-color:#3b82f6}
    .invoice-item.reviewed{background:#d1fae5;border-color:#10b981}
    .invoice-checkbox{width:32px;height:32px;border:3px solid #94a3b8;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:20px;color:#fff;flex-shrink:0;transition:all .15s;cursor:pointer;background:#f1f5f9;user-select:none}
    .invoice-checkbox:hover{border-color:#3b82f6;background:#dbeafe;transform:scale(1.1)}
    .invoice-checkbox:active{transform:scale(0.95)}
    .invoice-item.reviewed .invoice-checkbox{background:#10b981;border-color:#10b981;color:#fff}
    .invoice-item.reviewed .invoice-checkbox:hover{background:#059669;border-color:#059669}
    .invoice-details{flex:1;min-width:0}
    .invoice-property{font-weight:600;font-size:12px;color:#1e293b;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .invoice-account{font-size:11px;color:#64748b}
    .invoice-amount{font-weight:600;font-size:13px;color:#059669;flex-shrink:0}

    /* Complete Button */
    .complete-section{padding:12px;border-top:1px solid #e5e7eb;background:#fff}
    .complete-btn{width:100%;padding:14px;font-size:15px;font-weight:600;border-radius:10px}
    .complete-btn:disabled{background:#94a3b8}
    .review-stats{text-align:center;font-size:12px;color:#64748b;margin-bottom:8px}
    .review-subtotal{text-align:center;font-size:13px;color:#1e293b;font-weight:600;margin-bottom:8px;padding:8px;background:#f0fdf4;border-radius:8px}

    /* Right Panel - PDF Viewer */
    .pdf-panel{background:#1e293b;display:flex;flex-direction:column}
    .pdf-header{padding:12px 16px;background:#0f172a;color:#fff;display:flex;justify-content:space-between;align-items:center}
    .pdf-header h3{margin:0;font-size:13px;font-weight:500}
    .pdf-container{flex:1;display:flex;align-items:center;justify-content:center}
    .pdf-placeholder{color:#64748b;font-size:14px}
    .pdf-container iframe{width:100%;height:100%;border:none}
    .pdf-actions{padding:12px;background:#0f172a;display:flex;gap:8px;justify-content:center}
    .mark-reviewed-btn{padding:12px 32px;font-size:14px;font-weight:600}

    /* Summary Bar */
    .summary-bar{display:flex;gap:16px;padding:8px 16px;background:rgba(255,255,255,0.9);border-bottom:1px solid #e5e7eb}
    .summary-item{font-size:12px}
    .summary-label{color:#64748b}
    .summary-value{font-weight:600;margin-left:4px}

    .empty-state{display:flex;align-items:center;justify-content:center;height:100%;color:#94a3b8;font-size:14px;text-align:center;padding:20px}

    /* PDF Error Badge */
    .pdf-error-badge{display:inline-block;background:#fef2f2;color:#dc2626;font-size:10px;padding:2px 6px;border-radius:4px;font-weight:600;margin-left:8px;cursor:pointer}
    .pdf-error-badge:hover{background:#fee2e2}

    /* Error Modal */
    .error-modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;display:none;align-items:center;justify-content:center}
    .error-modal-overlay.show{display:flex}
    .error-modal{background:#fff;border-radius:12px;max-width:500px;width:90%;max-height:80vh;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,0.3)}
    .error-modal-header{padding:16px 20px;background:#fef2f2;border-bottom:1px solid #fecaca;display:flex;justify-content:space-between;align-items:center}
    .error-modal-header h3{margin:0;color:#dc2626;font-size:16px}
    .error-modal-close{background:none;border:none;font-size:24px;cursor:pointer;color:#94a3b8;padding:0;line-height:1}
    .error-modal-close:hover{color:#1e293b}
    .error-modal-body{padding:20px;max-height:400px;overflow-y:auto}
    .error-item{padding:12px;background:#fef2f2;border-radius:8px;margin-bottom:8px;border-left:4px solid #dc2626}
    .error-property{font-weight:600;font-size:13px;color:#1e293b}
    .error-message{font-size:12px;color:#dc2626;margin-top:4px}
    .error-modal-actions{padding:16px 20px;border-top:1px solid #e5e7eb;display:flex;gap:8px;justify-content:flex-end}
  </style>
</head>
<body>

<header class="top">
  <strong style="font-size:16px">REVIEW CHECKS</strong>
  <div class="logout">
    <a href="/" class="btn secondary small">Home</a>
    <form method="post" action="/logout"><button class="btn small" type="submit">Logout</button></form>
  </div>
</header>

<div id="toast" class="toast"></div>

<!-- PDF Error Modal -->
<div class="error-modal-overlay" id="errorModal">
  <div class="error-modal">
    <div class="error-modal-header">
      <h3>PDF Generation Errors</h3>
      <button class="error-modal-close" onclick="closeErrorModal()">&times;</button>
    </div>
    <div class="error-modal-body" id="errorModalBody">
      <!-- Errors populated dynamically -->
    </div>
    <div class="error-modal-actions">
      <button class="btn secondary" onclick="closeErrorModal()">Close</button>
      <button class="btn" onclick="regenerateSelectedPdf()">Regenerate PDF</button>
    </div>
  </div>
</div>

<div class="main-container">
  <!-- Left Panel: Check Slips -->
  <div class="slips-panel">
    <div class="panel-header">
      <h2>Check Slips</h2>
    </div>
    <div class="panel-controls">
      <input type="date" id="reviewDate" />
      <button class="btn small" onclick="loadSlips()">Load</button>
    </div>
    <div class="summary-bar">
      <div class="summary-item"><span class="summary-label">Pending:</span><span class="summary-value" id="pendingCount">0</span></div>
      <div class="summary-item"><span class="summary-label">Done:</span><span class="summary-value" id="approvedCount">0</span></div>
    </div>
    <div class="slips-list" id="slipsList">
      <div class="empty-state">Loading...</div>
    </div>
  </div>

  <!-- Middle Panel: Invoices -->
  <div class="invoices-panel">
    <div class="panel-header">
      <h2>Invoices to Review</h2>
    </div>
    <div class="invoices-list" id="invoicesList">
      <div class="invoice-placeholder">Select a check slip</div>
    </div>
    <div class="complete-section" id="completeSection" style="display:none">
      <div class="review-subtotal" id="reviewSubtotal"></div>
      <div class="review-stats" id="reviewStats">0 of 0 reviewed</div>
      <button class="btn success complete-btn" id="completeBtn" disabled onclick="completeCheckSlip()">
        Complete Check Slip
      </button>
    </div>
  </div>

  <!-- Right Panel: PDF Viewer -->
  <div class="pdf-panel">
    <div class="pdf-header">
      <h3 id="pdfTitle">Invoice PDF</h3>
      <a id="pdfDownload" href="#" target="_blank" class="btn small secondary" style="display:none">Open in New Tab</a>
    </div>
    <div class="pdf-container" id="pdfContainer">
      <div class="pdf-placeholder">Click an invoice to view PDF</div>
    </div>
    <div class="pdf-actions" id="pdfActions" style="display:none">
      <button class="btn success mark-reviewed-btn" id="markReviewedBtn" onclick="markCurrentAsReviewed()">
        ✓ Mark as Reviewed
      </button>
    </div>
  </div>
</div>

<script>
  let allSlips = [];
  let selectedSlip = null;
  let selectedInvoiceIndex = -1;
  let reviewedInvoices = new Set(); // Track which invoices have been reviewed

  function showToast(msg, type) {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.className = 'toast ' + (type === 'ok' ? 'ok' : 'err');
    t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 3000);
  }

  function formatCurrency(val) {
    return '$' + parseFloat(val || 0).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
  }

  function escapeHtml(str) {
    if (!str) return '';
    return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
  }

  // Initialize
  document.addEventListener('DOMContentLoaded', () => {
    // Use LOCAL date, not UTC (toISOString gives UTC which can be wrong timezone)
    const today = new Date();
    const year = today.getFullYear();
    const month = String(today.getMonth() + 1).padStart(2, '0');
    const day = String(today.getDate()).padStart(2, '0');
    document.getElementById('reviewDate').value = `${year}-${month}-${day}`;
    loadSlips();
  });

  async function loadSlips() {
    const date = document.getElementById('reviewDate').value;
    document.getElementById('slipsList').innerHTML = '<div class="empty-state">Loading...</div>';
    resetInvoicePanel();
    resetPdfPanel();

    try {
      const resp = await fetch(`/api/review-checks/pending?date=${date}`);
      if (!resp.ok) throw new Error('Failed to load');

      const data = await resp.json();
      allSlips = [...(data.pending || []), ...(data.approved || [])];

      document.getElementById('pendingCount').textContent = data.pending_count || 0;
      document.getElementById('approvedCount').textContent = data.approved_count || 0;

      renderSlipsList();
    } catch (e) {
      showToast('Error loading check slips', 'err');
      document.getElementById('slipsList').innerHTML = '<div class="empty-state">Failed to load</div>';
    }
  }

  function renderSlipsList() {
    const container = document.getElementById('slipsList');

    if (!allSlips.length) {
      container.innerHTML = '<div class="empty-state">No check slips for this date</div>';
      return;
    }

    let html = '';
    allSlips.forEach(slip => {
      const isSelected = selectedSlip && slip.check_slip_id === selectedSlip.check_slip_id;
      const isApproved = slip.status === 'APPROVED';
      const invoiceCount = slip.invoice_count || 0;
      const pdfErrors = slip.pdf_errors || [];
      const hasErrors = pdfErrors.length > 0;

      html += `
        <div class="slip-item ${isSelected ? 'selected' : ''} ${isApproved ? 'completed' : ''}"
             onclick="selectSlip('${slip.check_slip_id}')">
          <div class="slip-vendor">
            ${escapeHtml(slip.vendor_name)}
            <span class="slip-status ${slip.status.toLowerCase()}">${slip.status}</span>
            ${hasErrors ? `<span class="pdf-error-badge" onclick="event.stopPropagation(); showPdfErrors('${slip.check_slip_id}')">${pdfErrors.length} PDF Error${pdfErrors.length > 1 ? 's' : ''}</span>` : ''}
          </div>
          <div class="slip-meta">
            <span>${invoiceCount} invoice${invoiceCount !== 1 ? 's' : ''}</span> ·
            <span class="slip-amount">${formatCurrency(slip.total_amount)}</span>
          </div>
          <div style="font-size:11px;color:#94a3b8;margin-top:4px">By: ${escapeHtml(slip.created_by)}</div>
        </div>
      `;
    });

    container.innerHTML = html;
  }

  async function selectSlip(slipId) {
    resetPdfPanel();
    reviewedInvoices.clear();
    selectedInvoiceIndex = -1;

    try {
      const resp = await fetch(`/api/review-checks/slip/${slipId}`);
      if (!resp.ok) throw new Error('Failed to load');

      selectedSlip = await resp.json();
      renderSlipsList();
      renderInvoicesList();
    } catch (e) {
      showToast('Error loading slip details', 'err');
    }
  }

  function renderInvoicesList() {
    const container = document.getElementById('invoicesList');
    const completeSection = document.getElementById('completeSection');

    if (!selectedSlip) {
      container.innerHTML = '<div class="invoice-placeholder">Select a check slip</div>';
      completeSection.style.display = 'none';
      return;
    }

    const invoices = selectedSlip.invoices || [];
    const isApproved = selectedSlip.status === 'APPROVED';

    if (isApproved) {
      // Already approved - show invoices but no actions needed
      let html = '<div style="padding:8px;color:#059669;font-size:12px;font-weight:600;text-align:center;background:#d1fae5;border-radius:8px;margin-bottom:8px">✓ APPROVED</div>';
      invoices.forEach((inv, idx) => {
        html += `
          <div class="invoice-item reviewed" onclick="viewInvoicePdf(${idx})">
            <div class="invoice-checkbox">✓</div>
            <div class="invoice-details">
              <div class="invoice-property">${escapeHtml(inv.property_name)}</div>
              <div class="invoice-account">${escapeHtml(inv.account_number)}</div>
            </div>
            <div class="invoice-amount">${formatCurrency(inv.invoice_total)}</div>
          </div>
        `;
      });
      container.innerHTML = html;
      completeSection.style.display = 'none';
      return;
    }

    // Pending - show with review checkboxes
    let html = '<div style="padding:8px 12px;background:#fef3c7;border-radius:8px;margin-bottom:8px;font-size:12px;color:#92400e;text-align:center"><strong>Click each ☐ checkbox</strong> to mark invoices as reviewed</div>';
    invoices.forEach((inv, idx) => {
      const isReviewed = reviewedInvoices.has(idx);
      const isSelected = idx === selectedInvoiceIndex;
      html += `
        <div class="invoice-item ${isReviewed ? 'reviewed' : ''} ${isSelected ? 'selected' : ''}"
             onclick="viewInvoicePdf(${idx})">
          <div class="invoice-checkbox" onclick="event.stopPropagation(); toggleReviewed(${idx})" title="Click to mark reviewed">${isReviewed ? '✓' : '☐'}</div>
          <div class="invoice-details">
            <div class="invoice-property">${escapeHtml(inv.property_name)}</div>
            <div class="invoice-account">${escapeHtml(inv.account_number)}</div>
          </div>
          <div class="invoice-amount">${formatCurrency(inv.invoice_total)}</div>
        </div>
      `;
    });

    container.innerHTML = html;
    completeSection.style.display = 'block';
    updateReviewStats();
  }

  function viewInvoicePdf(index) {
    if (!selectedSlip) return;

    selectedInvoiceIndex = index;
    renderInvoicesList();

    const inv = selectedSlip.invoices[index];
    const pdfUrl = `/api/review-checks/slip/${selectedSlip.check_slip_id}/invoice/${index}/pdf`;

    document.getElementById('pdfTitle').textContent = `${inv.property_name} - ${inv.account_number}`;
    document.getElementById('pdfDownload').href = pdfUrl;
    document.getElementById('pdfDownload').style.display = 'inline-block';

    document.getElementById('pdfContainer').innerHTML = `<iframe src="${pdfUrl}"></iframe>`;

    // Show mark as reviewed button only if not already reviewed and slip is pending
    const pdfActions = document.getElementById('pdfActions');
    const isReviewed = reviewedInvoices.has(index);
    const isPending = selectedSlip.status === 'PENDING';

    if (isPending && !isReviewed) {
      pdfActions.style.display = 'flex';
    } else {
      pdfActions.style.display = 'none';
    }
  }

  function markCurrentAsReviewed() {
    if (selectedInvoiceIndex < 0) return;

    reviewedInvoices.add(selectedInvoiceIndex);
    renderInvoicesList();

    // Hide the button after marking
    document.getElementById('pdfActions').style.display = 'none';

    // Auto-advance to next unreviewed invoice
    const invoices = selectedSlip.invoices || [];
    for (let i = 0; i < invoices.length; i++) {
      if (!reviewedInvoices.has(i)) {
        viewInvoicePdf(i);
        return;
      }
    }

    // All reviewed - show success message
    showToast('All invoices reviewed! Click Complete to finish.', 'ok');
  }

  // Toggle reviewed state by clicking the checkbox directly
  function toggleReviewed(index) {
    if (reviewedInvoices.has(index)) {
      reviewedInvoices.delete(index);
    } else {
      reviewedInvoices.add(index);
    }
    renderInvoicesList();

    // Check if all reviewed
    const invoices = selectedSlip ? selectedSlip.invoices || [] : [];
    if (reviewedInvoices.size >= invoices.length && invoices.length > 0) {
      showToast('All invoices reviewed! Click Complete to finish.', 'ok');
    }
  }

  function updateReviewStats() {
    const invoices = selectedSlip ? selectedSlip.invoices || [] : [];
    const total = invoices.length;
    const reviewed = reviewedInvoices.size;

    // Calculate dollar subtotals
    let reviewedAmount = 0;
    let totalAmount = 0;
    invoices.forEach((inv, idx) => {
      const amt = parseFloat(inv.invoice_total || 0);
      totalAmount += amt;
      if (reviewedInvoices.has(idx)) reviewedAmount += amt;
    });

    document.getElementById('reviewStats').textContent = `${reviewed} of ${total} invoices reviewed`;

    const subtotalEl = document.getElementById('reviewSubtotal');
    subtotalEl.innerHTML = `${formatCurrency(reviewedAmount)} <span style="color:#64748b;font-weight:400">of</span> ${formatCurrency(totalAmount)} <span style="color:#64748b;font-weight:400">checked</span>`;

    const completeBtn = document.getElementById('completeBtn');
    completeBtn.disabled = reviewed < total;

    if (reviewed >= total && total > 0) {
      completeBtn.textContent = '✓ Complete Check Slip';
    } else {
      completeBtn.textContent = `Complete Check Slip (${total - reviewed} remaining)`;
    }
  }

  async function completeCheckSlip() {
    if (!selectedSlip) return;

    const invoices = selectedSlip.invoices || [];
    if (reviewedInvoices.size < invoices.length) {
      showToast('Please review all invoices first', 'err');
      return;
    }

    try {
      const resp = await fetch(`/api/review-checks/approve/${selectedSlip.check_slip_id}`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({notes: 'All invoices reviewed'})
      });

      if (!resp.ok) {
        const err = await resp.json();
        throw new Error(err.error || 'Failed to complete');
      }

      showToast('Check slip completed!', 'ok');

      // Reload to refresh status
      const slipId = selectedSlip.check_slip_id;
      await loadSlips();

      // Re-select the completed slip
      selectSlip(slipId);

    } catch (e) {
      showToast('Error: ' + e.message, 'err');
    }
  }

  function resetInvoicePanel() {
    selectedSlip = null;
    selectedInvoiceIndex = -1;
    reviewedInvoices.clear();
    document.getElementById('invoicesList').innerHTML = '<div class="invoice-placeholder">Select a check slip</div>';
    document.getElementById('completeSection').style.display = 'none';
  }

  function resetPdfPanel() {
    document.getElementById('pdfTitle').textContent = 'Invoice PDF';
    document.getElementById('pdfDownload').style.display = 'none';
    document.getElementById('pdfContainer').innerHTML = '<div class="pdf-placeholder">Click an invoice to view PDF</div>';
    document.getElementById('pdfActions').style.display = 'none';
  }

  // PDF Error handling functions
  let currentErrorSlipId = null;

  function showPdfErrors(slipId) {
    currentErrorSlipId = slipId;
    const slip = allSlips.find(s => s.check_slip_id === slipId);
    if (!slip || !slip.pdf_errors || slip.pdf_errors.length === 0) {
      showToast('No PDF errors found', 'err');
      return;
    }

    const body = document.getElementById('errorModalBody');
    let html = '';
    slip.pdf_errors.forEach(err => {
      html += `
        <div class="error-item">
          <div class="error-property">${escapeHtml(err.property_name || 'Unknown Property')}</div>
          <div class="error-message">${escapeHtml(err.error || 'Unknown error')}</div>
        </div>
      `;
    });

    body.innerHTML = html;
    document.getElementById('errorModal').classList.add('show');
  }

  function closeErrorModal() {
    document.getElementById('errorModal').classList.remove('show');
    currentErrorSlipId = null;
  }

  async function regenerateSelectedPdf() {
    if (!currentErrorSlipId) return;

    closeErrorModal();
    showToast('Regenerating PDF...', 'ok');

    try {
      // Trigger PDF regeneration by fetching the PDF endpoint
      const resp = await fetch(`/api/print-checks/slip/${currentErrorSlipId}/pdf`);
      if (!resp.ok) throw new Error('Failed to regenerate PDF');

      // Check for new errors
      const statusResp = await fetch(`/api/print-checks/slip/${currentErrorSlipId}/pdf-status`);
      if (statusResp.ok) {
        const status = await statusResp.json();
        if (status.pdf_errors && status.pdf_errors.length > 0) {
          showToast(`PDF regenerated with ${status.pdf_errors.length} error(s)`, 'err');
          // Reload slips to update error badges
          await loadSlips();
        } else {
          showToast('PDF regenerated successfully!', 'ok');
          await loadSlips();
        }
      } else {
        showToast('PDF regenerated', 'ok');
        await loadSlips();
      }
    } catch (e) {
      showToast('Error regenerating PDF: ' + e.message, 'err');
    }
  }
</script>

</body>
</html>
