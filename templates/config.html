<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CONFIG · Accounts To Track</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
  <style>
    :root { --bg:#0ea5e9; --bg2:#4338ca; --glass:rgba(255,255,255,.72); --border:rgba(255,255,255,.33); }
    body{font-family:Inter,system-ui,sans-serif;margin:0;background:linear-gradient(135deg,var(--bg),var(--bg2));min-height:100vh;color:#0f172a}
    header.top{position:sticky;top:0;display:flex;justify-content:space-between;align-items:center;padding:14px 20px;color:#fff;z-index:100}
    .btn{display:inline-block;padding:8px 16px;border-radius:10px;border:none;background:#0ea5e9;color:#fff;cursor:pointer;text-decoration:none;font-size:14px}
    .btn.secondary{background:#64748b}
    .btn.small{padding:4px 8px;font-size:12px}
    .btn.danger{background:#ef4444}
    .wrap{max-width:1800px;margin:40px auto;padding:0 20px}
    .card{background:var(--glass);backdrop-filter:blur(10px);border:1px solid var(--border);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.12);padding:20px}
    h1{margin:0 0 12px 0}
    h2{margin:20px 0 12px 0}
    .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    .upload-section{display:grid;grid-template-columns:1fr 400px;gap:20px;margin:16px 0}
    .upload-box{border:2px dashed #cbd5e1;border-radius:12px;padding:24px;background:#fff;text-align:center}
    .upload-box input[type=file]{display:none}
    .upload-label{display:inline-block;padding:12px 24px;background:#0ea5e9;color:#fff;border-radius:8px;cursor:pointer;margin-top:12px}
    .upload-label:hover{background:#0284c7}
    .tips{background:#fff;border-radius:12px;padding:16px}
    .tips ul{margin:8px 0;padding-left:20px}
    .tips li{margin:4px 0;font-size:13px;color:#64748b}
    table{width:100%;border-collapse:collapse;background:#fff;border-radius:12px;overflow:hidden}
    th,td{padding:12px;border-bottom:1px solid #e5e7eb;text-align:left;font-size:13px}
    th{background:#f8fafc;font-weight:600;cursor:pointer;position:sticky;top:0;z-index:10}
    tr:hover{background:rgba(14,165,233,0.05)}
    .filters input{width:100%;padding:6px;border:1px solid #e5e7eb;border-radius:6px;font-size:12px}
    .tableWrap{overflow:auto;max-height:600px;border-radius:12px;border:1px solid #e5e7eb;margin:16px 0}
    .row-actions{display:flex;gap:4px}
    .toast-wrap{position:fixed;top:16px;right:16px;z-index:9999;display:flex;flex-direction:column;gap:8px}
    .toast{min-width:260px;background:#111827;color:#fff;padding:12px 16px;border-radius:10px;box-shadow:0 8px 20px rgba(0,0,0,.25);opacity:.96}
    .toast.ok{background:#0f766e}
    .toast.err{background:#b91c1c}
    .modal-overlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);z-index:10000;align-items:center;justify-content:center}
    .modal-overlay.show{display:flex}
    .modal-box{background:#fff;border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.3);max-width:600px;width:90%;max-height:90vh;overflow-y:auto;padding:24px}
    .modal-box h2{margin:0 0 20px 0;font-size:20px}
    .form-group{margin-bottom:16px}
    .form-group label{display:block;margin-bottom:6px;font-weight:600;font-size:13px;color:#475569}
    .form-group input,.form-group select{width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:8px;font-size:14px;font-family:inherit}
    .form-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:24px;padding-top:16px;border-top:1px solid #e5e7eb}
    .badge{display:inline-block;padding:2px 8px;border-radius:6px;font-size:11px;font-weight:600}
    .badge.duplicate{background:#fef3c7;color:#92400e}
    .badge.new{background:#d1fae5;color:#065f46}
    .badge.error{background:#fee2e2;color:#991b1b}
    .import-results{margin-top:16px;padding:16px;background:#fff;border-radius:12px;border:1px solid #e5e7eb}
    .import-results h3{margin:0 0 12px 0;font-size:16px}
    .import-results ul{margin:0;padding-left:20px}
    .import-results li{margin:6px 0;font-size:13px}
  </style>
</head>
<body>
  <header class="top">
    <div><a href="/" style="color:#fff;text-decoration:none;font-weight:600">Bill Review @ JRK · CONFIG</a></div>
    <div style="display:flex;gap:8px">
      <a class="btn secondary" href="/portfolio-config">Portfolio Manager</a>
      <button id="submitBtn" class="btn" title="Save Accounts To Track">Save All</button>
      <a class="btn secondary" href="/">Back</a>
    </div>
  </header>

  <div id="toastWrap" class="toast-wrap"></div>

  <div class="wrap">
    <div class="card">
      <div class="topbar">
        <h1>CONFIG · Accounts To Track</h1>
      </div>

      <h2>CSV Import</h2>
      <div class="upload-section">
        <div class="upload-box">
          <div style="font-size:14px;color:#64748b;margin-bottom:8px">Upload CSV file with columns:</div>
          <div style="font-size:12px;color:#94a3b8;margin-bottom:4px">
            <strong>Vendor ID | Vendor Name | Account Number | Property ID | Property Name | GL Account Number | GL Account Name | Days Between Bills</strong>
          </div>
          <div style="font-size:11px;color:#cbd5e1;margin-bottom:12px">First row will be treated as headers and skipped</div>
          <input type="file" id="csvFile" accept=".csv" />
          <label for="csvFile" class="upload-label">Choose CSV File</label>
          <div id="fileName" style="margin-top:12px;font-size:13px;color:#475569"></div>
          <button class="btn" id="importBtn" style="margin-top:12px;display:none">Import CSV</button>
        </div>
        <div class="tips">
          <div style="font-weight:600;margin-bottom:8px">Tips</div>
          <ul>
            <li>CSV will be validated before import</li>
            <li>Duplicates (same Vendor + Account + Property + GL) are gracefully rejected</li>
            <li>Vendor/Property/GL names are matched to IDs automatically</li>
            <li>Invalid rows are skipped with error messages</li>
            <li>Click headers to sort, use filters to search</li>
          </ul>
        </div>
      </div>

      <div id="importResults" class="import-results" style="display:none"></div>

      <div style="display:flex;justify-content:space-between;align-items:center;margin:20px 0 12px 0">
        <h2 style="margin:0">Current Accounts ({state.items.length})</h2>
        <button class="btn" id="addRowBtn">+ Add New Account</button>
      </div>

      <div class="tableWrap">
        <table id="cfgTable">
          <thead>
            <tr>
              <th data-col="vendorId" style="width:8%">Vendor ID</th>
              <th data-col="vendorName" style="width:18%">Vendor Name</th>
              <th data-col="accountNumber" style="width:12%">Account Number</th>
              <th data-col="propertyId" style="width:8%">Property ID</th>
              <th data-col="propertyName" style="width:18%">Property Name</th>
              <th data-col="glAccountNumber" style="width:10%">GL Number</th>
              <th data-col="glAccountName" style="width:14%">GL Name</th>
              <th data-col="daysBetweenBills" style="width:7%">Days</th>
              <th style="width:10%">Actions</th>
            </tr>
            <tr class="filters">
              <th><input placeholder="Filter..."></th>
              <th><input placeholder="Filter..."></th>
              <th><input placeholder="Filter..."></th>
              <th><input placeholder="Filter..."></th>
              <th><input placeholder="Filter..."></th>
              <th><input placeholder="Filter..."></th>
              <th><input placeholder="Filter..."></th>
              <th><input placeholder="Filter..."></th>
              <th></th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Add/Edit Modal -->
  <div id="editModal" class="modal-overlay">
    <div class="modal-box">
      <h2 id="modalTitle">Add Account</h2>
      <form id="editForm" onsubmit="return false">
        <div class="form-group">
          <label>Vendor *</label>
          <select id="editVendor" required></select>
        </div>
        <div class="form-group">
          <label>Account Number *</label>
          <input type="text" id="editAccount" required />
        </div>
        <div class="form-group">
          <label>Property *</label>
          <select id="editProperty" required></select>
        </div>
        <div class="form-group">
          <label>GL Account *</label>
          <select id="editGlNumber" required></select>
        </div>
        <div class="form-group">
          <label>Days Between Bills *</label>
          <input type="number" id="editDays" min="1" max="365" required />
        </div>
        <div class="form-actions">
          <button type="button" class="btn secondary" onclick="closeEditModal()">Cancel</button>
          <button type="submit" class="btn" onclick="saveEdit()">Save</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const state = {
      vendors: [],
      properties: [],
      gls: [],
      items: [],
      sort: { col: '', dir: 1 },
      filters: ['', '', '', '', '', '', '', ''],
      editingIndex: -1, // -1 = new row, >= 0 = editing existing
      vendorChoice: null,
      propertyChoice: null,
      glChoice: null
    };

    let csvData = null;

    async function fetchJSON(url){
      const r = await fetch(url, {credentials:'same-origin'});
      if(!r.ok) throw new Error('fetch failed');
      return r.json();
    }

    function showToast(message, type){
      const wrap = document.getElementById('toastWrap');
      const el = document.createElement('div');
      el.className = 'toast ' + (type==='ok'?'ok':'err');
      el.textContent = message;
      wrap.appendChild(el);
      setTimeout(()=>{ el.style.transition='opacity .3s'; el.style.opacity='0'; setTimeout(()=> wrap.removeChild(el), 300); }, 2500);
    }

    function debounce(fn, ms){ let t; return function(){ const ctx=this, args=arguments; clearTimeout(t); t=setTimeout(()=>fn.apply(ctx,args), ms); }; }

    async function loadAll(){
      const [vend, prop, gl, cfg] = await Promise.all([
        fetchJSON('/api/catalog/vendors'),
        fetchJSON('/api/catalog/properties'),
        fetchJSON('/api/catalog/gl-accounts'),
        fetchJSON('/api/config/accounts-to-track')
      ]);
      state.vendors = (vend.items||[]).sort((a,b)=> (a.name||'').localeCompare(b.name||''));
      state.properties = (prop.items||[]).sort((a,b)=> (a.name||'').localeCompare(b.name||''));
      state.gls = (gl.items||[]).sort((a,b)=> String(a.number||'').localeCompare(String(b.number||'')));
      state.items = (cfg.items||[]).map(x=>({...x, daysBetweenBills: x.daysBetweenBills??0}));
      render();
    }

    function render(){
      const tbody = document.getElementById('rows');
      tbody.innerHTML = '';

      let rows = [...state.items];
      const [fVendId,fVend,fAcct,fPropId,fProp,fGLN,fGLName,fDays] = state.filters.map(s=>s.toLowerCase());
      rows = rows.filter(r =>
        (!fVendId || String(r.vendorId||'').toLowerCase().includes(fVendId)) &&
        (!fVend || String(r.vendorName||'').toLowerCase().includes(fVend)) &&
        (!fAcct || String(r.accountNumber||'').toLowerCase().includes(fAcct)) &&
        (!fPropId || String(r.propertyId||'').toLowerCase().includes(fPropId)) &&
        (!fProp || String(r.propertyName||'').toLowerCase().includes(fProp)) &&
        (!fGLN || String(r.glAccountNumber||'').toLowerCase().includes(fGLN)) &&
        (!fGLName || String(r.glAccountName||'').toLowerCase().includes(fGLName)) &&
        (!fDays || String(r.daysBetweenBills||'').toLowerCase().includes(fDays))
      );

      if(state.sort.col){
        rows.sort((a,b)=>{
          const av = String(a[state.sort.col]??'').toLowerCase();
          const bv = String(b[state.sort.col]??'').toLowerCase();
          if(av < bv) return -1*state.sort.dir;
          if(av > bv) return 1*state.sort.dir;
          return 0;
        });
      }

      rows.forEach((r,idx) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${r.vendorId||''}</td>
          <td>${r.vendorName||''}</td>
          <td>${r.accountNumber||''}</td>
          <td>${r.propertyId||''}</td>
          <td>${r.propertyName||''}</td>
          <td>${r.glAccountNumber||''}</td>
          <td>${r.glAccountName||''}</td>
          <td>${r.daysBetweenBills||0}</td>
          <td>
            <div class="row-actions">
              <button class="btn small" onclick="editRow(${state.items.indexOf(r)})">Edit</button>
              <button class="btn small" onclick="duplicateRow(${state.items.indexOf(r)})">Dup</button>
              <button class="btn small danger" onclick="deleteRow(${state.items.indexOf(r)})">Del</button>
            </div>
          </td>
        `;
        tbody.appendChild(tr);
      });

      // Update count
      document.querySelector('h2[style*="margin:0"]').textContent = `Current Accounts (${state.items.length})`;
    }

    function bindSorting(){
      document.querySelectorAll('#cfgTable thead tr:first-child th[data-col]').forEach(th => {
        th.addEventListener('click', ()=>{
          const col = th.getAttribute('data-col');
          if(state.sort.col===col){ state.sort.dir *= -1; } else { state.sort.col = col; state.sort.dir = 1; }
          render();
        });
      });
    }

    function bindFilters(){
      const debRender = debounce(()=>render(), 200);
      document.querySelectorAll('#cfgTable thead tr.filters th input').forEach((inp, idx)=>{
        inp.addEventListener('input', ()=>{ state.filters[idx] = inp.value; debRender(); });
      });
    }

    // CSV Upload
    document.getElementById('csvFile').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if(!file) return;
      document.getElementById('fileName').textContent = file.name;
      document.getElementById('importBtn').style.display = 'inline-block';

      const reader = new FileReader();
      reader.onload = (ev) => {
        csvData = ev.target.result;
      };
      reader.readAsText(file);
    });

    document.getElementById('importBtn').addEventListener('click', () => {
      if(!csvData) {
        showToast('No CSV data loaded', 'err');
        return;
      }
      importCSV(csvData);
    });

    function importCSV(csvText) {
      const lines = csvText.trim().split(/\r?\n/);
      if(lines.length < 2) {
        showToast('CSV must have at least a header row and one data row', 'err');
        return;
      }

      // Skip first row (headers)
      const dataRows = lines.slice(1);

      const results = {
        added: [],
        duplicates: [],
        errors: []
      };

      dataRows.forEach((line, idx) => {
        const parts = line.split(',').map(p => p.trim().replace(/^"|"$/g, ''));
        if(parts.length < 8) {
          results.errors.push(`Row ${idx+2}: Not enough columns (expected 8, got ${parts.length})`);
          return;
        }

        const [vendorId, vendorName, accountNumber, propertyId, propertyName, glAccountNumber, glAccountName, daysBetweenBills] = parts;

        // Check for duplicate (same vendor + account + property + GL)
        const isDup = state.items.some(item =>
          String(item.vendorId||'').trim() === vendorId &&
          String(item.accountNumber||'').trim() === accountNumber &&
          String(item.propertyId||'').trim() === propertyId &&
          String(item.glAccountNumber||'').trim() === glAccountNumber
        );

        if(isDup) {
          results.duplicates.push(`Row ${idx+2}: ${vendorName} | ${accountNumber} | ${propertyName} | ${glAccountNumber}`);
          return;
        }

        // Add new item
        const newItem = {
          vendorId,
          vendorName,
          accountNumber,
          propertyId,
          propertyName,
          glAccountNumber,
          glAccountName,
          daysBetweenBills: parseInt(daysBetweenBills||'0') || 0
        };

        state.items.push(newItem);
        results.added.push(`${vendorName} | ${accountNumber} | ${propertyName} | ${glAccountNumber}`);
      });

      // Show results
      const resultsDiv = document.getElementById('importResults');
      resultsDiv.style.display = 'block';
      resultsDiv.innerHTML = `
        <h3>Import Results</h3>
        ${results.added.length > 0 ? `<div style="margin-bottom:12px"><span class="badge new">${results.added.length} ADDED</span></div>` : ''}
        ${results.duplicates.length > 0 ? `<div style="margin-bottom:12px"><span class="badge duplicate">${results.duplicates.length} DUPLICATES SKIPPED</span></div>` : ''}
        ${results.errors.length > 0 ? `<div style="margin-bottom:12px"><span class="badge error">${results.errors.length} ERRORS</span></div>` : ''}
        ${results.added.length > 0 ? `<details><summary style="cursor:pointer;font-weight:600">Added (${results.added.length})</summary><ul>${results.added.map(r=>`<li>${r}</li>`).join('')}</ul></details>` : ''}
        ${results.duplicates.length > 0 ? `<details><summary style="cursor:pointer;font-weight:600">Duplicates (${results.duplicates.length})</summary><ul>${results.duplicates.map(r=>`<li>${r}</li>`).join('')}</ul></details>` : ''}
        ${results.errors.length > 0 ? `<details><summary style="cursor:pointer;font-weight:600">Errors (${results.errors.length})</summary><ul>${results.errors.map(r=>`<li>${r}</li>`).join('')}</ul></details>` : ''}
      `;

      render();
      showToast(`Import complete: ${results.added.length} added, ${results.duplicates.length} duplicates skipped`, 'ok');

      // Reset file input
      document.getElementById('csvFile').value = '';
      document.getElementById('fileName').textContent = '';
      document.getElementById('importBtn').style.display = 'none';
      csvData = null;
    }

    // Modal for Add/Edit
    function openEditModal(index = -1) {
      state.editingIndex = index;
      const modal = document.getElementById('editModal');
      const isNew = index === -1;

      document.getElementById('modalTitle').textContent = isNew ? 'Add New Account' : 'Edit Account';

      // Populate dropdowns
      const vendorSel = document.getElementById('editVendor');
      const propertySel = document.getElementById('editProperty');
      const glSel = document.getElementById('editGlNumber');

      vendorSel.innerHTML = '<option value="">-- Select Vendor --</option>' +
        state.vendors.map(v => `<option value="${v.id}">${v.name}</option>`).join('');
      propertySel.innerHTML = '<option value="">-- Select Property --</option>' +
        state.properties.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
      glSel.innerHTML = '<option value="">-- Select GL Account --</option>' +
        state.gls.map(g => `<option value="${g.number}">${g.formatted} - ${g.name}</option>`).join('');

      // Initialize Choices.js (only once, in modal)
      if(state.vendorChoice) state.vendorChoice.destroy();
      if(state.propertyChoice) state.propertyChoice.destroy();
      if(state.glChoice) state.glChoice.destroy();

      state.vendorChoice = new Choices(vendorSel, { searchEnabled: true, shouldSort: false });
      state.propertyChoice = new Choices(propertySel, { searchEnabled: true, shouldSort: false });
      state.glChoice = new Choices(glSel, { searchEnabled: true, shouldSort: false });

      // If editing, populate fields
      if(!isNew) {
        const item = state.items[index];
        vendorSel.value = item.vendorId || '';
        document.getElementById('editAccount').value = item.accountNumber || '';
        propertySel.value = item.propertyId || '';
        glSel.value = item.glAccountNumber || '';
        document.getElementById('editDays').value = item.daysBetweenBills || 0;

        // Update Choices selections
        state.vendorChoice.setChoiceByValue(item.vendorId || '');
        state.propertyChoice.setChoiceByValue(item.propertyId || '');
        state.glChoice.setChoiceByValue(item.glAccountNumber || '');
      } else {
        document.getElementById('editAccount').value = '';
        document.getElementById('editDays').value = '30';
      }

      modal.classList.add('show');
    }

    function closeEditModal() {
      document.getElementById('editModal').classList.remove('show');
    }

    function saveEdit() {
      const vendorId = document.getElementById('editVendor').value;
      const accountNumber = document.getElementById('editAccount').value.trim();
      const propertyId = document.getElementById('editProperty').value;
      const glAccountNumber = document.getElementById('editGlNumber').value;
      const daysBetweenBills = parseInt(document.getElementById('editDays').value) || 0;

      if(!vendorId || !accountNumber || !propertyId || !glAccountNumber) {
        showToast('Please fill all required fields', 'err');
        return;
      }

      const vendor = state.vendors.find(v => String(v.id) === vendorId);
      const property = state.properties.find(p => String(p.id) === propertyId);
      const gl = state.gls.find(g => String(g.number) === glAccountNumber);

      const item = {
        vendorId,
        vendorName: vendor ? vendor.name : '',
        accountNumber,
        propertyId,
        propertyName: property ? property.name : '',
        glAccountNumber,
        glAccountName: gl ? gl.name : '',
        daysBetweenBills
      };

      if(state.editingIndex === -1) {
        // Check for duplicate
        const isDup = state.items.some(existing =>
          String(existing.vendorId||'').trim() === vendorId &&
          String(existing.accountNumber||'').trim() === accountNumber &&
          String(existing.propertyId||'').trim() === propertyId &&
          String(existing.glAccountNumber||'').trim() === glAccountNumber
        );
        if(isDup) {
          showToast('Duplicate: This combination already exists', 'err');
          return;
        }
        state.items.push(item);
        showToast('Account added', 'ok');
      } else {
        state.items[state.editingIndex] = item;
        showToast('Account updated', 'ok');
      }

      closeEditModal();
      render();
    }

    function editRow(index) {
      openEditModal(index);
    }

    function duplicateRow(index) {
      const item = {...state.items[index]};
      state.items.push(item);
      render();
      showToast('Account duplicated', 'ok');
    }

    function deleteRow(index) {
      if(!confirm('Delete this account?')) return;
      state.items.splice(index, 1);
      render();
      showToast('Account deleted', 'ok');
    }

    document.getElementById('addRowBtn').addEventListener('click', () => openEditModal(-1));

    async function submitAll(){
      const payload = { items: state.items.map(r=>({
        vendorId: r.vendorId||'', vendorName: r.vendorName||'', accountNumber: r.accountNumber||'',
        propertyId: r.propertyId||'', propertyName: r.propertyName||'',
        glAccountNumber: r.glAccountNumber||'', glAccountName: r.glAccountName||'',
        daysBetweenBills: Number(r.daysBetweenBills||0)
      }))};

      const r = await fetch('/api/config/accounts-to-track', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        credentials:'same-origin',
        body: JSON.stringify(payload)
      });

      if(!r.ok){
        showToast('Save failed', 'err');
        return;
      }

      const j = await r.json();
      showToast(`Saved ${j.saved||0} items`, 'ok');
    }

    document.getElementById('submitBtn').addEventListener('click', submitAll);

    bindSorting();
    bindFilters();
    loadAll().catch(()=> alert('Failed to load'));
  </script>
</body>
</html>
