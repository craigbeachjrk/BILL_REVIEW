<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Account Gap Analysis Â· Admin</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root { --bg:#0ea5e9; --bg2:#4338ca; --glass:rgba(255,255,255,.72); --border:rgba(255,255,255,.33); }
    body{font-family:Inter,system-ui,sans-serif;margin:0;background:linear-gradient(135deg,var(--bg),var(--bg2));min-height:100vh;color:#0f172a}
    header.top{position:sticky;top:0;display:flex;justify-content:space-between;align-items:center;padding:14px 20px;color:#fff;z-index:100}
    .btn{display:inline-block;padding:8px 12px;border-radius:10px;border:none;background:#0ea5e9;color:#fff;cursor:pointer;text-decoration:none;font-size:13px}
    .btn.secondary{background:#64748b}
    .btn.success{background:#10b981}
    .btn.danger{background:#dc2626}
    .btn.small{padding:4px 8px;font-size:11px}
    .btn:disabled{opacity:0.5;cursor:not-allowed}
    .wrap{max-width:1400px;margin:40px auto;padding:0 20px}
    h1{margin:0 0 16px 0;color:#fff}
    .card{background:var(--glass);backdrop-filter:blur(10px);border:1px solid var(--border);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.12);padding:20px;margin-bottom:20px}
    .card h2{margin:0 0 16px 0;font-size:18px}
    .summary-row{display:flex;gap:12px;margin-bottom:20px;flex-wrap:wrap}
    .stat-box{background:#f8fafc;padding:16px;border-radius:8px;text-align:center;flex:1;min-width:120px}
    .stat-box .value{font-size:24px;font-weight:700;color:#0ea5e9}
    .stat-box .label{font-size:11px;color:#64748b;margin-top:4px}
    .stat-box.success .value{color:#22c55e}
    .stat-box.warning .value{color:#f59e0b}
    .stat-box.danger .value{color:#dc2626}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px 10px;border-bottom:1px solid #e5e7eb;text-align:left;font-size:12px}
    th{background:#f8fafc;font-weight:600;position:sticky;top:0;z-index:10}
    tr:hover{background:rgba(14,165,233,0.05)}
    .badge{display:inline-block;padding:3px 6px;border-radius:4px;font-size:10px;font-weight:600}
    .badge.exact{background:#dcfce7;color:#166534}
    .badge.diff{background:#fef3c7;color:#92400e}
    .badge.fuzzy{background:#dbeafe;color:#1e40af}
    .badge.missing{background:#fee2e2;color:#991b1b}
    .badge.orphan{background:#e5e7eb;color:#374151}
    .toast{position:fixed;top:20px;right:20px;background:#111827;color:#fff;padding:12px 16px;border-radius:10px;z-index:60;opacity:0;transition:opacity .3s}
    .toast.show{opacity:.96}
    .toast.ok{background:#0f766e}
    .toast.err{background:#b91c1c}
    .loading{text-align:center;padding:40px;color:#64748b}
    .spinner{display:inline-block;width:18px;height:18px;border:2px solid #e5e7eb;border-top:2px solid #0ea5e9;border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
    .tabs{display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap}
    .tab{padding:8px 16px;border-radius:8px;cursor:pointer;background:#f1f5f9;font-weight:600;font-size:12px}
    .tab.active{background:#0ea5e9;color:#fff}
    .tab-content{display:none}
    .tab-content.active{display:block}
    .upload-area{border:2px dashed #cbd5e1;border-radius:12px;padding:40px;text-align:center;cursor:pointer;transition:all .2s}
    .upload-area:hover{border-color:#0ea5e9;background:rgba(14,165,233,0.05)}
    .upload-area.dragover{border-color:#0ea5e9;background:rgba(14,165,233,0.1)}
    input[type="file"]{display:none}
    .steps{display:flex;gap:20px;margin-bottom:20px}
    .step{flex:1;background:#f8fafc;padding:16px;border-radius:8px;border-left:4px solid #e5e7eb}
    .step.active{border-left-color:#0ea5e9}
    .step.done{border-left-color:#22c55e}
    .step-num{font-size:24px;font-weight:700;color:#cbd5e1}
    .step.active .step-num{color:#0ea5e9}
    .step.done .step-num{color:#22c55e}
    .step-title{font-weight:600;margin-top:8px}
    .step-desc{font-size:12px;color:#64748b;margin-top:4px}
  </style>
</head>
<body>
  <header class="top">
    <div><a href="/" style="text-decoration:none;color:#fff;font-weight:600">Bill Review @ JRK</a> &gt; <a href="/workflow" style="color:#fff">WORKFLOW</a> &gt; Account Gap Analysis</div>
    <div>
      <span style="margin-right:12px">Admin: {{ user }}</span>
      <a class="btn secondary" href="/workflow">Back to WORKFLOW</a>
    </div>
  </header>

  <div id="toast" class="toast"></div>

  <div class="wrap">
    <h1>Account Gap Analysis</h1>

    <div class="card" style="background:#dbeafe;border-color:#3b82f6">
      <p style="margin:0;color:#1e40af;font-size:13px">
        <strong>Purpose:</strong> Compare an external account list against tracked accounts to find missing accounts and orphaned entries.
        Upload a CSV or JSON file with property, vendor, and account information.
      </p>
    </div>

    <div class="steps">
      <div class="step active" id="step1">
        <div class="step-num">1</div>
        <div class="step-title">Upload File</div>
        <div class="step-desc">CSV or JSON with accounts</div>
      </div>
      <div class="step" id="step2">
        <div class="step-num">2</div>
        <div class="step-title">Run Analysis</div>
        <div class="step-desc">Compare with tracked accounts</div>
      </div>
      <div class="step" id="step3">
        <div class="step-num">3</div>
        <div class="step-title">Review Results</div>
        <div class="step-desc">Add missing accounts</div>
      </div>
    </div>

    <!-- Upload Card -->
    <div class="card" id="uploadCard">
      <h2>Step 1: Upload Account List</h2>
      <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
        <input type="file" id="fileInput" accept=".csv,.json" onchange="handleFileSelect(event)">
        <div style="font-size:40px;color:#cbd5e1;margin-bottom:16px">+</div>
        <div style="font-size:14px;color:#64748b">Drop a CSV or JSON file here, or click to browse</div>
        <div style="font-size:12px;color:#94a3b8;margin-top:8px">
          Required columns: propertyId/property, vendorId/vendor, accountNumber/account
        </div>
      </div>
      <div id="uploadResult" style="margin-top:16px;display:none">
        <div style="background:#dcfce7;padding:12px;border-radius:8px;color:#166534">
          <strong id="uploadedFileName"></strong> uploaded successfully
          <br><span id="uploadedCount"></span> accounts found
        </div>
        <div style="margin-top:12px">
          <button class="btn" onclick="runAnalysis()">Run Analysis</button>
        </div>
      </div>
    </div>

    <!-- Results Card -->
    <div class="card" id="resultsCard" style="display:none">
      <h2>Step 3: Analysis Results</h2>

      <div class="summary-row" id="resultStats">
        <div class="stat-box success">
          <div class="value" id="matchedExactCount">0</div>
          <div class="label">Matched Exact</div>
        </div>
        <div class="stat-box warning">
          <div class="value" id="vendorDiffCount">0</div>
          <div class="label">Vendor Differs</div>
        </div>
        <div class="stat-box">
          <div class="value" id="fuzzyCount">0</div>
          <div class="label">Fuzzy Match</div>
        </div>
        <div class="stat-box danger">
          <div class="value" id="notFoundCount">0</div>
          <div class="label">NOT FOUND</div>
        </div>
        <div class="stat-box">
          <div class="value" id="orphanedCount">0</div>
          <div class="label">Orphaned</div>
        </div>
      </div>

      <div class="tabs">
        <div class="tab active" onclick="switchResultTab('not_found')">Not Found (<span id="tabNotFound">0</span>)</div>
        <div class="tab" onclick="switchResultTab('matched_vendor_diff')">Vendor Diff (<span id="tabVendorDiff">0</span>)</div>
        <div class="tab" onclick="switchResultTab('matched_fuzzy')">Fuzzy (<span id="tabFuzzy">0</span>)</div>
        <div class="tab" onclick="switchResultTab('matched_exact')">Matched (<span id="tabMatched">0</span>)</div>
        <div class="tab" onclick="switchResultTab('orphaned')">Orphaned (<span id="tabOrphaned">0</span>)</div>
      </div>

      <div id="not_foundTab" class="tab-content active">
        <div style="margin-bottom:12px">
          <button class="btn success" onclick="addAllMissing()" id="addAllBtn">Add All Missing to Tracker</button>
        </div>
        <div style="max-height:400px;overflow-y:auto">
          <table>
            <thead>
              <tr>
                <th>Property</th>
                <th>Vendor</th>
                <th>Account #</th>
                <th>Notes</th>
              </tr>
            </thead>
            <tbody id="notFoundBody"></tbody>
          </table>
        </div>
      </div>

      <div id="matched_vendor_diffTab" class="tab-content">
        <div style="max-height:400px;overflow-y:auto">
          <table>
            <thead>
              <tr>
                <th>Property</th>
                <th>Account #</th>
                <th>Uploaded Vendor</th>
                <th>Tracked Vendor</th>
              </tr>
            </thead>
            <tbody id="vendorDiffBody"></tbody>
          </table>
        </div>
      </div>

      <div id="matched_fuzzyTab" class="tab-content">
        <div style="max-height:400px;overflow-y:auto">
          <table>
            <thead>
              <tr>
                <th>Uploaded Account</th>
                <th>Possible Matches</th>
                <th>Notes</th>
              </tr>
            </thead>
            <tbody id="fuzzyBody"></tbody>
          </table>
        </div>
      </div>

      <div id="matched_exactTab" class="tab-content">
        <div style="max-height:400px;overflow-y:auto">
          <table>
            <thead>
              <tr>
                <th>Property</th>
                <th>Vendor</th>
                <th>Account #</th>
              </tr>
            </thead>
            <tbody id="matchedBody"></tbody>
          </table>
        </div>
      </div>

      <div id="orphanedTab" class="tab-content">
        <p style="font-size:12px;color:#64748b;margin-bottom:12px">
          These accounts are in the tracker but were NOT in your uploaded list.
        </p>
        <div style="max-height:400px;overflow-y:auto">
          <table>
            <thead>
              <tr>
                <th>Property</th>
                <th>Vendor</th>
                <th>Account #</th>
              </tr>
            </thead>
            <tbody id="orphanedBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    let uploadId = null;
    let analysisResults = null;

    function showToast(msg, type) {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.className = 'toast ' + (type === 'ok' ? 'ok' : 'err');
      t.classList.add('show');
      setTimeout(() => t.classList.remove('show'), 3000);
    }

    // Drag and drop
    const uploadArea = document.getElementById('uploadArea');
    uploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadArea.classList.add('dragover');
    });
    uploadArea.addEventListener('dragleave', () => {
      uploadArea.classList.remove('dragover');
    });
    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadArea.classList.remove('dragover');
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        handleFile(files[0]);
      }
    });

    function handleFileSelect(event) {
      const file = event.target.files[0];
      if (file) handleFile(file);
    }

    async function handleFile(file) {
      const formData = new FormData();
      formData.append('file', file);

      try {
        const r = await fetch('/api/account-gap-analysis/upload', {
          method: 'POST',
          body: formData
        });

        if (!r.ok) {
          const err = await r.json();
          throw new Error(err.error || 'Upload failed');
        }

        const data = await r.json();
        uploadId = data.upload_id;

        document.getElementById('uploadedFileName').textContent = file.name;
        document.getElementById('uploadedCount').textContent = data.account_count;
        document.getElementById('uploadResult').style.display = 'block';

        document.getElementById('step1').classList.remove('active');
        document.getElementById('step1').classList.add('done');
        document.getElementById('step2').classList.add('active');

        showToast(`Uploaded ${data.account_count} accounts`, 'ok');

      } catch (e) {
        showToast('Error: ' + e.message, 'err');
      }
    }

    async function runAnalysis() {
      if (!uploadId) {
        showToast('Please upload a file first', 'err');
        return;
      }

      showToast('Running analysis...', 'ok');

      try {
        const formData = new FormData();
        formData.append('upload_id', uploadId);

        const r = await fetch('/api/account-gap-analysis/run', {
          method: 'POST',
          body: formData
        });

        if (!r.ok) {
          const err = await r.json();
          throw new Error(err.error || 'Analysis failed');
        }

        const data = await r.json();
        analysisResults = data.results;

        // Update stats
        document.getElementById('matchedExactCount').textContent = data.summary.matched_exact;
        document.getElementById('vendorDiffCount').textContent = data.summary.matched_vendor_diff;
        document.getElementById('fuzzyCount').textContent = data.summary.matched_fuzzy;
        document.getElementById('notFoundCount').textContent = data.summary.not_found;
        document.getElementById('orphanedCount').textContent = data.summary.orphaned;

        // Update tab counts
        document.getElementById('tabNotFound').textContent = data.summary.not_found;
        document.getElementById('tabVendorDiff').textContent = data.summary.matched_vendor_diff;
        document.getElementById('tabFuzzy').textContent = data.summary.matched_fuzzy;
        document.getElementById('tabMatched').textContent = data.summary.matched_exact;
        document.getElementById('tabOrphaned').textContent = data.summary.orphaned;

        // Render results
        renderResults();

        document.getElementById('step2').classList.remove('active');
        document.getElementById('step2').classList.add('done');
        document.getElementById('step3').classList.add('active');
        document.getElementById('resultsCard').style.display = 'block';

        showToast('Analysis complete', 'ok');

      } catch (e) {
        showToast('Error: ' + e.message, 'err');
      }
    }

    function renderResults() {
      // Not Found
      const notFoundBody = document.getElementById('notFoundBody');
      notFoundBody.innerHTML = (analysisResults.not_found || []).map(r => `
        <tr>
          <td>${escapeHtml(r.uploaded?.property_name || r.uploaded?.property_id || '')}</td>
          <td>${escapeHtml(r.uploaded?.vendor_name || r.uploaded?.vendor_id || '')}</td>
          <td style="font-family:monospace">${escapeHtml(r.uploaded?.account_number || '')}</td>
          <td><span class="badge missing">NOT TRACKED</span></td>
        </tr>
      `).join('') || '<tr><td colspan="4" class="loading">None</td></tr>';

      // Vendor Diff
      const vendorDiffBody = document.getElementById('vendorDiffBody');
      vendorDiffBody.innerHTML = (analysisResults.matched_vendor_diff || []).map(r => `
        <tr>
          <td>${escapeHtml(r.uploaded?.property_name || '')}</td>
          <td style="font-family:monospace">${escapeHtml(r.uploaded?.account_number || '')}</td>
          <td>${escapeHtml(r.uploaded?.vendor_name || '')}</td>
          <td>${escapeHtml(r.tracked?.vendorName || '')}</td>
        </tr>
      `).join('') || '<tr><td colspan="4" class="loading">None</td></tr>';

      // Fuzzy
      const fuzzyBody = document.getElementById('fuzzyBody');
      fuzzyBody.innerHTML = (analysisResults.matched_fuzzy || []).map(r => {
        const matches = (r.possible_matches || []).map(m =>
          `${m.propertyName} / ${m.vendorName} / ${m.accountNumber}`
        ).join('<br>');
        return `
          <tr>
            <td>${escapeHtml(r.uploaded?.property_name || '')} / ${escapeHtml(r.uploaded?.vendor_name || '')} / ${escapeHtml(r.uploaded?.account_number || '')}</td>
            <td style="font-size:11px">${matches}</td>
            <td>${escapeHtml(r.notes || '')}</td>
          </tr>
        `;
      }).join('') || '<tr><td colspan="3" class="loading">None</td></tr>';

      // Matched
      const matchedBody = document.getElementById('matchedBody');
      matchedBody.innerHTML = (analysisResults.matched_exact || []).map(r => `
        <tr>
          <td>${escapeHtml(r.tracked?.propertyName || '')}</td>
          <td>${escapeHtml(r.tracked?.vendorName || '')}</td>
          <td style="font-family:monospace">${escapeHtml(r.tracked?.accountNumber || '')}</td>
        </tr>
      `).join('') || '<tr><td colspan="3" class="loading">None</td></tr>';

      // Orphaned
      const orphanedBody = document.getElementById('orphanedBody');
      orphanedBody.innerHTML = (analysisResults.orphaned || []).map(r => `
        <tr>
          <td>${escapeHtml(r.tracked?.propertyName || '')}</td>
          <td>${escapeHtml(r.tracked?.vendorName || '')}</td>
          <td style="font-family:monospace">${escapeHtml(r.tracked?.accountNumber || '')}</td>
        </tr>
      `).join('') || '<tr><td colspan="3" class="loading">None</td></tr>';
    }

    function switchResultTab(tab) {
      document.querySelectorAll('.tabs .tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
      document.querySelector(`.tab[onclick*="${tab}"]`).classList.add('active');
      document.getElementById(tab + 'Tab').classList.add('active');
    }

    async function addAllMissing() {
      const missing = analysisResults?.not_found || [];
      if (missing.length === 0) {
        showToast('No missing accounts to add', 'err');
        return;
      }

      if (!confirm(`Add ${missing.length} accounts to the tracker?`)) return;

      try {
        const accounts = missing.map(r => r.uploaded);

        const r = await fetch('/api/account-gap-analysis/add-missing', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({accounts})
        });

        if (!r.ok) {
          const err = await r.json();
          throw new Error(err.error || 'Failed to add');
        }

        const data = await r.json();
        showToast(`Added ${data.added} accounts to tracker`, 'ok');

        // Update UI
        document.getElementById('notFoundCount').textContent = '0';
        document.getElementById('tabNotFound').textContent = '0';
        document.getElementById('notFoundBody').innerHTML = '<tr><td colspan="4" class="loading">All accounts added!</td></tr>';
        document.getElementById('addAllBtn').disabled = true;

      } catch (e) {
        showToast('Error: ' + e.message, 'err');
      }
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text || '';
      return div.innerHTML;
    }
  </script>
</body>
</html>
