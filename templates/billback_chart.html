<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Invoices by Property · Bill Review</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root { --bg:#0ea5e9; --bg2:#4338ca; --glass:rgba(255,255,255,.72); --border:rgba(255,255,255,.33); }
    body{font-family:Inter,system-ui,sans-serif;margin:0;background:linear-gradient(135deg,var(--bg),var(--bg2));min-height:100vh;color:#0f172a}
    header.top{position:sticky;top:0;display:flex;justify-content:space-between;align-items:center;padding:14px 20px;color:#fff;z-index:10}
    .logout{display:flex;gap:8px;align-items:center}
    .logout form{display:inline}
    .btn{display:inline-block;padding:8px 12px;border-radius:10px;border:none;background:#0ea5e9;color:#fff;cursor:pointer;text-decoration:none;font-size:14px}
    .btn.secondary{background:#64748b}
    .wrap{max-width:1400px;margin:40px auto;padding:0 40px}
    h1{margin:0 0 20px 0}
    .card{background:var(--glass);backdrop-filter:blur(10px);border:1px solid var(--border);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.12);padding:32px;margin-bottom:20px}
    .loading{text-align:center;padding:60px;color:#64748b;font-size:16px}
    .spinner{display:inline-block;width:24px;height:24px;border:3px solid #e5e7eb;border-top:3px solid #0ea5e9;border-radius:50%;animation:spin 1s linear infinite;margin-right:12px;vertical-align:middle}
    @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
    .summary{display:flex;gap:24px;margin-bottom:24px}
    .summary-item{padding:16px 20px;background:#fff;border-radius:12px;flex:1;box-shadow:0 2px 8px rgba(0,0,0,0.06)}
    .summary-label{font-size:12px;color:#64748b;margin-bottom:4px;text-transform:uppercase;letter-spacing:0.5px}
    .summary-value{font-size:28px;font-weight:600;color:#0f172a}
    .chart-container{background:#fff;border-radius:12px;padding:24px;max-height:70vh;overflow-y:auto}
    .bar-row{display:flex;align-items:center;margin-bottom:8px;gap:12px}
    .bar-label{width:280px;min-width:280px;font-size:13px;color:#374151;text-align:right;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .bar-wrapper{flex:1;height:28px;background:#f1f5f9;border-radius:6px;overflow:hidden;position:relative}
    .bar{height:100%;background:linear-gradient(90deg,#0ea5e9,#8b5cf6);border-radius:6px;transition:width 0.5s ease-out;display:flex;align-items:center;justify-content:flex-end;padding-right:8px;min-width:fit-content}
    .bar-value{font-size:12px;font-weight:600;color:#fff;text-shadow:0 1px 2px rgba(0,0,0,0.2)}
    .bar-count{width:60px;min-width:60px;font-size:14px;font-weight:600;color:#0f172a;text-align:right}
    .error{background:#fee2e2;color:#991b1b;padding:16px;border-radius:8px;text-align:center}
  </style>
</head>
<body>
  <header class="top">
    <div><a href="/" style="color:#fff;text-decoration:none;font-weight:600">Bill Review @ JRK · Invoices by Property</a></div>
    <div class="logout">
      <a class="btn secondary" href="/billback">Back to BILLBACK</a>
      <a class="btn secondary" href="/">Home</a>
      <form method="post" action="/logout"><button class="btn" type="submit">Logout</button></form>
    </div>
  </header>

  <div class="wrap">
    <h1 style="color:#fff">Unassigned Invoices by Property</h1>

    <div class="card">
      <div class="summary" id="summarySection" style="display:none">
        <div class="summary-item">
          <div class="summary-label">Total Properties</div>
          <div class="summary-value" id="totalProperties">0</div>
        </div>
        <div class="summary-item">
          <div class="summary-label">Total Invoices</div>
          <div class="summary-value" id="totalInvoices">0</div>
        </div>
        <div class="summary-item">
          <div class="summary-label">Processing Time</div>
          <div class="summary-value" id="processingTime">-</div>
        </div>
      </div>

      <div id="loadingState" class="loading">
        <span class="spinner"></span>Loading invoice statistics...
      </div>

      <div id="errorState" class="error" style="display:none"></div>

      <div id="chartContainer" class="chart-container" style="display:none"></div>
    </div>
  </div>

  <script>
    async function loadStats() {
      const loadingEl = document.getElementById('loadingState');
      const errorEl = document.getElementById('errorState');
      const chartEl = document.getElementById('chartContainer');
      const summaryEl = document.getElementById('summarySection');

      try {
        const resp = await fetch('/api/ubi/stats/by_property');
        if (!resp.ok) {
          throw new Error(`HTTP ${resp.status}`);
        }
        const data = await resp.json();

        if (data.error) {
          throw new Error(data.error);
        }

        loadingEl.style.display = 'none';
        summaryEl.style.display = 'flex';
        chartEl.style.display = 'block';

        // Update summary
        document.getElementById('totalProperties').textContent = data.total_properties.toLocaleString();
        document.getElementById('totalInvoices').textContent = data.total_invoices.toLocaleString();
        document.getElementById('processingTime').textContent = data.processing_time_seconds + 's';

        // Render chart
        renderChart(data.stats);

      } catch (err) {
        loadingEl.style.display = 'none';
        errorEl.style.display = 'block';
        errorEl.textContent = 'Error loading statistics: ' + err.message;
      }
    }

    function renderChart(stats) {
      const container = document.getElementById('chartContainer');
      if (!stats || stats.length === 0) {
        container.innerHTML = '<div style="text-align:center;color:#64748b;padding:40px">No unassigned invoices found</div>';
        return;
      }

      const maxCount = Math.max(...stats.map(s => s.count));

      let html = '';
      stats.forEach((item, idx) => {
        const pct = (item.count / maxCount) * 100;
        html += `
          <div class="bar-row">
            <div class="bar-label" title="${item.property}">${item.property}</div>
            <div class="bar-wrapper">
              <div class="bar" style="width:${pct}%">
                <span class="bar-value">${item.count}</span>
              </div>
            </div>
            <div class="bar-count">${item.count}</div>
          </div>
        `;
      });

      container.innerHTML = html;

      // Animate bars
      setTimeout(() => {
        container.querySelectorAll('.bar').forEach((bar, i) => {
          bar.style.opacity = '0';
          bar.style.width = '0%';
          setTimeout(() => {
            bar.style.opacity = '1';
            bar.style.width = bar.getAttribute('style').match(/width:([^;]+)/)[1];
          }, i * 30);
        });
      }, 100);
    }

    // Load on page load
    loadStats();
  </script>
</body>
</html>
